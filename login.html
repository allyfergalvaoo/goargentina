<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Login | GoArgentina</title>
  <meta name="description" content="Acesse sua √°rea do cliente com link m√°gico." />

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root{
      --blue-900:#0A0E27;
      --blue-800:#0F1B3D;
      --blue-700:#17306A;
      --blue-600:#1F4ED1;
      --blue-500:#2A6BFF;
      --yellow-500:#FFD500;

      --text:#0D1220;
      --muted:#5B6475;

      --bg:#FFFFFF;
      --bg-soft:#F6F7FB;
      --sand:#F3E7C6;
      --sand-2:#F7F1DD;
      --line:rgba(13,18,32,.10);

      --radius:16px;
      --shadow: 0 18px 50px rgba(13,18,32,.10);
      --ring: rgba(42,107,255,.18);
    }

    body{
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Inter, Roboto, Arial, sans-serif;
      background:
        radial-gradient(900px 520px at 10% 10%, rgba(42,107,255,.12), transparent 55%),
        radial-gradient(820px 520px at 90% 15%, rgba(255,213,0,.10), transparent 55%),
        var(--bg-soft);
      color: var(--text);
      line-height: 1.6;
      min-height: 100vh;
    }

    a{ color: inherit; text-decoration: none; }

    .container{
      width: min(1120px, calc(100% - 40px));
      margin: 0 auto;
    }

    /* Header */
    header{
      position: sticky;
      top: 0;
      z-index: 100;
      background: rgba(255,255,255,.92);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--line);
    }
    .nav{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 16px;
      padding: 14px 0;
      flex-wrap: wrap;
    }
    .brand{
      display:flex;
      align-items:center;
      gap: 12px;
      font-weight: 900;
      letter-spacing: .2px;
    }
    .mark{
      width: 38px; height: 38px;
      border-radius: 12px;
      background: linear-gradient(135deg, var(--yellow-500), var(--blue-500));
      display:flex;
      align-items:center;
      justify-content:center;
      color: rgba(10,14,39,.92);
      font-weight: 950;
      box-shadow: 0 14px 30px rgba(13,18,32,.10);
      border: 1px solid rgba(13,18,32,.06);
    }
    .brand small{
      display:block;
      font-weight: 700;
      color: var(--muted);
      margin-top: -2px;
      font-size: 12px;
      letter-spacing: 0;
    }

    .actions{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap: 8px;
      padding: 12px 16px;
      border-radius: 999px;
      font-weight: 850;
      font-size: 14px;
      border: 1px solid var(--line);
      background: white;
      cursor: pointer;
      transition: all .15s ease;
      white-space: nowrap;
      user-select: none;
    }
    .btn:hover{
      transform: translateY(-1px);
      box-shadow: 0 10px 25px rgba(13,18,32,.08);
      border-color: rgba(23,48,106,.18);
    }
    .btn-primary{
      background: linear-gradient(135deg, var(--blue-500), var(--blue-700));
      color: white;
      border-color: rgba(255,255,255,.18);
      box-shadow: 0 16px 34px rgba(42,107,255,.18);
    }
    .btn-primary:hover{
      filter: brightness(1.02);
      box-shadow: 0 18px 40px rgba(42,107,255,.22);
    }
    .btn-ghost{ background: var(--bg-soft); }
    .btn:disabled{
      opacity: .65;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    main{ padding: 40px 0 64px; }
    .wrap{
      display:flex;
      align-items:center;
      justify-content:center;
      min-height: calc(100vh - 72px);
    }
    .card{
      width: 100%;
      max-width: 580px;
      background: rgba(255,255,255,.92);
      border: 1px solid var(--line);
      border-radius: calc(var(--radius) + 4px);
      box-shadow: var(--shadow);
      padding: 22px;
      overflow: hidden;
      position: relative;
    }
    .card::before{
      content:"";
      position:absolute;
      inset:-1px -1px auto -1px;
      height: 10px;
      background: linear-gradient(90deg, var(--yellow-500), var(--blue-500));
      opacity: .85;
    }

    .card-top{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 10px;
      margin-top: 6px;
    }
    .tag{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(255,213,0,.18);
      border: 1px solid rgba(255,213,0,.26);
      font-weight: 850;
      font-size: 13px;
      color: rgba(13,18,32,.86);
    }

    h1{
      font-size: clamp(22px, 3.2vw, 28px);
      line-height: 1.15;
      margin: 10px 0 8px;
      font-weight: 950;
      letter-spacing: -0.3px;
    }
    .lead{
      color: var(--muted);
      font-size: 14px;
      font-weight: 650;
      margin-bottom: 18px;
      max-width: 70ch;
    }

    form{
      display:flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 6px;
    }
    label{
      display:block;
      font-size: 13px;
      color: rgba(13,18,32,.72);
      font-weight: 850;
      margin-bottom: 6px;
    }
    input{
      width: 100%;
      padding: 12px 14px;
      border-radius: 12px;
      background: white;
      border: 1px solid var(--line);
      color: var(--text);
      font-size: 14px;
      outline: none;
      font-weight: 650;
    }
    input::placeholder{ color: rgba(13,18,32,.38); font-weight: 650; }
    input:focus{
      border-color: rgba(42,107,255,.35);
      box-shadow: 0 0 0 4px var(--ring);
    }

    .row{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 6px;
    }
    .row .btn{ width: 100%; }

    .msg{
      margin-top: 14px;
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: var(--bg-soft);
      color: rgba(13,18,32,.92);
      font-size: 13px;
      display:none;
      white-space: pre-line;
      font-weight: 650;
    }
    .msg[data-type="success"]{
      background: rgba(22,163,74,.08);
      border-color: rgba(22,163,74,.20);
    }
    .msg[data-type="warn"]{
      background: rgba(245,158,11,.10);
      border-color: rgba(245,158,11,.24);
    }
    .msg[data-type="error"]{
      background: rgba(220,38,38,.08);
      border-color: rgba(220,38,38,.18);
    }

    .hint{
      margin-top: 12px;
      color: rgba(13,18,32,.60);
      font-size: 12px;
      line-height: 1.5;
      font-weight: 650;
    }
    .hint b{ color: rgba(13,18,32,.82); }

    footer{
      padding: 22px 0;
      border-top: 1px solid var(--line);
      font-size: 13px;
      color: rgba(13,18,32,.6);
      background: rgba(255,255,255,.7);
    }
    footer a{ color: rgba(13,18,32,.75); font-weight: 850; }

    /* Loading overlay */
    .loading{
      position: fixed;
      inset: 0;
      display:flex;
      align-items:center;
      justify-content:center;
      background: rgba(246,247,251,.80);
      backdrop-filter: blur(10px);
      z-index: 200;
    }
    .loading.hidden{ display:none; }
    .loading-card{
      width: min(520px, 92vw);
      border-radius: 22px;
      border:1px solid rgba(13,18,32,.10);
      background: rgba(255,255,255,.92);
      box-shadow: 0 26px 60px rgba(13,18,32,.16);
      padding: 18px 18px;
      display:flex;
      gap: 14px;
      align-items:center;
    }
    .spinner{
      width: 26px;
      height: 26px;
      border-radius: 999px;
      border: 3px solid rgba(13,18,32,.10);
      border-top-color: rgba(42,107,255,.85);
      animation: spin 1s linear infinite;
      flex:0 0 auto;
    }
    @keyframes spin{ to{ transform: rotate(360deg); } }
    .loading-text{
      font-weight: 900;
      color: rgba(13,18,32,.86);
      letter-spacing:-0.15px;
    }

    @media (max-width: 520px){
      .container{ width: calc(100% - 28px); }
      .actions{ width: 100%; }
      .btn{ width: 100%; }
      .wrap{ min-height: calc(100vh - 92px); }
    }
  </style>
</head>

<body>
  <header>
    <div class="container">
      <div class="nav">
        <a class="brand" href="index.html" aria-label="GoArgentina">
          <div class="mark">GO</div>
          <div>
            GoArgentina
            <small>Orienta√ß√£o para DNI na Argentina</small>
          </div>
        </a>

        <div class="actions">
          <a class="btn btn-ghost" href="index.html">‚Üê Voltar</a>
          <a class="btn btn-primary" href="https://wa.me/5491159023706" target="_blank" rel="noopener">üí¨ WhatsApp</a>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="container wrap">
      <div class="card" role="region" aria-label="Login GoArgentina">
        <div class="card-top">
          <span class="tag">üîí √Årea do cliente</span>
        </div>

        <h1>Entrar com link m√°gico</h1>
        <p class="lead">
          Digite seu e-mail e vamos enviar um link de acesso. Sem senha, sem complica√ß√£o.
        </p>

        <form id="form">
          <div>
            <label for="email">Seu e-mail</label>
            <input id="email" type="email" placeholder="ex: seuemail@gmail.com" autocomplete="email" required />
          </div>

          <div class="row">
            <button class="btn btn-primary" id="btn" type="submit">Enviar link de acesso</button>
          </div>
        </form>

        <div id="msg" class="msg"></div>

        <div class="hint">
          Dica: se voc√™ pedir o link em um navegador, abra o email e clique no link no <b>mesmo navegador</b>.
        </div>
      </div>
    </div>
  </main>

  <footer>
    <div class="container">
      <div style="display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap;">
        <p>¬© 2026 GoArgentina ‚Ä¢ Orienta√ß√£o para brasileiros na Argentina</p>
        <p><a href="index.html">Voltar para o site</a></p>
      </div>
    </div>
  </footer>

  <div class="loading hidden" id="loading" aria-live="polite" aria-busy="true">
    <div class="loading-card">
      <div class="spinner" aria-hidden="true"></div>
      <div class="loading-text" id="loadingText">Carregando‚Ä¶</div>
    </div>
  </div>

  <!-- ‚úÖ vers√£o travada para evitar que updates do CDN quebrem o login -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.93.2"></script>

  <script>
    // ‚úÖ Suas vari√°veis (URL + ANON key podem ficar no front)
    const SUPABASE_URL = "https://gqtkhimnfphllvtxkmjl.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdxdGtoaW1uZnBobGx2dHhrbWpsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkwNTg5MDAsImV4cCI6MjA4NDYzNDkwMH0.I7GOmBZsUtyxuPxzhcg3i5qaDuIFWBHHNtlZS65Qt_k";

    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: {
        persistSession: true,
        autoRefreshToken: true,
        detectSessionInUrl: true
      }
    });

    const form = document.getElementById("form");
    const emailEl = document.getElementById("email");
    const btn = document.getElementById("btn");
    const msg = document.getElementById("msg");

    const loadingEl = document.getElementById("loading");
    const loadingText = document.getElementById("loadingText");

    function setLoading(show, text){
      if (text) loadingText.textContent = text;
      loadingEl.classList.toggle("hidden", !show);
    }

    function showMessage(text, type = "warn") {
      msg.style.display = "block";
      msg.textContent = text;
      msg.dataset.type = type;
    }

    function clearMessage(){
      msg.style.display = "none";
      msg.textContent = "";
      msg.dataset.type = "";
    }

    function cleanUrl(){
      const clean = window.location.origin + window.location.pathname;
      window.history.replaceState({}, document.title, clean);
    }

    // ‚úÖ Cooldown para evitar erro 429 (Supabase: 45s)
    const COOLDOWN_SECONDS = 45;
    const COOLDOWN_KEY = "goargentina_last_magiclink_ts";

    function setCooldownNow() {
      localStorage.setItem(COOLDOWN_KEY, String(Date.now()));
      updateCooldownUI();
    }

    function updateCooldownUI() {
      const last = Number(localStorage.getItem(COOLDOWN_KEY) || "0");
      const elapsed = (Date.now() - last) / 1000;
      const remaining = Math.ceil(COOLDOWN_SECONDS - elapsed);

      if (remaining > 0) {
        btn.disabled = true;
        btn.textContent = `Aguarde ${remaining}s...`;
      } else {
        btn.disabled = false;
        btn.textContent = "Enviar link de acesso";
      }
    }

    setInterval(updateCooldownUI, 500);

    function currentPageUrl(){
      // O link volta pra ESTA p√°gina, e daqui a gente conclui o login e redireciona
      return window.location.origin + window.location.pathname;
    }

    async function routeAfterLogin(){
      // Tenta direcionar admin -> admin.html (sem depender do banco; √© s√≥ UX)
      // Se profiles n√£o estiver acess√≠vel por RLS, cai no dashboard mesmo.
      try{
        const { data: userData } = await sb.auth.getUser();
        const uid = userData?.user?.id;

        if (uid){
          const { data: profile, error } = await sb
            .from("profiles")
            .select("role")
            .eq("id", uid)
            .maybeSingle();

          if (!error && profile?.role === "admin"){
            window.location.href = "admin.html";
            return;
          }
        }
      } catch (_) {}

      window.location.href = "dashboard.html";
    }

    async function consumeCallbackIfPresent(){
      const url = new URL(window.location.href);

      // Se vier erro pelo callback
      const err = url.searchParams.get("error");
      const errDesc = url.searchParams.get("error_description");
      if (err || errDesc){
        cleanUrl();
        showMessage("‚ùå N√£o consegui concluir o login.\n" + (errDesc || err), "error");
        return;
      }

      // ‚úÖ PKCE (mais comum hoje): ?code=...
      const code = url.searchParams.get("code");
      if (code){
        setLoading(true, "Concluindo login‚Ä¶");
        const { error } = await sb.auth.exchangeCodeForSession(window.location.href);
        if (error){
          setLoading(false);
          cleanUrl();
          showMessage("‚ùå Falha ao validar o link.\n\nDetalhe: " + (error.message || error), "error");
          return;
        }
        cleanUrl();
        await routeAfterLogin();
        return;
      }

      // ‚úÖ Fallback: links antigos podem voltar com #access_token=...
      if (window.location.hash && window.location.hash.includes("access_token=")){
        const params = new URLSearchParams(window.location.hash.substring(1));
        const access_token = params.get("access_token");
        const refresh_token = params.get("refresh_token");

        if (access_token && refresh_token){
          setLoading(true, "Concluindo login‚Ä¶");
          const { error } = await sb.auth.setSession({ access_token, refresh_token });
          if (error){
            setLoading(false);
            cleanUrl();
            showMessage("‚ùå Falha ao validar o link.\n\nDetalhe: " + (error.message || error), "error");
            return;
          }
          cleanUrl();
          await routeAfterLogin();
          return;
        }
      }
    }

    async function redirectIfAlreadyLoggedIn(){
      const { data } = await sb.auth.getSession();
      if (data?.session){
        setLoading(true, "Voc√™ j√° est√° logado. Redirecionando‚Ä¶");
        await routeAfterLogin();
      }
    }

    // 1) Consome callback (code/hash) primeiro
    (async function boot(){
      updateCooldownUI();
      clearMessage();

      await consumeCallbackIfPresent();
      // 2) Se j√° est√° logado, manda direto
      await redirectIfAlreadyLoggedIn();
    })();

    // 3) Submit do formul√°rio (envia magic link)
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      updateCooldownUI();
      if (btn.disabled) return;

      const email = (emailEl.value || "").trim();
      if (!email) return;

      btn.disabled = true;
      clearMessage();
      showMessage("üì® Enviando link de acesso‚Ä¶", "warn");

      try{
        // Importante: voltar para esta p√°gina (callback)
        const redirectTo = currentPageUrl();

        const { error } = await sb.auth.signInWithOtp({
          email,
          options: {
            emailRedirectTo: redirectTo,
            shouldCreateUser: true
          }
        });

        if (error){
          // 429 t√≠pico: "For security purposes, you can only request this after 45 seconds."
          const msgText = String(error.message || error);

          if (msgText.toLowerCase().includes("45") || msgText.toLowerCase().includes("security purposes")){
            setCooldownNow();
            showMessage("‚è≥ Por seguran√ßa, voc√™ s√≥ pode pedir um novo link ap√≥s 45 segundos.\n\nTente novamente em instantes.", "warn");
            return;
          }

          throw error;
        }

        setCooldownNow();
        showMessage(
          "‚úÖ Link enviado!\n\n" +
          "Abra seu email e clique no link.\n" +
          "Se n√£o aparecer, verifique SPAM / Promo√ß√µes.",
          "success"
        );
      } catch (err){
        console.error("sendMagicLink error:", err);
        showMessage("‚ùå N√£o consegui enviar o email.\n\nDetalhe: " + (err?.message || err), "error");
        btn.disabled = false;
        btn.textContent = "Enviar link de acesso";
      }
    });
  </script>
</body>
</html>
