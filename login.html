<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Login | GoArgentina</title>
  <meta name="description" content="Acesse sua √°rea do cliente com link m√°gico." />

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root{
      --blue-900:#0A0E27;
      --blue-800:#0F1B3D;
      --blue-700:#17306A;
      --text:#0D1220;
      --muted:#5B6475;
      --bg:#FFFFFF;
      --bg-soft:#F6F7FB;
      --sand:#F3E7C6;
      --sand-2:#F7F1DD;
      --line:rgba(13,18,32,.10);
      --radius:16px;
      --shadow: 0 18px 50px rgba(13,18,32,.10);
    }

    body{
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Inter, Roboto, Arial, sans-serif;
      background: var(--bg-soft);
      color: var(--text);
      line-height: 1.6;
      min-height: 100vh;
    }

    a{ color: inherit; text-decoration: none; }

    .container{
      width: min(1120px, calc(100% - 40px));
      margin: 0 auto;
    }

    /* Header (igual landing) */
    header{
      position: sticky;
      top: 0;
      z-index: 100;
      background: rgba(255,255,255,.95);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--line);
    }
    .nav{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 16px;
      padding: 14px 0;
      flex-wrap: wrap;
    }
    .brand{
      display:flex;
      align-items:center;
      gap: 12px;
      font-weight: 900;
      letter-spacing: .2px;
    }
    .mark{
      width: 38px; height: 38px;
      border-radius: 12px;
      background: var(--blue-700);
      display:flex;
      align-items:center;
      justify-content:center;
      color: white;
      font-weight: 900;
    }
    .brand small{
      display:block;
      font-weight: 700;
      color: var(--muted);
      margin-top: -2px;
      font-size: 12px;
      letter-spacing: 0;
    }

    .actions{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap: 8px;
      padding: 12px 16px;
      border-radius: 999px;
      font-weight: 800;
      font-size: 14px;
      border: 1px solid var(--line);
      background: white;
      cursor: pointer;
      transition: all .15s ease;
      white-space: nowrap;
      user-select: none;
    }
    .btn:hover{
      transform: translateY(-1px);
      box-shadow: 0 10px 25px rgba(13,18,32,.08);
    }
    .btn-primary{
      background: var(--blue-700);
      color: white;
      border-color: rgba(255,255,255,.18);
    }
    .btn-primary:hover{ background: var(--blue-800); }
    .btn-ghost{ background: var(--bg-soft); }
    .btn:disabled{
      opacity: .65;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    /* Page */
    main{
      padding: 40px 0 64px;
    }
    .wrap{
      display:flex;
      align-items:center;
      justify-content:center;
      min-height: calc(100vh - 72px);
    }
    .card{
      width: 100%;
      max-width: 560px;
      background: white;
      border: 1px solid var(--line);
      border-radius: calc(var(--radius) + 4px);
      box-shadow: var(--shadow);
      padding: 22px;
    }
    .card-top{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }
    .tag{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 999px;
      background: var(--sand-2);
      border: 1px solid rgba(0,0,0,.08);
      font-weight: 800;
      font-size: 13px;
      color: rgba(43,47,55,.92);
    }
    h1{
      font-size: clamp(22px, 3.2vw, 28px);
      line-height: 1.15;
      margin: 10px 0 8px;
      font-weight: 950;
      letter-spacing: -0.3px;
    }
    .lead{
      color: var(--muted);
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 18px;
      max-width: 70ch;
    }

    form{
      display:flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 6px;
    }
    label{
      display:block;
      font-size: 13px;
      color: rgba(13,18,32,.72);
      font-weight: 800;
      margin-bottom: 6px;
    }
    input{
      width: 100%;
      padding: 12px 14px;
      border-radius: 12px;
      background: white;
      border: 1px solid var(--line);
      color: var(--text);
      font-size: 14px;
      outline: none;
      font-weight: 650;
    }
    input::placeholder{ color: rgba(13,18,32,.38); font-weight: 650; }
    input:focus{
      border-color: rgba(23,48,106,.35);
      box-shadow: 0 0 0 4px rgba(23,48,106,.12);
    }

    .row{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 6px;
    }
    .row .btn{
      width: 100%;
    }

    .msg{
      margin-top: 14px;
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: var(--bg-soft);
      color: rgba(13,18,32,.92);
      font-size: 13px;
      display:none;
      white-space: pre-line;
      font-weight: 650;
    }
    .msg[data-type="success"]{
      background: rgba(22,163,74,.08);
      border-color: rgba(22,163,74,.20);
    }
    .msg[data-type="warn"]{
      background: rgba(245,158,11,.10);
      border-color: rgba(245,158,11,.24);
    }
    .msg[data-type="error"]{
      background: rgba(220,38,38,.08);
      border-color: rgba(220,38,38,.18);
    }

    .hint{
      margin-top: 12px;
      color: rgba(13,18,32,.60);
      font-size: 12px;
      line-height: 1.5;
      font-weight: 650;
    }
    .hint b{ color: rgba(13,18,32,.82); }

    footer{
      padding: 22px 0;
      border-top: 1px solid var(--line);
      font-size: 13px;
      color: rgba(13,18,32,.6);
      background: rgba(255,255,255,.7);
    }
    footer a{ color: rgba(13,18,32,.75); font-weight: 800; }

    @media (max-width: 520px){
      .container{ width: calc(100% - 28px); }
      .actions{ width: 100%; }
      .btn{ width: 100%; }
      .wrap{ min-height: calc(100vh - 92px); }
    }
  </style>
</head>

<body>
  <header>
    <div class="container">
      <div class="nav">
        <a class="brand" href="index.html" aria-label="GoArgentina">
          <div class="mark">GO</div>
          <div>
            GoArgentina
            <small>Orienta√ß√£o para DNI na Argentina</small>
          </div>
        </a>

        <div class="actions">
          <a class="btn btn-ghost" href="index.html">‚Üê Voltar</a>
          <a class="btn btn-primary" href="https://wa.me/5491159023706" target="_blank" rel="noopener">üí¨ WhatsApp</a>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="container wrap">
      <div class="card" role="region" aria-label="Login GoArgentina">
        <div class="card-top">
          <span class="tag">üîí √Årea do cliente</span>
        </div>

        <h1>Entrar com link m√°gico</h1>
        <p class="lead">
          Digite seu e-mail e vamos enviar um link de acesso. Sem senha, sem complica√ß√£o.
        </p>

        <form id="form">
          <div>
            <label for="email">Seu e-mail</label>
            <input id="email" type="email" placeholder="ex: seuemail@gmail.com" autocomplete="email" required />
          </div>

          <div class="row">
            <button class="btn btn-primary" id="btn" type="submit">Enviar link de acesso</button>
          </div>
        </form>

        <div id="msg" class="msg"></div>

        <div class="hint">
          Dica: se voc√™ pedir o link em um navegador, abra o email e clique no link no <b>mesmo navegador</b>.
        </div>
      </div>
    </div>
  </main>

  <footer>
    <div class="container">
      <div style="display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap;">
        <p>¬© 2026 GoArgentina ‚Ä¢ Orienta√ß√£o para brasileiros na Argentina</p>
        <p><a href="index.html">Voltar para o site</a></p>
      </div>
    </div>
  </footer>

  <script>
    // ‚úÖ Suas vari√°veis (URL + ANON key podem ficar no front)
    const SUPABASE_URL = "https://gqtkhimnfphllvtxkmjl.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdxdGtoaW1uZnBobGx2dHhrbWpsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkwNTg5MDAsImV4cCI6MjA4NDYzNDkwMH0.I7GOmBZsUtyxuPxzhcg3i5qaDuIFWBHHNtlZS65Qt_k";

    // project ref (parte do URL do supabase)
    const PROJECT_REF = "gqtkhimnfphllvtxkmjl";
    const STORAGE_KEY = `sb-${PROJECT_REF}-auth-token`;

    const form = document.getElementById("form");
    const emailEl = document.getElementById("email");
    const btn = document.getElementById("btn");
    const msg = document.getElementById("msg");

    function showMessage(text, type = "warn") {
      msg.style.display = "block";
      msg.textContent = text;
      msg.dataset.type = type;
    }

    function clearUrl() {
      const clean = window.location.origin + window.location.pathname;
      window.history.replaceState({}, document.title, clean);
    }

    function base64UrlToJson(b64url) {
      let b64 = b64url.replace(/-/g, "+").replace(/_/g, "/");
      while (b64.length % 4) b64 += "=";
      const json = atob(b64);
      return JSON.parse(json);
    }

    function getStoredSession() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return null;
        const session = JSON.parse(raw);
        if (session?.expires_at && (Date.now() / 1000) > session.expires_at) {
          localStorage.removeItem(STORAGE_KEY);
          return null;
        }
        return session;
      } catch {
        return null;
      }
    }

    function saveSessionFromHash(params) {
      const access_token = params.get("access_token");
      const refresh_token = params.get("refresh_token");
      const token_type = params.get("token_type") || "bearer";
      const expires_at = Number(params.get("expires_at")) || null;
      const expires_in = Number(params.get("expires_in")) || 3600;

      if (!access_token || !refresh_token) return false;

      let user = null;
      try {
        const payload = base64UrlToJson(access_token.split(".")[1]);
        user = {
          id: payload.sub,
          email: payload.email,
          aud: payload.aud,
          role: payload.role
        };
      } catch (_) {}

      const computedExpiresAt = expires_at || Math.floor(Date.now() / 1000) + expires_in;

      const session = {
        access_token,
        refresh_token,
        token_type,
        expires_in,
        expires_at: computedExpiresAt,
        user
      };

      localStorage.setItem(STORAGE_KEY, JSON.stringify(session));
      return true;
    }

    function redirectToDashboard() {
      showMessage("‚úÖ Login conclu√≠do. Redirecionando...", "success");
      setTimeout(() => {
        window.location.href = "dashboard.html";
      }, 300);
    }

    // Cooldown (pra evitar 429)
    const COOLDOWN_SECONDS = 45;
    const COOLDOWN_KEY = "goargentina_last_magiclink_ts";

    function setCooldownNow() {
      localStorage.setItem(COOLDOWN_KEY, String(Date.now()));
      updateCooldownUI();
    }

    function updateCooldownUI() {
      const last = Number(localStorage.getItem(COOLDOWN_KEY) || "0");
      const elapsed = (Date.now() - last) / 1000;
      const remaining = Math.ceil(COOLDOWN_SECONDS - elapsed);

      if (remaining > 0) {
        btn.disabled = true;
        btn.textContent = `Aguarde ${remaining}s...`;
      } else {
        btn.disabled = false;
        btn.textContent = "Enviar link de acesso";
      }
    }

    setInterval(updateCooldownUI, 500);

    // ‚úÖ Envio do magic link via FETCH
    async function sendMagicLink(email) {
      // redireciona exatamente para esta p√°gina (mais robusto que origin + "/login.html")
      const redirectTo = window.location.origin + window.location.pathname;

      const url = SUPABASE_URL + "/auth/v1/otp?redirect_to=" + encodeURIComponent(redirectTo);

      const res = await fetch(url, {
        method: "POST",
        headers: {
          "apikey": SUPABASE_ANON_KEY,
          "Authorization": "Bearer " + SUPABASE_ANON_KEY,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          email,
          create_user: true
        })
      });

      let payload = null;
      try { payload = await res.json(); } catch (_) {}

      if (!res.ok) {
        const detail =
          payload?.msg ||
          payload?.error_description ||
          payload?.error ||
          ("HTTP " + res.status);
        throw new Error(detail);
      }

      return true;
    }

    // 1) Se abriu via magic link: consome hash e salva sess√£o
    (function consumeMagicLink() {
      const hash = window.location.hash;
      if (!hash || hash.length < 2) return;

      const params = new URLSearchParams(hash.substring(1));
      const type = params.get("type");

      const ok = saveSessionFromHash(params);
      if (ok) {
        clearUrl();
        redirectToDashboard();
      } else if (type) {
        showMessage(
          "‚ö†Ô∏è Link recebido, mas n√£o encontrei tokens de sess√£o no URL.\n" +
          "Se isso persistir, revise as configura√ß√µes de Auth Redirect/URL no Supabase.",
          "warn"
        );
      }
    })();

    // 2) Ao abrir a p√°gina: se j√° estiver logado, vai pro dashboard
    const existing = getStoredSession();
    if (existing) {
      redirectToDashboard();
    }

    // 3) Submit do formul√°rio
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      updateCooldownUI();
      if (btn.disabled) return;

      const email = emailEl.value.trim();
      if (!email) return;

      btn.disabled = true;
      showMessage("üì® Enviando link de acesso...", "warn");

      try {
        await sendMagicLink(email);
        setCooldownNow();
        showMessage(
          "‚úÖ Link enviado!\n\n" +
          "Abra seu email e clique no link.\n" +
          "Se n√£o aparecer, verifique SPAM / Promo√ß√µes.",
          "success"
        );
      } catch (err) {
        console.error("sendMagicLink error:", err);
        showMessage("‚ùå N√£o consegui enviar o email.\n\nDetalhe: " + (err?.message || err), "error");
        btn.disabled = false;
        btn.textContent = "Enviar link de acesso";
      }
    });

    // inicial
    updateCooldownUI();
  </script>
</body>
</html>
