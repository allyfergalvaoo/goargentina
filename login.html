<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Login | GoArgentina</title>
  <style>
    :root { --primary:#0066FF; --accent:#FFD500; --dark:#0A0E27; --light:#F8F9FF; }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:var(--dark); color:var(--light);
      min-height:100vh; display:flex; align-items:center; justify-content:center;
      padding:24px;
    }
    .card{
      width:100%; max-width:520px;
      background:rgba(255,255,255,0.06);
      border:1px solid rgba(255,255,255,0.12);
      border-radius:18px; padding:26px;
    }
    .logo{display:flex;align-items:center;gap:12px;margin-bottom:18px;}
    .logo-icon{width:40px;height:40px;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
    .logo-title{
      font-weight:900;
      font-size:32px;
      line-height:1.1;
      margin:0;
      background:linear-gradient(135deg,var(--primary),var(--accent));
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      background-clip:text;
    }
    h1{font-size:20px;margin:0 0 10px 0;}
    p{color:rgba(255,255,255,0.7);font-size:14px;margin-bottom:18px;line-height:1.5}
    label{display:block;font-size:13px;color:rgba(255,255,255,0.8);margin-bottom:8px}
    input{
      width:100%; padding:12px 14px; border-radius:12px;
      background:rgba(255,255,255,0.06);
      border:1px solid rgba(255,255,255,0.12);
      color:#fff; font-size:14px; outline:none;
    }
    input:focus{border-color:rgba(0,102,255,0.6)}
    .row{display:flex;gap:10px;margin-top:14px}
    button{
      width:100%;
      padding:12px 14px;
      border:none; border-radius:12px;
      cursor:pointer; font-weight:800;
      background:linear-gradient(135deg,var(--primary),#0052CC);
      color:white;
    }
    button:disabled{opacity:0.65;cursor:not-allowed}
    .msg{
      margin-top:14px;
      padding:12px 12px;
      border-radius:12px;
      background:rgba(255,255,255,0.05);
      border:1px solid rgba(255,255,255,0.10);
      color:rgba(255,255,255,0.92);
      font-size:13px;
      display:none;
      white-space:pre-line;
    }
    .hint{margin-top:12px;color:rgba(255,255,255,0.55);font-size:12px;line-height:1.5}
  </style>
</head>
<body>
  <div class="card">
    <div class="logo">
      <svg class="logo-icon" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <linearGradient id="logoGradient" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" style="stop-color:#0066FF;stop-opacity:1" />
            <stop offset="100%" style="stop-color:#FFD500;stop-opacity:1" />
          </linearGradient>
        </defs>
        <polygon points="20,0 40,20 20,40 0,20" fill="url(#logoGradient)"/>
      </svg>
      <div class="logo-title">GoArgentina</div>
    </div>

    <h1>Entrar</h1>
    <p>Digite seu e-mail e vamos enviar um link m√°gico para acessar sua conta.</p>

    <form id="form">
      <label for="email">Seu e-mail</label>
      <input id="email" type="email" placeholder="ex: seuemail@gmail.com" required />
      <div class="row">
        <button id="btn" type="submit">Enviar link de acesso</button>
      </div>
    </form>

    <div id="msg" class="msg"></div>

    <div class="hint">
      Se voc√™ pedir o link num navegador, abra o email e clique no link no <b>mesmo navegador</b>.
    </div>
  </div>

  <script>
    // ‚úÖ Suas vari√°veis (URL + ANON key podem ficar no front)
    const SUPABASE_URL = "https://gqtkhimnfphllvtxkmjl.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdxdGtoaW1uZnBobGx2dHhrbWpsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkwNTg5MDAsImV4cCI6MjA4NDYzNDkwMH0.I7GOmBZsUtyxuPxzhcg3i5qaDuIFWBHHNtlZS65Qt_k";

    // project ref (parte do URL do supabase)
    const PROJECT_REF = "gqtkhimnfphllvtxkmjl";
    const STORAGE_KEY = `sb-${PROJECT_REF}-auth-token`;

    const form = document.getElementById("form");
    const emailEl = document.getElementById("email");
    const btn = document.getElementById("btn");
    const msg = document.getElementById("msg");

    function showMessage(text) {
      msg.style.display = "block";
      msg.textContent = text;
    }

    function clearUrl() {
      const clean = window.location.origin + window.location.pathname;
      window.history.replaceState({}, document.title, clean);
    }

    function base64UrlToJson(b64url) {
      // decodifica payload JWT (base64url)
      let b64 = b64url.replace(/-/g, '+').replace(/_/g, '/');
      while (b64.length % 4) b64 += '=';
      const json = atob(b64);
      return JSON.parse(json);
    }

    function getStoredSession() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return null;
        const session = JSON.parse(raw);
        // se expirou, remove
        if (session?.expires_at && (Date.now()/1000) > session.expires_at) {
          localStorage.removeItem(STORAGE_KEY);
          return null;
        }
        return session;
      } catch {
        return null;
      }
    }

    function saveSessionFromHash(params) {
      const access_token = params.get("access_token");
      const refresh_token = params.get("refresh_token");
      const token_type = params.get("token_type") || "bearer";
      const expires_at = Number(params.get("expires_at")) || null;
      const expires_in = Number(params.get("expires_in")) || 3600;

      if (!access_token || !refresh_token) return false;

      // tenta montar um user b√°sico a partir do JWT
      let user = null;
      try {
        const payload = base64UrlToJson(access_token.split(".")[1]);
        user = {
          id: payload.sub,
          email: payload.email,
          aud: payload.aud,
          role: payload.role
        };
      } catch (_) {}

      const computedExpiresAt = expires_at || Math.floor(Date.now()/1000) + expires_in;

      const session = {
        access_token,
        refresh_token,
        token_type,
        expires_in,
        expires_at: computedExpiresAt,
        user
      };

      localStorage.setItem(STORAGE_KEY, JSON.stringify(session));
      return true;
    }

    function redirectToDashboard() {
      showMessage("‚úÖ Login conclu√≠do. Redirecionando...");
      setTimeout(() => {
        window.location.href = "dashboard.html";
      }, 300);
    }

    // Cooldown (pra evitar 429)
    const COOLDOWN_SECONDS = 45;
    const COOLDOWN_KEY = "goargentina_last_magiclink_ts";

    function setCooldownNow() {
      localStorage.setItem(COOLDOWN_KEY, String(Date.now()));
      updateCooldownUI();
    }

    function updateCooldownUI() {
      const last = Number(localStorage.getItem(COOLDOWN_KEY) || "0");
      const elapsed = (Date.now() - last) / 1000;
      const remaining = Math.ceil(COOLDOWN_SECONDS - elapsed);

      if (remaining > 0) {
        btn.disabled = true;
        btn.textContent = `Aguarde ${remaining}s...`;
      } else {
        btn.disabled = false;
        btn.textContent = "Enviar link de acesso";
      }
    }

    setInterval(updateCooldownUI, 500);

    // ‚úÖ Envio do magic link via FETCH
    async function sendMagicLink(email) {
      const redirectTo = window.location.origin + "/login.html";
      const url = SUPABASE_URL + "/auth/v1/otp?redirect_to=" + encodeURIComponent(redirectTo);

      const res = await fetch(url, {
        method: "POST",
        headers: {
          "apikey": SUPABASE_ANON_KEY,
          "Authorization": "Bearer " + SUPABASE_ANON_KEY,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          email,
          create_user: true
        })
      });

      let payload = null;
      try { payload = await res.json(); } catch (_) {}

      if (!res.ok) {
        const detail =
          payload?.msg ||
          payload?.error_description ||
          payload?.error ||
          ("HTTP " + res.status);
        throw new Error(detail);
      }
      return true;
    }

    // 1) Ao abrir a p√°gina: se j√° estiver logado, vai pro dashboard
    const existing = getStoredSession();
    if (existing) {
      redirectToDashboard();
    }

    // 2) Ao abrir via magic link: consome o hash e salva sess√£o
    (function consumeMagicLink() {
      const hash = window.location.hash;
      if (!hash || hash.length < 2) return;

      const params = new URLSearchParams(hash.substring(1));
      const type = params.get("type");

      // seu caso: type=magiclink e vem access_token/refresh_token
      const ok = saveSessionFromHash(params);
      if (ok) {
        clearUrl();
        redirectToDashboard();
      } else {
        // se n√£o tiver tokens, deixa uma msg
        if (type) {
          showMessage("‚ö†Ô∏è Link recebido, mas n√£o encontrei tokens de sess√£o no URL.\nSe isso persistir, revise as configura√ß√µes de Auth Redirect/URL no Supabase.");
        }
      }
    })();

    // 3) Submit do formul√°rio
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      updateCooldownUI();
      if (btn.disabled) return;

      const email = emailEl.value.trim();
      if (!email) return;

      btn.disabled = true;
      showMessage("üì® Enviando link de acesso...");

      try {
        await sendMagicLink(email);
        setCooldownNow();
        showMessage(
          "‚úÖ Link enviado!\n\n" +
          "Abra seu email e clique no link.\n" +
          "Se n√£o aparecer, verifique SPAM / Promo√ß√µes."
        );
      } catch (err) {
        console.error("sendMagicLink error:", err);
        showMessage("‚ùå N√£o consegui enviar o email.\n\nDetalhe: " + (err?.message || err));
        btn.disabled = false;
        btn.textContent = "Enviar link de acesso";
      }
    });

    // inicial
    updateCooldownUI();
  </script>
</body>
</html>