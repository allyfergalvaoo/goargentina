<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Admin | GoArgentina</title>

<style>
* { margin:0; padding:0; box-sizing:border-box; }
:root {
  --primary:#0066FF; --accent:#FFD500; --dark:#0A0E27; --light:#F8F9FF;
  --success:#10B981; --warning:#F59E0B; --danger:#EF4444;
}
body { font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif; background:var(--dark); color:var(--light); line-height:1.6; overflow-x:hidden; }
.stars { position:fixed; inset:0; pointer-events:none; z-index:0; }
.star { position:absolute; width:2px; height:2px; background:#fff; border-radius:50%; opacity:.4; animation:twinkle 3s infinite; }
@keyframes twinkle { 0%,100%{opacity:.4} 50%{opacity:1} }
@keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-10px)} }
@keyframes slideDown { from{opacity:0; transform:translateY(-20px)} to{opacity:1; transform:translateY(0)} }
@keyframes fadeIn { from{opacity:0} to{opacity:1} }
@keyframes spin { to { transform:rotate(360deg) } }

header {
  padding:20px 0; backdrop-filter:blur(20px); background:rgba(10,14,39,.95);
  border-bottom:1px solid rgba(255,255,255,.1); position:sticky; top:0; z-index:100;
}
.header-container {
  max-width:1600px; margin:0 auto; padding:0 20px;
  display:flex; justify-content:space-between; align-items:center; gap:16px; flex-wrap:wrap;
}
.logo {
  font-size:24px; font-weight:900;
  background:linear-gradient(135deg,var(--primary),var(--accent));
  -webkit-background-clip:text; -webkit-text-fill-color:transparent;
  display:flex; align-items:center; gap:10px; text-decoration:none;
}
.logo-icon {
  width:40px; height:40px; border-radius:12px;
  background:linear-gradient(135deg,var(--primary),var(--accent));
  display:flex; align-items:center; justify-content:center; font-size:20px; color:var(--dark);
  animation:float 3s ease-in-out infinite;
}
.admin-badge {
  padding:4px 12px; background:rgba(239,68,68,.18);
  border:1px solid rgba(239,68,68,.45); border-radius:12px;
  font-size:12px; font-weight:800; color:var(--danger);
}
.header-actions { display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end; }
.user-pill {
  display:flex; align-items:center; gap:10px; padding:8px 14px;
  background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.1); border-radius:999px;
}
.user-avatar {
  width:34px; height:34px; border-radius:50%;
  background:linear-gradient(135deg,var(--primary),var(--accent));
  display:flex; align-items:center; justify-content:center; font-weight:900; color:var(--dark);
}
.user-name { font-size:13px; font-weight:800; color:rgba(255,255,255,.9); }
.logout-btn {
  background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.1);
  color:rgba(255,255,255,.75); padding:8px 16px; border-radius:999px;
  cursor:pointer; font-weight:800; transition:.2s;
}
.logout-btn:hover { background:rgba(255,255,255,.1); color:#fff; }

.main-container { max-width:1600px; margin:0 auto; padding:40px 20px; position:relative; z-index:1; }
.page-header { margin-bottom:24px; animation:slideDown .6s ease-out; }
.page-title {
  font-size:clamp(28px,4vw,36px); font-weight:950; margin-bottom:6px;
  background:linear-gradient(135deg,#fff,#a0b0ff);
  -webkit-background-clip:text; -webkit-text-fill-color:transparent;
}
.page-subtitle { font-size:15px; color:rgba(255,255,255,.6); }

.notice { margin-top:12px; padding:12px 14px; border-radius:14px; border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.05); font-size:13px; color:rgba(255,255,255,.85); display:none; }
.notice.show { display:block; }
.notice.ok { border-color:rgba(16,185,129,.35); background:rgba(16,185,129,.08); }
.notice.err { border-color:rgba(239,68,68,.35); background:rgba(239,68,68,.08); }

.stats-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:16px; margin:24px 0 28px; }
.stat-box {
  background:rgba(255,255,255,.05); backdrop-filter:blur(10px);
  border:1px solid rgba(255,255,255,.1); border-radius:16px; padding:22px;
  transition:.2s;
}
.stat-box:hover { transform:translateY(-3px); border-color:rgba(0,102,255,.35); }
.stat-label { font-size:12px; color:rgba(255,255,255,.6); text-transform:uppercase; letter-spacing:.5px; margin-bottom:8px; font-weight:800; }
.stat-value {
  font-size:32px; font-weight:950;
  background:linear-gradient(135deg,var(--primary),var(--accent));
  -webkit-background-clip:text; -webkit-text-fill-color:transparent;
}

.actions-bar { display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap; margin-bottom:16px; }
.search-box { flex:1; min-width:240px; max-width:440px; position:relative; }
.search-input {
  width:100%; padding:12px 16px 12px 44px; border-radius:12px;
  background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.1);
  color:#fff; font-weight:700; font-size:14px; transition:.2s;
}
.search-input:focus { outline:none; border-color:var(--primary); background:rgba(255,255,255,.08); }
.search-input::placeholder { color:rgba(255,255,255,.4); font-weight:700; }
.search-icon { position:absolute; left:14px; top:50%; transform:translateY(-50%); opacity:.55; }
.btn {
  border:none; cursor:pointer; font-weight:900; font-size:14px;
  padding:12px 18px; border-radius:12px; transition:.2s;
}
.btn-primary {
  background:linear-gradient(135deg,var(--primary),#0052CC);
  color:#fff; box-shadow:0 8px 20px rgba(0,102,255,.25);
}
.btn-primary:hover { transform:translateY(-2px); box-shadow:0 12px 30px rgba(0,102,255,.45); }
.btn-ghost {
  background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.1); color:rgba(255,255,255,.85);
}
.btn-ghost:hover { background:rgba(255,255,255,.1); }

.clients-table {
  background:rgba(255,255,255,.05); backdrop-filter:blur(10px);
  border:1px solid rgba(255,255,255,.1); border-radius:16px; overflow:hidden;
}
.table-header, .client-row {
  display:grid; grid-template-columns: 2.2fr 1.5fr 1fr 1fr 1fr 120px;
  gap:14px; padding:18px 20px; align-items:center;
}
.table-header {
  background:rgba(255,255,255,.03); border-bottom:1px solid rgba(255,255,255,.1);
  font-size:12px; font-weight:950; text-transform:uppercase; letter-spacing:.5px; color:rgba(255,255,255,.6);
}
.client-row { border-bottom:1px solid rgba(255,255,255,.05); cursor:pointer; transition:.15s; }
.client-row:hover { background:rgba(255,255,255,.05); }
.client-row:last-child { border-bottom:none; }
.client-name { font-weight:900; font-size:15px; }
.client-email { font-size:13px; color:rgba(255,255,255,.6); overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
.small { font-size:13px; color:rgba(255,255,255,.75); }

.status-badge {
  display:inline-flex; align-items:center; gap:6px;
  padding:6px 12px; border-radius:999px; font-size:12px; font-weight:950; white-space:nowrap;
  border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.06);
}
.status-badge.fase { border-color:rgba(0,102,255,.35); background:rgba(0,102,255,.14); color:#9ec2ff; }
.status-badge.completed { border-color:rgba(16,185,129,.35); background:rgba(16,185,129,.14); color:var(--success); }
.docs-count { font-size:13px; color:rgba(255,255,255,.8); font-weight:900; }
.docs-count.complete { color:var(--success); }
.action-btn {
  background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12);
  color:#fff; padding:8px 12px; border-radius:10px; font-size:12px; font-weight:950; cursor:pointer; transition:.15s;
}
.action-btn:hover { background:rgba(0,102,255,.18); border-color:rgba(0,102,255,.4); }

.empty-state { text-align:center; padding:60px 20px; }
.empty-icon { font-size:56px; opacity:.3; margin-bottom:10px; }
.empty-text { font-size:15px; color:rgba(255,255,255,.6); font-weight:800; }

.modal {
  display:none; position:fixed; inset:0; z-index:1000;
  background:rgba(0,0,0,.78); backdrop-filter:blur(10px); animation:fadeIn .25s ease-out;
  padding:18px;
}
.modal.active { display:flex; align-items:center; justify-content:center; }
.modal-content {
  background:var(--dark); border:1px solid rgba(255,255,255,.2);
  border-radius:22px; width:100%; max-width:1200px; max-height:92vh; overflow:auto;
}
.modal-header { padding:22px 22px; border-bottom:1px solid rgba(255,255,255,.1); display:flex; align-items:center; justify-content:space-between; gap:10px; }
.modal-title {
  font-size:20px; font-weight:950;
  background:linear-gradient(135deg,#fff,#a0b0ff);
  -webkit-background-clip:text; -webkit-text-fill-color:transparent;
}
.modal-close {
  background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12);
  color:#fff; width:38px; height:38px; border-radius:999px; cursor:pointer; font-size:18px; font-weight:950;
}
.modal-close:hover { background:rgba(239,68,68,.16); border-color:rgba(239,68,68,.35); }

.modal-body { padding:22px; }

.detail-grid { display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:16px; }
.detail-section {
  background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.1);
  border-radius:16px; padding:18px;
}
.section-title { font-size:15px; font-weight:950; margin-bottom:12px; display:flex; align-items:center; gap:8px; }
.info-row { display:flex; justify-content:space-between; gap:12px; padding:10px 0; border-bottom:1px solid rgba(255,255,255,.06); }
.info-row:last-child { border-bottom:none; }
.info-label { font-size:12px; color:rgba(255,255,255,.55); font-weight:900; }
.info-value { font-size:13px; font-weight:950; color:rgba(255,255,255,.9); text-align:right; }

.phases-list { display:flex; flex-direction:column; gap:10px; }
.phase-item {
  background:rgba(255,255,255,.03); border:1px solid rgba(255,255,255,.1);
  border-radius:12px; padding:14px; display:flex; justify-content:space-between; align-items:center; gap:12px;
}
.phase-item.active { border-color:rgba(0,102,255,.45); background:rgba(0,102,255,.12); }
.phase-item.completed { border-color:rgba(16,185,129,.35); background:rgba(16,185,129,.06); }
.phase-name { font-size:13px; font-weight:950; margin-bottom:2px; }
.phase-desc { font-size:12px; color:rgba(255,255,255,.55); font-weight:800; }
.phase-actions { display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }

.btn-small {
  padding:8px 10px; font-size:12px; font-weight:950;
  border-radius:10px; border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.06); color:#fff; cursor:pointer; transition:.15s;
}
.btn-small:hover { background:rgba(0,102,255,.18); border-color:rgba(0,102,255,.4); }
.btn-small.success:hover { background:rgba(16,185,129,.18); border-color:rgba(16,185,129,.4); }
.btn-small.danger:hover { background:rgba(239,68,68,.18); border-color:rgba(239,68,68,.4); }
.btn-small:disabled { opacity:.45; cursor:not-allowed; }

.documents-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(260px,1fr)); gap:12px; }
.doc-card {
  background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.1);
  border-radius:16px; padding:14px; transition:.15s;
}
.doc-card:hover { border-color:rgba(0,102,255,.35); }
.doc-card.approved { border-color:rgba(16,185,129,.42); background:rgba(16,185,129,.05); }
.doc-card.rejected { border-color:rgba(239,68,68,.42); background:rgba(239,68,68,.05); }
.doc-header { display:flex; justify-content:space-between; align-items:flex-start; gap:8px; margin-bottom:10px; }
.doc-icon { font-size:28px; }
.doc-status {
  font-size:11px; font-weight:950; padding:4px 10px; border-radius:999px;
  border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.06);
}
.doc-status.pending { color:var(--warning); border-color:rgba(245,158,11,.28); background:rgba(245,158,11,.10); }
.doc-status.uploaded { color:var(--success); border-color:rgba(16,185,129,.28); background:rgba(16,185,129,.10); }
.doc-status.approved { color:var(--success); border-color:rgba(16,185,129,.4); background:rgba(16,185,129,.14); }
.doc-status.rejected { color:var(--danger); border-color:rgba(239,68,68,.32); background:rgba(239,68,68,.12); }
.doc-title { font-size:13px; font-weight:950; margin-bottom:6px; }
.doc-info { font-size:12px; color:rgba(255,255,255,.55); font-weight:800; margin-bottom:10px; }
.doc-actions { display:flex; gap:8px; flex-wrap:wrap; }

.notes-area {
  width:100%; min-height:120px; padding:12px;
  background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.1);
  border-radius:12px; color:#fff; font-weight:800; resize:vertical;
}
.notes-area:focus { outline:none; border-color:rgba(0,102,255,.5); background:rgba(255,255,255,.07); }

.loading-overlay {
  position:fixed; inset:0; z-index:9999;
  background:rgba(10,14,39,.72); backdrop-filter:blur(10px);
  display:flex; align-items:center; justify-content:center; flex-direction:column; gap:10px;
}
.loading-overlay.hidden { display:none; }
.spinner {
  width:42px; height:42px; border-radius:50%;
  border:4px solid rgba(255,255,255,.15);
  border-top-color: rgba(255,255,255,.85);
  animation: spin .9s linear infinite;
}
.loading-text { color:rgba(255,255,255,.85); font-weight:950; font-size:14px; }

/* Steps editor */
.steps-toolbar{
  display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;
  margin-bottom:10px;
}
.steps-meta{
  display:flex; flex-direction:column; gap:2px;
}
.steps-title{
  font-size:13px; font-weight:950;
}
.steps-sub{
  font-size:12px; color:rgba(255,255,255,.55); font-weight:800;
}
.steps-list{
  display:flex; flex-direction:column; gap:10px;
}
.step-row{
  background:rgba(255,255,255,.03);
  border:1px solid rgba(255,255,255,.1);
  border-radius:14px;
  padding:12px;
}
.step-top{
  display:flex; justify-content:space-between; align-items:flex-start; gap:10px; flex-wrap:wrap;
}
.step-badge{
  display:inline-flex; align-items:center; gap:6px;
  padding:6px 10px; border-radius:999px; font-size:12px; font-weight:950;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.06);
}
.step-badge.done{
  border-color:rgba(16,185,129,.35);
  background:rgba(16,185,129,.14);
  color:var(--success);
}
.step-badge.pending{
  border-color:rgba(245,158,11,.28);
  background:rgba(245,158,11,.10);
  color:var(--warning);
}
.step-fields{
  display:grid; grid-template-columns:1fr; gap:8px; margin-top:10px;
}
.input{
  width:100%;
  padding:10px 12px;
  border-radius:12px;
  background:rgba(255,255,255,.05);
  border:1px solid rgba(255,255,255,.1);
  color:#fff; font-weight:800; font-size:13px;
}
.input:focus{ outline:none; border-color:rgba(0,102,255,.55); background:rgba(255,255,255,.08); }
.input::placeholder{ color:rgba(255,255,255,.4); font-weight:800; }
.step-actions{
  display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; margin-top:10px;
}
.checkbox-row{
  display:flex; align-items:center; gap:10px;
  font-size:12px; color:rgba(255,255,255,.8); font-weight:900;
}
.checkbox-row input{ width:16px; height:16px; accent-color: var(--primary); }

/* Messages */
.msg-toolbar{
  display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;
  margin-bottom:10px;
}
.msg-list{
  display:flex; flex-direction:column; gap:10px; margin-top:10px;
}
.msg-item{
  background:rgba(255,255,255,.03);
  border:1px solid rgba(255,255,255,.1);
  border-radius:14px;
  padding:12px;
}
.msg-head{
  display:flex; justify-content:space-between; gap:10px; align-items:flex-start; flex-wrap:wrap;
}
.msg-title{ font-weight:950; font-size:13px; }
.msg-meta{ font-size:12px; color:rgba(255,255,255,.55); font-weight:800; }
.msg-body{ margin-top:8px; font-size:13px; color:rgba(255,255,255,.85); font-weight:800; white-space:pre-wrap; }
.tag{
  display:inline-flex; align-items:center; gap:6px;
  padding:4px 10px; border-radius:999px;
  font-size:11px; font-weight:950;
  border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.06);
}
.tag.info{ border-color:rgba(0,102,255,.35); background:rgba(0,102,255,.14); color:#9ec2ff; }
.tag.update{ border-color:rgba(16,185,129,.35); background:rgba(16,185,129,.14); color:var(--success); }
.tag.warning{ border-color:rgba(245,158,11,.28); background:rgba(245,158,11,.10); color:var(--warning); }
.tag.success{ border-color:rgba(16,185,129,.35); background:rgba(16,185,129,.14); color:var(--success); }
.tag.unread{ border-color:rgba(245,158,11,.28); background:rgba(245,158,11,.10); color:var(--warning); }
.tag.read{ border-color:rgba(16,185,129,.35); background:rgba(16,185,129,.14); color:var(--success); }

@media (max-width:1200px){
  .table-header, .client-row { grid-template-columns: 2fr 1.4fr 1fr 1fr 120px; }
  .hide-xl { display:none; }
  .detail-grid { grid-template-columns:1fr; }
}
@media (max-width:768px){
  .stats-grid { grid-template-columns:1fr; }
  .actions-bar { flex-direction:column; align-items:stretch; }
  .search-box { max-width:100%; }
  .table-header, .client-row { grid-template-columns: 1fr 120px; }
  .hide-md { display:none; }
}
</style>
</head>

<body>
<div class="stars"></div>

<div class="loading-overlay" id="loading">
  <div class="spinner"></div>
  <div class="loading-text" id="loadingText">Carregando‚Ä¶</div>
</div>

<header>
  <div class="header-container">
    <a class="logo" href="index.html">
      <div class="logo-icon">üá¶üá∑</div><span>GoArgentina</span>
    </a>

    <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
      <span class="admin-badge">üîê Admin</span>
      <div class="header-actions">
        <div class="user-pill" title="Conta admin">
          <div class="user-avatar" id="adminAvatar">AD</div>
          <div class="user-name" id="adminName">Admin</div>
        </div>
        <button class="logout-btn" id="logoutBtn">Sair</button>
      </div>
    </div>
  </div>
</header>

<main class="main-container">
  <div class="page-header">
    <h1 class="page-title">Painel Administrativo</h1>
    <p class="page-subtitle">Gerencie clientes, fases, passos, documentos e mensagens</p>
    <div class="notice" id="noticeBox"></div>
  </div>

  <div class="stats-grid">
    <div class="stat-box"><div class="stat-label">Total de Clientes</div><div class="stat-value" id="totalClients">0</div></div>
    <div class="stat-box"><div class="stat-label">Em Andamento</div><div class="stat-value" id="activeClients">0</div></div>
    <div class="stat-box"><div class="stat-label">Conclu√≠dos</div><div class="stat-value" id="completedClients">0</div></div>
    <div class="stat-box"><div class="stat-label">Novos (7 dias)</div><div class="stat-value" id="newClients">0</div></div>
  </div>

  <div class="actions-bar">
    <div class="search-box">
      <span class="search-icon">üîç</span>
      <input id="searchInput" class="search-input" placeholder="Buscar por nome ou email‚Ä¶" />
    </div>
    <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;">
      <button class="btn btn-ghost" id="refreshBtn">‚Üª Atualizar</button>
      <button class="btn btn-primary" id="newClientBtn" title="Cria√ß√£o de conta depende do Auth (n√£o expomos Service Key no front)">
        ‚ûï Novo Cliente
      </button>
    </div>
  </div>

  <div class="clients-table">
    <div class="table-header">
      <div>Cliente</div>
      <div>Contato</div>
      <div class="hide-md">Status</div>
      <div class="hide-xl">Docs</div>
      <div class="hide-md">Fase</div>
      <div>A√ß√µes</div>
    </div>
    <div id="clientsList"></div>
  </div>

  <div class="empty-state" id="emptyState" style="display:none;">
    <div class="empty-icon">üóÇÔ∏è</div>
    <div class="empty-text">Nenhum cliente encontrado.</div>
  </div>
</main>

<!-- Modal: Detalhes do Cliente -->
<div class="modal" id="clientDetailModal">
  <div class="modal-content">
    <div class="modal-header">
      <div>
        <div class="modal-title" id="clientDetailTitle">Detalhes do Cliente</div>
        <div class="small" id="clientDetailSubtitle" style="margin-top:4px; color:rgba(255,255,255,.6); font-weight:800;"></div>
      </div>
      <button class="modal-close" id="closeClientModal">‚úï</button>
    </div>

    <div class="modal-body">
      <div class="detail-grid">
        <div class="detail-section">
          <div class="section-title">üë§ Informa√ß√µes</div>
          <div class="info-row"><span class="info-label">Nome</span><span class="info-value" id="detailName">-</span></div>
          <div class="info-row"><span class="info-label">Email</span><span class="info-value" id="detailEmail">-</span></div>
          <div class="info-row"><span class="info-label">User ID</span><span class="info-value" id="detailId" style="font-family:ui-monospace, SFMono-Regular, Menlo, monospace;">-</span></div>
          <div class="info-row"><span class="info-label">Criado em</span><span class="info-value" id="detailCreated">-</span></div>
          <div class="info-row"><span class="info-label">Fase atual</span><span class="info-value" id="detailPhase">-</span></div>
          <div class="small" style="margin-top:10px; color:rgba(255,255,255,.55); font-weight:800;">
            Clique em uma fase para editar os passos dela.
          </div>
        </div>

        <div class="detail-section">
          <div class="section-title">üîÑ Fases do Processo</div>
          <div class="phases-list" id="phasesList"></div>
        </div>
      </div>

      <!-- Steps editor -->
      <div class="detail-section" style="margin-bottom:16px;">
        <div class="section-title">üß© Passos da fase</div>

        <div class="steps-toolbar">
          <div class="steps-meta">
            <div class="steps-title" id="stepsPhaseTitle">Selecione uma fase</div>
            <div class="steps-sub" id="stepsPhaseSub">Voc√™ pode criar passos padr√£o, adicionar novos e marcar como conclu√≠do.</div>
          </div>
          <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
            <button class="btn-small" id="reloadStepsBtn">‚Üª Recarregar</button>
            <button class="btn-small" id="seedStepsBtn">‚ú® Gerar passos padr√£o</button>
            <button class="btn-small success" id="addStepBtn">‚ûï Adicionar passo</button>
          </div>
        </div>

        <div class="steps-list" id="stepsList"></div>

        <div class="small" style="margin-top:10px; color:rgba(255,255,255,.55); font-weight:800;">
          Observa√ß√£o: os passos ficam na tabela <b>phase_steps</b>. ‚ÄúConclu√≠do‚Äù usa <b>is_completed</b> (e salva <b>completed_at</b>).
        </div>
      </div>

      <div class="detail-section" style="margin-bottom:16px;">
        <div class="section-title">üìÑ Documentos</div>
        <div class="documents-grid" id="documentsGrid"></div>
      </div>

      <div class="detail-section" style="margin-bottom:16px;">
        <div class="section-title">üìù Notas Internas</div>
        <textarea class="notes-area" id="clientNotes" placeholder="Notas internas sobre este cliente‚Ä¶"></textarea>
        <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:12px; flex-wrap:wrap;">
          <button class="btn-small" id="reloadNotesBtn">‚Üª Recarregar</button>
          <button class="btn-small success" id="saveNotesBtn">Salvar Notas</button>
        </div>
        <div class="small" style="margin-top:10px; color:rgba(255,255,255,.55); font-weight:800;">
          Se aparecer erro ao salvar, provavelmente a tabela <b>admin_notes</b> n√£o existe ou RLS bloqueou.
        </div>
      </div>

      <!-- Messages to client -->
      <div class="detail-section">
        <div class="section-title">üì® Mensagens para o cliente</div>

        <div class="msg-toolbar">
          <div class="small" style="color:rgba(255,255,255,.7); font-weight:800;">
            Envie atualiza√ß√µes/dicas/solicita√ß√µes. Isso aparece na caixa de entrada do cliente.
          </div>
          <button class="btn-small" id="reloadMsgsBtn">‚Üª Recarregar</button>
        </div>

        <div style="display:grid; grid-template-columns:1fr 220px; gap:10px;">
          <input class="input" id="msgTitle" placeholder="T√≠tulo da mensagem (ex: Precisamos do comprovante de endere√ßo)" />
          <select class="input" id="msgType" style="appearance:auto;">
            <option value="info">info</option>
            <option value="update">update</option>
            <option value="warning">warning</option>
            <option value="success">success</option>
          </select>
        </div>

        <textarea class="notes-area" id="msgBody" placeholder="Digite a mensagem para o cliente‚Ä¶"></textarea>
        <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:12px; flex-wrap:wrap;">
          <button class="btn-small success" id="sendMsgBtn">Enviar mensagem</button>
        </div>

        <div class="msg-list" id="msgList"></div>

        <div class="small" style="margin-top:10px; color:rgba(255,255,255,.55); font-weight:800;">
          Tabela: <b>client_messages</b> (o cliente s√≥ v√™ as pr√≥prias mensagens via RLS).
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Modal: Novo Cliente (orienta√ß√£o) -->
<div class="modal" id="newClientModal">
  <div class="modal-content" style="max-width:720px;">
    <div class="modal-header">
      <div class="modal-title">‚ûï Novo Cliente</div>
      <button class="modal-close" id="closeNewClientModal">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="detail-section">
        <div class="section-title">üìå Como criar cliente (sem Service Key no front)</div>
        <div class="small" style="color:rgba(255,255,255,.7); font-weight:800;">
          Por seguran√ßa, n√£o d√° pra criar contas de usu√°rio ‚Äúfor√ßando‚Äù pelo front-end (isso exigiria a Service Role Key).
          O jeito simples √©:
          <ol style="margin:10px 0 0 18px;">
            <li>Deixar <b>Signups</b> habilitado no Supabase Auth (o cliente se cadastra sozinho)</li>
            <li>Ou usar <b>Invite user</b> no painel do Supabase (Auth ‚Üí Users)</li>
          </ol>
          <div style="margin-top:12px;">
            Link para voc√™ mandar pro cliente:
            <div style="margin-top:8px; padding:10px 12px; border-radius:12px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); font-family:ui-monospace, SFMono-Regular, Menlo, monospace; font-weight:900;" id="signupLinkBox">‚Äî</div>
          </div>
          <div style="margin-top:12px;">
            Assim que o cliente criar conta e fizer login, ele aparece automaticamente aqui (via tabela <b>profiles</b>).
          </div>
        </div>
        <div style="display:flex; justify-content:flex-end; margin-top:14px;">
          <button class="btn btn-primary" id="copySignupLinkBtn">Copiar link</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
/* =========================
   1) CONFIG
========================= */
const SUPABASE_URL = "https://gqtkhimnfphllvtxkmjl.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdxdGtoaW1uZnBobGx2dHhrbWpsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkwNTg5MDAsImV4cCI6MjA4NDYzNDkwMH0.I7GOmBZsUtyxuPxzhcg3i5qaDuIFWBHHNtlZS65Qt_k";

/* =========================
   2) CLIENT
========================= */
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
  auth: { persistSession:true, autoRefreshToken:true, detectSessionInUrl:true }
});

/* =========================
   3) UI helpers
========================= */
const loadingEl = document.getElementById("loading");
const loadingText = document.getElementById("loadingText");
const noticeBox = document.getElementById("noticeBox");

function setLoading(show, text){
  if (text) loadingText.textContent = text;
  loadingEl.classList.toggle("hidden", !show);
}
function showNotice(type, msg){
  noticeBox.className = "notice show " + (type==="ok" ? "ok" : "err");
  noticeBox.textContent = msg;
}
function hideNotice(){
  noticeBox.className = "notice";
  noticeBox.textContent = "";
}
function fmtDate(dt){
  if (!dt) return "-";
  try { return new Date(dt).toLocaleString("pt-BR"); } catch { return "-"; }
}
function initialsFrom(nameOrEmail){
  const s = (nameOrEmail || "AD").trim();
  const parts = s.split(" ").filter(Boolean);
  if (parts.length >= 2) return (parts[0][0] + parts[1][0]).toUpperCase();
  return (s.slice(0,2)).toUpperCase();
}
function filenameFromPath(path){
  if (!path) return null;
  const p = path.split("/");
  return p[p.length-1] || path;
}
function escapeHTML(s=""){
  return String(s).replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[m]));
}

/* =========================
   4) Stars
========================= */
const starsContainer = document.querySelector(".stars");
for (let i=0;i<100;i++){
  const star = document.createElement("div");
  star.className="star";
  star.style.left = Math.random()*100 + "%";
  star.style.top = Math.random()*100 + "%";
  star.style.animationDelay = Math.random()*3 + "s";
  starsContainer.appendChild(star);
}

/* =========================
   5) Constants
========================= */
const phases = [
  { id:1, name:"Documenta√ß√£o inicial", desc:"RG e foto" },
  { id:2, name:"Antecedentes criminais", desc:"Emiss√£o de certid√£o" },
  { id:3, name:"Domic√≠lio", desc:"Comprovante de endere√ßo" },
  { id:4, name:"Cadastro RADEX", desc:"Sistema migrat√≥rio" },
  { id:5, name:"Pagamento de taxas", desc:"Boletos" },
  { id:6, name:"Cita migrat√≥ria", desc:"Agendamento" },
  { id:7, name:"DNI emitido", desc:"Documento pronto" }
];

// passos padr√£o (para bot√£o "Gerar passos padr√£o")
const defaultSteps = {
  1: [
    { title:"Envio dos documentos para nossa equipe", desc:"Fazer upload do RG e foto 3x4" },
    { title:"Upload dos documentos na plataforma correspondente", desc:"Documentos ser√£o enviados ao sistema argentino" },
    { title:"An√°lise dos documentos realizada por n√≥s", desc:"Revis√£o e aprova√ß√£o dos documentos" },
  ],
  2: [
    { title:"Emiss√£o do documento", desc:"Solicita√ß√£o/obten√ß√£o da certid√£o" },
    { title:"Upload do documento ap√≥s a emiss√£o", desc:"Enviar o arquivo assim que estiver dispon√≠vel" },
  ],
  3: [
    { title:"Agendamento do tr√¢mite", desc:"Definir data/hor√°rio" },
    { title:"Retirada presencial do documento", desc:"Comparecer conforme instru√ß√µes" },
    { title:"Upload do documento obtido", desc:"Enviar comprovante/documento final" },
  ],
  4: [
    { title:"Realiza√ß√£o do cadastro", desc:"Cadastro no sistema migrat√≥rio" },
    { title:"Cria√ß√£o dos boletos das taxas migrat√≥rias", desc:"Gerar e organizar os pagamentos" },
  ],
  5: [
    { title:"Pagamento dos boletos", desc:"Pagar conforme orienta√ß√µes" },
    { title:"Upload dos comprovantes", desc:"Enviar comprovantes para valida√ß√£o" },
  ],
  6: [
    { title:"Agendamento da cita", desc:"Escolher data dispon√≠vel" },
    { title:"Comparecimento presencial", desc:"Comparecer com documentos" },
  ],
  7: [
    { title:"Aguardar a emiss√£o e chegada do DNI argentino", desc:"Acompanhar prazos e orienta√ß√µes" },
  ],
};

const docsCatalog = [
  { doc_type:"rg", name:"RG (Identidade)", icon:"ü™™" },
  { doc_type:"antecedentes", name:"Antecedentes Criminais", icon:"üìã" },
  { doc_type:"foto", name:"Foto 3x4", icon:"üì∏" },
  { doc_type:"outros", name:"Outros Documentos", icon:"üìÅ" },
];

/* =========================
   6) State
========================= */
let adminUser = null;
let adminProfile = null;

let clientsRaw = [];
let processMap = new Map();     // user_id -> { current_phase, updated_at }
let docsMap = new Map();        // user_id -> Map(doc_type -> docRow)

let filteredClients = [];
let currentClientId = null;

let selectedPhaseId = null;     // fase selecionada para editar passos
let stepsByPhase = new Map();   // phase_number -> rows[]
let clientMessages = [];        // mensagens do cliente atual

/* =========================
   7) Auth guard + init
========================= */
async function init(){
  setLoading(true, "Validando acesso‚Ä¶");

  const { data: sessionData } = await sb.auth.getSession();
  if (!sessionData?.session){
    window.location.href = "login.html";
    return;
  }

  const { data: userData, error: userErr } = await sb.auth.getUser();
  if (userErr || !userData?.user){
    window.location.href = "login.html";
    return;
  }
  adminUser = userData.user;

  const { data: profile, error: profErr } = await sb
    .from("profiles")
    .select("id, email, full_name, role, created_at")
    .eq("id", adminUser.id)
    .single();

  if (profErr || !profile){
    showNotice("err", "N√£o consegui carregar seu perfil admin. Recarregue a p√°gina.");
    setLoading(false);
    return;
  }

  adminProfile = profile;
  if (adminProfile.role !== "admin"){
    window.location.href = "dashboard.html";
    return;
  }

  // header
  const display = (adminProfile.full_name || adminProfile.email || "Admin");
  document.getElementById("adminName").textContent = display;
  document.getElementById("adminAvatar").textContent = initialsFrom(display);

  // link de cadastro
  const signupLink = `${window.location.origin}${window.location.pathname.replace(/\/[^/]*$/, "/")}login.html`;
  document.getElementById("signupLinkBox").textContent = signupLink;

  wireEvents();

  await loadAll();
  setLoading(false);
}

function wireEvents(){
  document.getElementById("logoutBtn").addEventListener("click", logout);
  document.getElementById("refreshBtn").addEventListener("click", loadAll);

  document.getElementById("searchInput").addEventListener("input", (e)=>{
    renderClients(e.target.value || "");
  });

  document.getElementById("closeClientModal").addEventListener("click", closeClientModal);
  document.getElementById("clientDetailModal").addEventListener("click", (e)=>{
    if (e.target.id === "clientDetailModal") closeClientModal();
  });

  document.getElementById("saveNotesBtn").addEventListener("click", saveNotes);
  document.getElementById("reloadNotesBtn").addEventListener("click", loadNotesForCurrentClient);

  // steps buttons
  document.getElementById("reloadStepsBtn").addEventListener("click", async ()=>{
    if (!currentClientId) return;
    await loadStepsForClient(currentClientId);
    renderStepsEditor(selectedPhaseId);
  });
  document.getElementById("seedStepsBtn").addEventListener("click", async ()=>{
    if (!currentClientId || !selectedPhaseId) return;
    await seedDefaultSteps(currentClientId, selectedPhaseId);
  });
  document.getElementById("addStepBtn").addEventListener("click", async ()=>{
    if (!currentClientId || !selectedPhaseId) return;
    await addNewStep(currentClientId, selectedPhaseId);
  });

  // messages
  document.getElementById("reloadMsgsBtn").addEventListener("click", async ()=>{
    if (!currentClientId) return;
    await loadMessagesForClient(currentClientId);
    renderMessages();
  });
  document.getElementById("sendMsgBtn").addEventListener("click", sendMessageToClient);

  // new client modal
  document.getElementById("newClientBtn").addEventListener("click", openNewClientModal);
  document.getElementById("closeNewClientModal").addEventListener("click", closeNewClientModal);
  document.getElementById("newClientModal").addEventListener("click", (e)=>{
    if (e.target.id === "newClientModal") closeNewClientModal();
  });
  document.getElementById("copySignupLinkBtn").addEventListener("click", async ()=>{
    const txt = document.getElementById("signupLinkBox").textContent;
    try {
      await navigator.clipboard.writeText(txt);
      showNotice("ok", "Link copiado!");
      closeNewClientModal();
    } catch {
      showNotice("err", "N√£o consegui copiar automaticamente. Copie manualmente.");
    }
  });
}

async function logout(){
  setLoading(true, "Saindo‚Ä¶");
  await sb.auth.signOut();
  window.location.href = "login.html";
}

/* =========================
   8) Load data
========================= */
async function loadAll(){
  hideNotice();
  setLoading(true, "Carregando clientes‚Ä¶");

  const { data: clients, error: cErr } = await sb
    .from("profiles")
    .select("id, email, full_name, role, created_at")
    .eq("role", "client")
    .order("created_at", { ascending:false });

  if (cErr){
    showNotice("err", "Erro ao carregar clientes. Confira RLS/pol√≠ticas das tabelas.");
    setLoading(false);
    return;
  }

  clientsRaw = clients || [];
  const ids = clientsRaw.map(c => c.id);
  processMap = new Map();
  docsMap = new Map();

  if (ids.length){
    const { data: procs } = await sb
      .from("dni_process")
      .select("user_id, current_phase, updated_at")
      .in("user_id", ids);
    (procs || []).forEach(p => processMap.set(p.user_id, p));
  }

  if (ids.length){
    const { data: docs } = await sb
      .from("documents")
      .select("user_id, doc_type, status, storage_path, uploaded_at, approved_at")
      .in("user_id", ids);

    (docs || []).forEach(d => {
      if (!docsMap.has(d.user_id)) docsMap.set(d.user_id, new Map());
      docsMap.get(d.user_id).set(d.doc_type, d);
    });
  }

  renderStats();
  renderClients(document.getElementById("searchInput").value || "");

  setLoading(false);
}

function renderStats(){
  const total = clientsRaw.length;
  let completed = 0;
  let active = 0;

  const now = Date.now();
  const sevenDaysMs = 7*24*60*60*1000;
  let new7 = 0;

  clientsRaw.forEach(c => {
    const proc = processMap.get(c.id);
    const phase = proc?.current_phase || 1;
    if (phase >= 7) completed++;
    else active++;

    const createdAt = c.created_at ? new Date(c.created_at).getTime() : null;
    if (createdAt && (now - createdAt) <= sevenDaysMs) new7++;
  });

  document.getElementById("totalClients").textContent = total;
  document.getElementById("activeClients").textContent = active;
  document.getElementById("completedClients").textContent = completed;
  document.getElementById("newClients").textContent = new7;
}

/* =========================
   9) Render clients table
========================= */
function docsUploadedCountFor(userId){
  const perUser = docsMap.get(userId);
  if (!perUser) return 0;
  let count = 0;
  docsCatalog.forEach(dc => {
    const d = perUser.get(dc.doc_type);
    if (d && (d.status === "uploaded" || d.status === "approved")) count++;
  });
  return count;
}

function phaseLabel(phase){
  if (phase >= 7) return { txt:"Conclu√≠do", cls:"completed" };
  return { txt:`Fase ${phase}`, cls:"fase" };
}

function renderClients(filter){
  const list = document.getElementById("clientsList");
  list.innerHTML = "";

  const q = (filter || "").trim().toLowerCase();

  filteredClients = clientsRaw.filter(c => {
    const name = (c.full_name || "").toLowerCase();
    const email = (c.email || "").toLowerCase();
    return !q || name.includes(q) || email.includes(q);
  });

  document.getElementById("emptyState").style.display = filteredClients.length ? "none" : "block";

  filteredClients.forEach(c => {
    const proc = processMap.get(c.id);
    const phase = proc?.current_phase || 1;
    const phaseInfo = phaseLabel(phase);

    const docsUploaded = docsUploadedCountFor(c.id);
    const docsCls = docsUploaded === 4 ? "complete" : "";
    const statusText = phase >= 7 ? "Conclu√≠do" : "Em andamento";

    const row = document.createElement("div");
    row.className = "client-row";
    row.addEventListener("click", ()=> openClientModal(c.id));

    row.innerHTML = `
      <div>
        <div class="client-name">${escapeHTML(c.full_name || "(Sem nome)")}</div>
        <div class="client-email">${escapeHTML(c.email || "-")}</div>
      </div>
      <div>
        <div class="small">${escapeHTML(c.email || "-")}</div>
        <div class="client-email">${fmtDate(c.created_at)}</div>
      </div>
      <div class="hide-md">
        <span class="status-badge ${phase >= 7 ? "completed" : "fase"}">${statusText}</span>
      </div>
      <div class="hide-xl">
        <span class="docs-count ${docsCls}">${docsUploaded}/4</span>
      </div>
      <div class="hide-md">
        <span class="status-badge ${phaseInfo.cls}">${phaseInfo.txt}</span>
      </div>
      <div>
        <button class="action-btn" type="button">Ver</button>
      </div>
    `;

    row.querySelector("button").addEventListener("click", (e)=>{
      e.stopPropagation();
      openClientModal(c.id);
    });

    list.appendChild(row);
  });
}

/* =========================
   10) Client modal (open)
========================= */
async function openClientModal(userId){
  currentClientId = userId;
  selectedPhaseId = null;
  stepsByPhase = new Map();
  clientMessages = [];

  const client = clientsRaw.find(c => c.id === userId);
  if (!client) return;

  const proc = processMap.get(userId);
  const phase = proc?.current_phase || 1;

  document.getElementById("clientDetailTitle").textContent = client.full_name || "Detalhes do Cliente";
  document.getElementById("clientDetailSubtitle").textContent = client.email || "";
  document.getElementById("detailName").textContent = client.full_name || "-";
  document.getElementById("detailEmail").textContent = client.email || "-";
  document.getElementById("detailId").textContent = client.id;
  document.getElementById("detailCreated").textContent = fmtDate(client.created_at);
  document.getElementById("detailPhase").textContent = `Fase ${phase}`;

  renderPhases(userId, phase);
  renderDocs(userId);

  // load notes + steps + msgs
  await Promise.all([
    loadNotesForCurrentClient(),
    loadStepsForClient(userId),
    loadMessagesForClient(userId)
  ]);

  // seleciona por padr√£o a fase atual do processo
  selectedPhaseId = phase;
  updateStepsHeader(selectedPhaseId);
  renderStepsEditor(selectedPhaseId);
  renderMessages();

  document.getElementById("clientDetailModal").classList.add("active");
}

function closeClientModal(){
  document.getElementById("clientDetailModal").classList.remove("active");
  currentClientId = null;
  selectedPhaseId = null;
  stepsByPhase = new Map();
  clientMessages = [];
}

/* =========================
   11) Phases (set current)
========================= */
function renderPhases(userId, currentPhase){
  const container = document.getElementById("phasesList");
  container.innerHTML = "";

  phases.forEach(ph => {
    const isActive = (ph.id === currentPhase);
    const isDone = (ph.id < currentPhase);

    const div = document.createElement("div");
    div.className = `phase-item ${isDone ? "completed" : (isActive ? "active" : "")}`;

    div.innerHTML = `
      <div style="flex:1;">
        <div class="phase-name">${ph.id}. ${escapeHTML(ph.name)}</div>
        <div class="phase-desc">${escapeHTML(ph.desc)}</div>
      </div>
      <div class="phase-actions">
        ${isDone ? `<button class="btn-small success" type="button" disabled>‚úì Conclu√≠da</button>` : ""}
        ${isActive ? `<button class="btn-small" type="button" disabled>Atual</button>` : `<button class="btn-small" type="button">Definir como atual</button>`}
      </div>
    `;

    // clique no card seleciona para editar passos
    div.addEventListener("click", (e)=>{
      // se clicar no bot√£o, evita duplicar
      if (e.target && e.target.tagName === "BUTTON") return;
      selectedPhaseId = ph.id;
      updateStepsHeader(selectedPhaseId);
      renderStepsEditor(selectedPhaseId);
    });

    const btn = div.querySelector(".phase-actions button:not([disabled])");
    if (btn){
      btn.addEventListener("click", async (e)=>{
        e.stopPropagation();
        await setClientPhase(userId, ph.id);
      });
    }

    container.appendChild(div);
  });
}

async function setClientPhase(userId, phaseId){
  hideNotice();
  setLoading(true, "Atualizando fase‚Ä¶");

  const nowIso = new Date().toISOString();

  const { data, error } = await sb
    .from("dni_process")
    .upsert({ user_id: userId, current_phase: phaseId, updated_at: nowIso }, { onConflict:"user_id" })
    .select("user_id, current_phase, updated_at")
    .single();

  if (error){
    showNotice("err", "N√£o consegui atualizar a fase. Confira pol√≠ticas RLS da tabela dni_process.");
    setLoading(false);
    return;
  }

  processMap.set(userId, data);

  renderStats();
  renderClients(document.getElementById("searchInput").value || "");

  if (currentClientId === userId){
    document.getElementById("detailPhase").textContent = `Fase ${phaseId}`;
    renderPhases(userId, phaseId);

    // ao mudar fase, tamb√©m seleciona ela pra editar passos
    selectedPhaseId = phaseId;
    updateStepsHeader(selectedPhaseId);
    renderStepsEditor(selectedPhaseId);
  }

  showNotice("ok", `Fase atualizada para Fase ${phaseId}.`);
  setLoading(false);
}

/* =========================
   12) Documents (view / approve / reject / remove)
========================= */
function docRowFor(userId, docType){
  const perUser = docsMap.get(userId);
  return perUser ? perUser.get(docType) : null;
}

function docStatusBadge(status){
  if (status === "approved") return { cls:"approved", txt:"‚úÖ Aprovado" };
  if (status === "rejected") return { cls:"rejected", txt:"‚ö†Ô∏è Rejeitado" };
  if (status === "uploaded") return { cls:"uploaded", txt:"‚úì Enviado" };
  return { cls:"pending", txt:"‚è≥ Pendente" };
}

function renderDocs(userId){
  const grid = document.getElementById("documentsGrid");
  grid.innerHTML = "";

  docsCatalog.forEach(dc => {
    const row = docRowFor(userId, dc.doc_type);

    const status = row?.status || "pending";
    const badge = docStatusBadge(status);

    const fileInfo = row?.storage_path
      ? `Arquivo: ${escapeHTML(filenameFromPath(row.storage_path))}`
      : "Sem envio ainda";

    const timeInfo = row?.uploaded_at ? `Enviado em ${fmtDate(row.uploaded_at)}` : "";

    const card = document.createElement("div");
    card.className = `doc-card ${status === "approved" ? "approved" : (status === "rejected" ? "rejected" : "")}`;

    card.innerHTML = `
      <div class="doc-header">
        <div class="doc-icon">${dc.icon}</div>
        <div class="doc-status ${badge.cls}">${badge.txt}</div>
      </div>
      <div class="doc-title">${escapeHTML(dc.name)}</div>
      <div class="doc-info">${fileInfo}${timeInfo ? "<br>"+timeInfo : ""}</div>
      <div class="doc-actions">
        <button class="btn-small" type="button" ${row?.storage_path ? "" : "disabled"}>üëÅÔ∏è Ver</button>
        <button class="btn-small success" type="button" ${row?.storage_path ? "" : "disabled"}>‚úì Aprovar</button>
        <button class="btn-small danger" type="button" ${row?.storage_path ? "" : "disabled"}>‚Ü∫ Rejeitar</button>
        <button class="btn-small danger" type="button" ${row?.storage_path ? "" : "disabled"}>‚úï Remover</button>
      </div>
      <div class="small" style="margin-top:8px; color:rgba(255,255,255,.55); font-weight:800;">
        Obs: "Remover" apaga do Storage e volta pra Pendente.
      </div>
    `;

    const [btnView, btnApprove, btnReject, btnRemove] = card.querySelectorAll("button");

    btnView.addEventListener("click", async ()=> {
      if (!row?.storage_path) return;
      await viewDoc(row.storage_path);
    });

    btnApprove.addEventListener("click", async ()=> {
      if (!row?.storage_path) return;
      await updateDocStatus(userId, dc.doc_type, "approved");
    });

    btnReject.addEventListener("click", async ()=> {
      if (!row?.storage_path) return;
      await updateDocStatus(userId, dc.doc_type, "rejected");
    });

    btnRemove.addEventListener("click", async ()=> {
      if (!row?.storage_path) return;
      const ok = confirm("Remover este arquivo? (Vai apagar do Storage)");
      if (!ok) return;
      await removeDocFile(userId, dc.doc_type, row.storage_path);
    });

    grid.appendChild(card);
  });
}

async function viewDoc(storagePath){
  hideNotice();
  setLoading(true, "Abrindo arquivo‚Ä¶");

  const { data, error } = await sb
    .storage
    .from("documents")
    .createSignedUrl(storagePath, 60);

  if (error || !data?.signedUrl){
    showNotice("err", "N√£o consegui gerar link para visualizar.");
    setLoading(false);
    return;
  }

  window.open(data.signedUrl, "_blank", "noopener,noreferrer");
  setLoading(false);
}

async function updateDocStatus(userId, docType, status){
  hideNotice();
  setLoading(true, "Atualizando documento‚Ä¶");

  const nowIso = new Date().toISOString();
  const patch = { status, approved_at: status === "approved" ? nowIso : null };

  const { data, error } = await sb
    .from("documents")
    .update(patch)
    .eq("user_id", userId)
    .eq("doc_type", docType)
    .select("user_id, doc_type, status, storage_path, uploaded_at, approved_at")
    .single();

  if (error){
    showNotice("err", "N√£o consegui atualizar status do documento. Confira RLS na tabela documents.");
    setLoading(false);
    return;
  }

  if (!docsMap.has(userId)) docsMap.set(userId, new Map());
  docsMap.get(userId).set(docType, data);

  renderClients(document.getElementById("searchInput").value || "");
  if (currentClientId === userId) renderDocs(userId);

  showNotice("ok", status === "approved" ? "Documento aprovado." : "Documento rejeitado.");
  setLoading(false);
}

async function removeDocFile(userId, docType, storagePath){
  hideNotice();
  setLoading(true, "Removendo arquivo‚Ä¶");

  const { error: rmErr } = await sb.storage.from("documents").remove([storagePath]);
  if (rmErr){
    showNotice("err", "N√£o consegui remover do Storage.");
    setLoading(false);
    return;
  }

  const { data, error } = await sb
    .from("documents")
    .update({ storage_path:null, status:"pending", uploaded_at:null, approved_at:null })
    .eq("user_id", userId)
    .eq("doc_type", docType)
    .select("user_id, doc_type, status, storage_path, uploaded_at, approved_at")
    .single();

  if (error){
    showNotice("err", "Removido do Storage, mas falhou ao atualizar no banco.");
    setLoading(false);
    return;
  }

  if (!docsMap.has(userId)) docsMap.set(userId, new Map());
  docsMap.get(userId).set(docType, data);

  renderClients(document.getElementById("searchInput").value || "");
  if (currentClientId === userId) renderDocs(userId);

  showNotice("ok", "Arquivo removido e status voltou para Pendente.");
  setLoading(false);
}

/* =========================
   13) Notes (admin_notes)
========================= */
async function loadNotesForCurrentClient(){
  if (!currentClientId) return;
  document.getElementById("clientNotes").value = "";

  const { data, error } = await sb
    .from("admin_notes")
    .select("user_id, notes, updated_at")
    .eq("user_id", currentClientId)
    .maybeSingle();

  // se n√£o existir linha, OK
  if (error) return;

  document.getElementById("clientNotes").value = data?.notes || "";
}

async function saveNotes(){
  if (!currentClientId) return;
  hideNotice();
  setLoading(true, "Salvando notas‚Ä¶");

  const notes = document.getElementById("clientNotes").value || "";
  const nowIso = new Date().toISOString();

  const { error } = await sb
    .from("admin_notes")
    .upsert({ user_id: currentClientId, notes, updated_at: nowIso }, { onConflict:"user_id" });

  if (error){
    showNotice("err", "Falha ao salvar notas. Prov√°vel: tabela admin_notes n√£o existe ou RLS bloqueando.");
    setLoading(false);
    return;
  }

  showNotice("ok", "Notas salvas!");
  setLoading(false);
}

/* =========================
   14) Steps (phase_steps)
========================= */
function updateStepsHeader(phaseId){
  const t = document.getElementById("stepsPhaseTitle");
  const sub = document.getElementById("stepsPhaseSub");

  if (!phaseId){
    t.textContent = "Selecione uma fase";
    sub.textContent = "Clique em uma fase ao lado para editar os passos dela.";
    return;
  }

  const ph = phases.find(p => p.id === phaseId);
  t.textContent = `Fase ${phaseId}: ${ph ? ph.name : ""}`;
  sub.textContent = "Edite t√≠tulo/descri√ß√£o, marque como conclu√≠do e envie novos passos.";
}

async function loadStepsForClient(userId){
  stepsByPhase = new Map();

  const { data, error } = await sb
    .from("phase_steps")
    .select("id, user_id, phase_number, step_number, step_title, step_description, is_completed, completed_at, created_at, updated_at")
    .eq("user_id", userId)
    .order("phase_number", { ascending:true })
    .order("step_number", { ascending:true });

  if (error){
    // se RLS ou tabela n√£o existir, editor fica vazio
    return;
  }

  (data || []).forEach(r => {
    if (!stepsByPhase.has(r.phase_number)) stepsByPhase.set(r.phase_number, []);
    stepsByPhase.get(r.phase_number).push(r);
  });
}

function renderStepsEditor(phaseId){
  const list = document.getElementById("stepsList");
  list.innerHTML = "";

  // desabilita bot√µes se n√£o houver fase selecionada
  document.getElementById("seedStepsBtn").disabled = !phaseId;
  document.getElementById("addStepBtn").disabled = !phaseId;
  document.getElementById("reloadStepsBtn").disabled = !currentClientId;

  if (!phaseId){
    list.innerHTML = `
      <div class="step-row" style="text-align:center;">
        <div class="small" style="color:rgba(255,255,255,.7); font-weight:900;">
          Selecione uma fase para ver/editar os passos.
        </div>
      </div>
    `;
    return;
  }

  const rows = stepsByPhase.get(phaseId) || [];

  if (!rows.length){
    list.innerHTML = `
      <div class="step-row" style="text-align:center;">
        <div class="small" style="color:rgba(255,255,255,.7); font-weight:900;">
          Nenhum passo criado no banco para esta fase.
        </div>
        <div class="small" style="margin-top:6px; color:rgba(255,255,255,.55); font-weight:800;">
          Clique em <b>‚ú® Gerar passos padr√£o</b> ou <b>‚ûï Adicionar passo</b>.
        </div>
      </div>
    `;
    return;
  }

  rows.forEach(step => {
    const isDone = !!step.is_completed;

    const card = document.createElement("div");
    card.className = "step-row";
    card.innerHTML = `
      <div class="step-top">
        <div style="flex:1;">
          <div class="small" style="font-weight:950; color:rgba(255,255,255,.9);">
            Passo ${step.step_number}
          </div>
          <div class="small" style="margin-top:2px; color:rgba(255,255,255,.55);">
            ${step.updated_at ? "Atualizado: " + fmtDate(step.updated_at) : ""}
          </div>
        </div>
        <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; align-items:center;">
          <span class="step-badge ${isDone ? "done" : "pending"}">${isDone ? "‚úì Conclu√≠do" : "‚è≥ Pendente"}</span>
        </div>
      </div>

      <div class="step-fields">
        <input class="input" data-k="title" value="${escapeHTML(step.step_title || "")}" placeholder="T√≠tulo do passo" />
        <textarea class="notes-area" data-k="desc" style="min-height:90px;" placeholder="Descri√ß√£o (opcional)">${escapeHTML(step.step_description || "")}</textarea>

        <label class="checkbox-row">
          <input type="checkbox" data-k="done" ${isDone ? "checked" : ""} />
          Marcar como conclu√≠do
        </label>
      </div>

      <div class="step-actions">
        <button class="btn-small" type="button" data-action="save">Salvar</button>
        <button class="btn-small danger" type="button" data-action="delete">Excluir</button>
      </div>
    `;

    const titleEl = card.querySelector('[data-k="title"]');
    const descEl = card.querySelector('[data-k="desc"]');
    const doneEl = card.querySelector('[data-k="done"]');

    card.querySelector('[data-action="save"]').addEventListener("click", async ()=>{
      await saveStep(step.id, {
        step_title: titleEl.value || "",
        step_description: descEl.value || "",
        is_completed: !!doneEl.checked
      });
    });

    card.querySelector('[data-action="delete"]').addEventListener("click", async ()=>{
      const ok = confirm("Excluir este passo? (isso remove do banco)");
      if (!ok) return;
      await deleteStep(step.id);
    });

    // salvar status rapidamente ao marcar/desmarcar
    doneEl.addEventListener("change", async ()=>{
      await saveStep(step.id, {
        step_title: titleEl.value || "",
        step_description: descEl.value || "",
        is_completed: !!doneEl.checked
      }, true);
    });

    list.appendChild(card);
  });
}

async function seedDefaultSteps(userId, phaseId){
  hideNotice();
  setLoading(true, "Gerando passos padr√£o‚Ä¶");

  const existing = stepsByPhase.get(phaseId) || [];
  if (existing.length){
    setLoading(false);
    showNotice("err", "J√° existem passos nesta fase. Exclua ou edite os existentes.");
    return;
  }

  const items = defaultSteps[phaseId] || [];
  if (!items.length){
    setLoading(false);
    showNotice("err", "N√£o h√° passos padr√£o configurados para esta fase.");
    return;
  }

  const payload = items.map((it, idx) => ({
    user_id: userId,
    phase_number: phaseId,
    step_number: idx + 1,
    step_title: it.title,
    step_description: it.desc || "",
    is_completed: false,
    completed_at: null
  }));

  const { error } = await sb
    .from("phase_steps")
    .upsert(payload, { onConflict: "user_id,phase_number,step_number" });

  if (error){
    showNotice("err", "Falha ao criar passos. Verifique RLS/policies da tabela phase_steps.");
    setLoading(false);
    return;
  }

  await loadStepsForClient(userId);
  renderStepsEditor(phaseId);
  showNotice("ok", "Passos padr√£o criados!");
  setLoading(false);
}

async function addNewStep(userId, phaseId){
  const title = prompt("T√≠tulo do novo passo:");
  if (!title) return;

  const desc = prompt("Descri√ß√£o (opcional):") || "";

  hideNotice();
  setLoading(true, "Criando passo‚Ä¶");

  const rows = stepsByPhase.get(phaseId) || [];
  const maxNum = rows.reduce((acc, r) => Math.max(acc, r.step_number || 0), 0);
  const nextNum = maxNum + 1;

  const { error } = await sb
    .from("phase_steps")
    .insert({
      user_id: userId,
      phase_number: phaseId,
      step_number: nextNum,
      step_title: title,
      step_description: desc,
      is_completed: false,
      completed_at: null
    });

  if (error){
    showNotice("err", "Falha ao criar passo. Verifique RLS/policies ou conflito de step_number.");
    setLoading(false);
    return;
  }

  await loadStepsForClient(userId);
  renderStepsEditor(phaseId);
  showNotice("ok", "Passo criado!");
  setLoading(false);
}

async function saveStep(stepId, patch, silent=false){
  if (!currentClientId || !selectedPhaseId) return;

  const nowIso = new Date().toISOString();
  const finalPatch = {
    step_title: patch.step_title,
    step_description: patch.step_description,
    is_completed: !!patch.is_completed,
    completed_at: patch.is_completed ? nowIso : null
  };

  if (!silent){
    hideNotice();
    setLoading(true, "Salvando passo‚Ä¶");
  }

  const { error } = await sb
    .from("phase_steps")
    .update(finalPatch)
    .eq("id", stepId);

  if (error){
    if (!silent) setLoading(false);
    showNotice("err", "Falha ao salvar passo. Verifique RLS/policies.");
    return;
  }

  await loadStepsForClient(currentClientId);
  renderStepsEditor(selectedPhaseId);

  if (!silent){
    showNotice("ok", "Passo salvo!");
    setLoading(false);
  }
}

async function deleteStep(stepId){
  if (!currentClientId || !selectedPhaseId) return;

  hideNotice();
  setLoading(true, "Excluindo passo‚Ä¶");

  const { error } = await sb
    .from("phase_steps")
    .delete()
    .eq("id", stepId);

  if (error){
    showNotice("err", "Falha ao excluir passo. Verifique RLS/policies.");
    setLoading(false);
    return;
  }

  await loadStepsForClient(currentClientId);
  renderStepsEditor(selectedPhaseId);

  showNotice("ok", "Passo exclu√≠do!");
  setLoading(false);
}

/* =========================
   15) Messages (client_messages)
========================= */
async function loadMessagesForClient(userId){
  clientMessages = [];
  const { data, error } = await sb
    .from("client_messages")
    .select("id, user_id, title, message, message_type, is_read, created_at")
    .eq("user_id", userId)
    .order("created_at", { ascending:false })
    .limit(30);

  if (error) return;
  clientMessages = data || [];
}

function renderMessages(){
  const list = document.getElementById("msgList");
  list.innerHTML = "";

  if (!currentClientId){
    list.innerHTML = `<div class="small" style="color:rgba(255,255,255,.7); font-weight:900;">Selecione um cliente.</div>`;
    return;
  }

  if (!clientMessages.length){
    list.innerHTML = `
      <div class="msg-item" style="text-align:center;">
        <div class="small" style="color:rgba(255,255,255,.7); font-weight:900;">Nenhuma mensagem enviada ainda.</div>
      </div>
    `;
    return;
  }

  clientMessages.forEach(m => {
    const type = (m.message_type || "info");
    const readTag = m.is_read ? "read" : "unread";

    const div = document.createElement("div");
    div.className = "msg-item";
    div.innerHTML = `
      <div class="msg-head">
        <div style="flex:1;">
          <div class="msg-title">${escapeHTML(m.title || "(Sem t√≠tulo)")}</div>
          <div class="msg-meta">${fmtDate(m.created_at)}</div>
        </div>
        <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; align-items:center;">
          <span class="tag ${type}">${escapeHTML(type)}</span>
          <span class="tag ${readTag}">${m.is_read ? "Lida" : "Nova"}</span>
          <button class="btn-small danger" type="button" data-action="del">Apagar</button>
        </div>
      </div>
      <div class="msg-body">${escapeHTML(m.message || "")}</div>
    `;

    div.querySelector('[data-action="del"]').addEventListener("click", async ()=>{
      const ok = confirm("Apagar esta mensagem?");
      if (!ok) return;
      await deleteMessage(m.id);
    });

    list.appendChild(div);
  });
}

async function sendMessageToClient(){
  if (!currentClientId) return;

  const title = (document.getElementById("msgTitle").value || "").trim();
  const message = (document.getElementById("msgBody").value || "").trim();
  const message_type = document.getElementById("msgType").value || "info";

  if (!title || !message){
    showNotice("err", "Preencha t√≠tulo e mensagem.");
    return;
  }

  hideNotice();
  setLoading(true, "Enviando mensagem‚Ä¶");

  const { error } = await sb
    .from("client_messages")
    .insert({
      user_id: currentClientId,
      title,
      message,
      message_type,
      is_read: false
    });

  if (error){
    showNotice("err", "Falha ao enviar. Verifique RLS/policies da tabela client_messages.");
    setLoading(false);
    return;
  }

  document.getElementById("msgTitle").value = "";
  document.getElementById("msgBody").value = "";
  document.getElementById("msgType").value = "info";

  await loadMessagesForClient(currentClientId);
  renderMessages();

  showNotice("ok", "Mensagem enviada!");
  setLoading(false);
}

async function deleteMessage(msgId){
  hideNotice();
  setLoading(true, "Apagando mensagem‚Ä¶");

  const { error } = await sb
    .from("client_messages")
    .delete()
    .eq("id", msgId);

  if (error){
    showNotice("err", "Falha ao apagar mensagem. Verifique RLS/policies.");
    setLoading(false);
    return;
  }

  await loadMessagesForClient(currentClientId);
  renderMessages();

  showNotice("ok", "Mensagem apagada!");
  setLoading(false);
}

/* =========================
   16) New client modal
========================= */
function openNewClientModal(){
  document.getElementById("newClientModal").classList.add("active");
}
function closeNewClientModal(){
  document.getElementById("newClientModal").classList.remove("active");
}

/* =========================
   Start
========================= */
init();
</script>
</body>
</html>
