<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard | GoArgentina</title>
  <meta name="description" content="√Årea do cliente GoArgentina ‚Äî acompanhe seu processo de DNI por fases e passos, envie documentos e receba mensagens." />

  <style>
    *{ margin:0; padding:0; box-sizing:border-box; }

    :root{
      --blue-900:#0A0E27;
      --blue-800:#0F1B3D;
      --blue-700:#17306A;
      --blue-600:#1F4ED1;
      --blue-500:#2A6BFF;
      --yellow-500:#FFD500;
      --yellow-400:#FFE36D;
      --bg:#F5F7FB;
      --card:#FFFFFF;
      --text:#0D1220;
      --muted:rgba(13,18,32,.65);
      --line:rgba(13,18,32,.10);
      --ring:rgba(42,107,255,.22);
      --radius:16px;
    }

    html,body{ height:100%; }
    body{
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background: radial-gradient(1200px 700px at 15% 10%, rgba(42,107,255,.12), transparent 55%),
                  radial-gradient(900px 600px at 90% 20%, rgba(255,213,0,.10), transparent 55%),
                  var(--bg);
      color:var(--text);
      line-height:1.55;
    }

    a{ color:inherit; text-decoration:none; }
    .wrap{ max-width:1100px; margin:0 auto; padding:18px; }

    /* Header */
    .topbar{
      position:sticky;
      top:0;
      z-index:30;
      backdrop-filter: blur(10px);
      background: rgba(245,247,251,.72);
      border-bottom:1px solid rgba(13,18,32,.06);
    }
    .topbar-inner{
      max-width:1100px;
      margin:0 auto;
      padding:14px 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      user-select:none;
    }
    .logo{
      width:34px;
      height:34px;
      border-radius:12px;
      background: linear-gradient(135deg, var(--yellow-500), var(--blue-500));
      box-shadow: 0 10px 26px rgba(0,0,0,.12);
    }
    .brand h1{
      font-size:14px;
      font-weight:900;
      letter-spacing:-0.2px;
      margin:0;
    }
    .brand small{
      display:block;
      font-size:11px;
      color:var(--muted);
      font-weight:700;
      margin-top:-2px;
    }

    .user{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .avatar{
      width:36px;
      height:36px;
      border-radius:14px;
      display:grid;
      place-items:center;
      font-weight:900;
      background: linear-gradient(135deg, rgba(42,107,255,.20), rgba(255,213,0,.20));
      border:1px solid rgba(13,18,32,.10);
      color: rgba(13,18,32,.85);
    }
    .user-meta{
      display:flex;
      flex-direction:column;
      line-height:1.1;
      max-width: 240px;
    }
    .user-name{
      font-weight:950;
      font-size:12px;
      letter-spacing:-0.1px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .user-email{
      font-weight:700;
      font-size:11px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .btn{
      border:none;
      cursor:pointer;
      font-weight:900;
      border-radius:999px;
      padding:10px 14px;
      font-size:12px;
      letter-spacing:-0.1px;
      display:inline-flex;
      gap:8px;
      align-items:center;
      justify-content:center;
      transition: all .2s ease;
      background: rgba(13,18,32,.06);
      color: rgba(13,18,32,.85);
      border:1px solid rgba(13,18,32,.10);
    }
    .btn:hover{
      transform: translateY(-1px);
      box-shadow: 0 16px 30px rgba(13,18,32,.10);
      border-color: rgba(23,48,106,.22);
    }
    .btn.primary{
      background: linear-gradient(135deg, var(--blue-500), var(--blue-700));
      color:#fff;
      border:none;
      box-shadow: 0 18px 38px rgba(42,107,255,.20);
    }
    .btn.primary:hover{ box-shadow: 0 20px 44px rgba(42,107,255,.26); }
    .btn:disabled{ opacity:.55; cursor:not-allowed; transform:none; box-shadow:none; }

    /* Tabs */
    .tabs{
      display:flex;
      gap:10px;
      flex-wrap: wrap;
      padding: 16px 0 10px 0;
    }
    .tab-btn{
      position:relative;
      padding: 10px 14px;
      border-radius: 999px;
      border:1px solid rgba(13,18,32,.10);
      background: rgba(255,255,255,.75);
      font-weight:950;
      font-size:12px;
      cursor:pointer;
      transition:.18s ease;
      display:inline-flex;
      align-items:center;
      gap:8px;
      color: rgba(13,18,32,.86);
    }
    .tab-btn:hover{
      transform: translateY(-1px);
      box-shadow: 0 14px 26px rgba(13,18,32,.10);
      border-color: rgba(23,48,106,.18);
    }
    .tab-btn.active{
      background: linear-gradient(135deg, rgba(42,107,255,.16), rgba(255,213,0,.14));
      border-color: rgba(42,107,255,.22);
      box-shadow: 0 18px 36px rgba(42,107,255,.10);
    }

    .badge{
      font-size:10px;
      font-weight:950;
      padding: 4px 8px;
      border-radius:999px;
      background: rgba(239,68,68,.10);
      border:1px solid rgba(239,68,68,.18);
      color: rgba(145, 25, 25, .95);
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .badge.blue{
      background: rgba(42,107,255,.10);
      border-color: rgba(42,107,255,.18);
      color: rgba(23,48,106,.92);
    }

    /* Cards / Sections */
    .section{ display:none; }
    .section.active{ display:block; }

    .grid{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap: 16px;
      margin-top: 10px;
    }
    @media (max-width: 920px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      background: rgba(255,255,255,.82);
      border:1px solid rgba(13,18,32,.08);
      border-radius: calc(var(--radius) + 6px);
      box-shadow: 0 22px 46px rgba(13,18,32,.06);
      overflow:hidden;
    }
    .card-head{
      padding: 18px 18px 12px 18px;
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      border-bottom:1px solid rgba(13,18,32,.06);
      background: linear-gradient(180deg, rgba(255,255,255,.85), rgba(246,247,251,.85));
    }
    .card-title{
      font-weight:950;
      letter-spacing:-0.2px;
      font-size:14px;
    }
    .card-sub{
      color:var(--muted);
      font-weight:650;
      font-size:12px;
      margin-top:4px;
    }
    .card-body{ padding: 16px 18px 18px 18px; }

    .notice{
      display:none;
      margin: 12px 0;
      padding: 12px 14px;
      border-radius: 14px;
      font-weight:800;
      font-size: 13px;
      border: 1px solid rgba(13,18,32,.10);
      background: rgba(255,255,255,.70);
    }
    .notice.show{ display:block; }
    .notice.ok{
      border-color: rgba(16,185,129,.22);
      background: rgba(16,185,129,.08);
      color: rgba(10, 93, 64, .95);
    }
    .notice.err{
      border-color: rgba(239,68,68,.22);
      background: rgba(239,68,68,.08);
      color: rgba(128, 24, 24, .95);
    }

    /* Process timeline */
    .phases{
      display:flex;
      gap: 10px;
      overflow:auto;
      padding: 10px 2px 2px 2px;
    }
    .phase-item{
      min-width: 190px;
      padding: 14px 14px;
      border-radius: 18px;
      border: 1px solid rgba(13,18,32,.10);
      background: rgba(255,255,255,.80);
      transition: .18s ease;
      position:relative;
    }
    .phase-item:hover{
      transform: translateY(-2px);
      box-shadow: 0 18px 36px rgba(13,18,32,.10);
      border-color: rgba(23,48,106,.16);
    }
    .phase-item.active{
      border-color: rgba(42,107,255,.24);
      background: linear-gradient(135deg, rgba(42,107,255,.14), rgba(255,213,0,.10));
      box-shadow: 0 22px 44px rgba(42,107,255,.12);
    }
    .phase-marker{
      width: 34px;
      height: 34px;
      border-radius: 14px;
      display:grid;
      place-items:center;
      font-weight:950;
      background: rgba(42,107,255,.12);
      border:1px solid rgba(42,107,255,.16);
      margin-bottom: 8px;
    }
    .phase-name{
      font-weight:950;
      font-size: 13px;
      letter-spacing:-0.15px;
    }
    .phase-desc{
      margin-top: 4px;
      font-size: 12px;
      color: var(--muted);
      font-weight: 650;
    }

    /* Vertical step box */
    .steps{
      display:flex;
      flex-direction:column;
      gap: 10px;
    }
    .step{
      display:flex;
      gap: 10px;
      padding: 12px 12px;
      border-radius: 16px;
      border: 1px solid rgba(13,18,32,.10);
      background: rgba(255,255,255,.80);
      align-items:flex-start;
    }
    .dot{
      width: 18px;
      height: 18px;
      border-radius: 999px;
      border: 2px solid rgba(13,18,32,.16);
      margin-top: 3px;
      flex:0 0 auto;
    }
    .step.done .dot{
      border-color: rgba(16,185,129,.45);
      background: rgba(16,185,129,.22);
    }
    .step.active .dot{
      border-color: rgba(42,107,255,.55);
      box-shadow: 0 0 0 6px rgba(42,107,255,.14);
      background: rgba(42,107,255,.14);
    }
    .step-title{
      font-weight:900;
      font-size: 12px;
      color: rgba(13,18,32,.88);
    }
    .step-sub{
      color: var(--muted);
      font-weight:650;
      font-size: 12px;
      margin-top: 2px;
    }

    /* Documents grid */
    .docs-grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
    }
    @media (max-width: 820px){
      .docs-grid{ grid-template-columns: 1fr; }
    }
    .doc-card{
      border-radius: 18px;
      border: 1px solid rgba(13,18,32,.10);
      background: rgba(255,255,255,.80);
      padding: 14px 14px;
      position:relative;
      overflow:hidden;
    }
    .doc-card.approved{
      border-color: rgba(16,185,129,.22);
      background: linear-gradient(180deg, rgba(16,185,129,.09) 0%, #fff 100%);
    }
    .doc-card.rejected{
      border-color: rgba(239,68,68,.22);
      background: linear-gradient(180deg, rgba(239,68,68,.07) 0%, #fff 100%);
    }
    .doc-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap: 10px;
      margin-bottom: 10px;
    }
    .doc-icon{ font-size: 28px; }
    .doc-title{
      font-size: 13px;
      font-weight: 950;
      letter-spacing: -0.15px;
      margin-bottom: 6px;
    }
    .doc-info{
      font-size: 12px;
      font-weight: 650;
      color: var(--muted);
      margin-bottom: 10px;
    }
    .doc-status{
      font-size: 11px;
      font-weight: 950;
      padding: 5px 11px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(246,247,251,.65);
      white-space: nowrap;
      color: rgba(13,18,32,.76);
    }
    .doc-status.pending{
      border-color: rgba(245,158,11,.20);
      background: rgba(245,158,11,.10);
      color: rgba(145, 92, 18, .95);
    }
    .doc-status.uploaded{
      border-color: rgba(16,185,129,.18);
      background: rgba(16,185,129,.08);
      color: rgba(10, 93, 64, .95);
    }
    .doc-status.approved{
      border-color: rgba(16,185,129,.22);
      background: rgba(16,185,129,.10);
      color: rgba(10, 93, 64, .95);
    }
    .doc-status.rejected{
      border-color: rgba(239,68,68,.20);
      background: rgba(239,68,68,.08);
      color: rgba(128, 24, 24, .95);
    }

    .input{
      width:100%;
      padding: 11px 12px;
      border-radius: 12px;
      background: rgba(246,247,251,.75);
      border: 1px solid var(--line);
      color: var(--text);
      font-weight: 650;
      font-size: 14px;
      transition: .15s ease;
    }
    .input:focus{
      outline:none;
      border-color: rgba(23,48,106,.32);
      box-shadow: 0 0 0 4px var(--ring);
      background: #fff;
    }

    .doc-actions{
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    .btn-small{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap: 8px;
      padding: 9px 11px;
      font-size: 12px;
      font-weight: 900;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: #fff;
      cursor:pointer;
      transition: all .2s ease;
    }
    .btn-small:hover{
      transform: translateY(-1px);
      box-shadow: 0 12px 26px rgba(13,18,32,.08);
      border-color: rgba(23,48,106,.22);
    }
    .btn-small.danger:hover{
      border-color: rgba(239,68,68,.22);
      background: rgba(239,68,68,.06);
    }
    .btn-small:disabled{
      opacity: .45;
      cursor:not-allowed;
      transform:none;
      box-shadow:none;
    }

    /* Inbox */
    .inbox-top{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 12px;
      flex-wrap: wrap;
    }
    #inboxBadge{
      display:none;
    }
    .empty-state{
      text-align:center;
      padding: 36px 14px;
      border: 1px dashed rgba(13,18,32,.18);
      border-radius: calc(var(--radius) + 4px);
      background: rgba(246,247,251,.65);
      color: rgba(13,18,32,.66);
      font-weight: 750;
    }

    .small{
      font-size: 12px;
      color: rgba(13,18,32,.72);
      font-weight: 650;
    }
    .footer-note{
      font-size: 11px;
      color: rgba(13,18,32,.58);
      font-weight: 650;
    }

    /* Loading */
    .loading{
      position: fixed;
      inset: 0;
      display:flex;
      align-items:center;
      justify-content:center;
      background: rgba(245,247,251,.78);
      backdrop-filter: blur(10px);
      z-index: 50;
    }
    .loading.hidden{ display:none; }
    .loading-card{
      width: min(520px, 92vw);
      border-radius: 22px;
      border:1px solid rgba(13,18,32,.10);
      background: rgba(255,255,255,.85);
      box-shadow: 0 26px 60px rgba(13,18,32,.16);
      padding: 18px 18px;
      display:flex;
      gap: 14px;
      align-items:center;
    }
    .spinner{
      width: 26px;
      height: 26px;
      border-radius: 999px;
      border: 3px solid rgba(13,18,32,.10);
      border-top-color: rgba(42,107,255,.85);
      animation: spin 1s linear infinite;
      flex:0 0 auto;
    }
    @keyframes spin{ to{ transform: rotate(360deg); } }
    .loading-text{
      font-weight:900;
      color: rgba(13,18,32,.86);
      letter-spacing:-0.15px;
    }

    /* Preview modal (in-page file viewer) */
    .modal{
      position: fixed;
      inset: 0;
      z-index: 1000;
      display: grid;
      place-items: center;
      padding: 18px;
    }
    .modal.hidden{ display:none; }
    .modal-backdrop{
      position:absolute;
      inset:0;
      background: rgba(10,14,39,.62);
      backdrop-filter: blur(8px);
    }
    .modal-card{
      position: relative;
      width: min(980px, 100%);
      max-height: min(82vh, 780px);
      display:flex;
      flex-direction: column;
      border-radius: calc(var(--radius) + 10px);
      border: 1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(255,255,255,.98) 0%, rgba(246,247,251,.98) 100%);
      box-shadow: 0 28px 80px rgba(0,0,0,.28);
      overflow:hidden;
    }
    .modal-header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
      padding: 14px 14px 12px 14px;
      border-bottom: 1px solid rgba(13,18,32,.10);
      background: rgba(255,255,255,.75);
    }
    .modal-kicker{
      font-size: 11px;
      font-weight: 900;
      color: rgba(13,18,32,.55);
      letter-spacing: .16px;
      text-transform: uppercase;
      margin-bottom: 2px;
    }
    .modal-title{
      font-size: 15px;
      font-weight: 950;
      letter-spacing: -0.2px;
      color: rgba(13,18,32,.92);
      max-width: 70ch;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .icon-btn{
      border: 1px solid rgba(13,18,32,.12);
      background: rgba(255,255,255,.85);
      width: 38px;
      height: 38px;
      border-radius: 12px;
      cursor:pointer;
      font-size: 16px;
      font-weight: 950;
      display:grid;
      place-items:center;
      transition: .18s ease;
    }
    .icon-btn:hover{
      transform: translateY(-1px);
      box-shadow: 0 14px 26px rgba(13,18,32,.12);
      border-color: rgba(23,48,106,.22);
    }
    .modal-body{
      padding: 12px 14px;
      overflow:auto;
    }
    .preview-frame{
      width: 100%;
      height: min(64vh, 560px);
      border: 1px solid rgba(13,18,32,.12);
      border-radius: 16px;
      background: #fff;
      overflow:hidden;
    }
    .preview-img{
      width: 100%;
      height: auto;
      display:block;
      border: 1px solid rgba(13,18,32,.12);
      border-radius: 16px;
      background:#fff;
    }
    .modal-footer{
      padding: 12px 14px 14px 14px;
      border-top: 1px solid rgba(13,18,32,.10);
      background: rgba(255,255,255,.75);
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content:flex-end;
    }
  </style>
</head>
<body>

  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>GoArgentina</h1>
          <small>DNI sem drama üá¶üá∑</small>
        </div>
      </div>

      <div class="user">
        <div class="avatar" id="userAvatar">CL</div>
        <div class="user-meta">
          <div class="user-name" id="userName">Carregando‚Ä¶</div>
          <div class="user-email" id="userEmail">‚Äî</div>
        </div>
        <button class="btn" id="logoutBtn" type="button">Sair</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="notice" id="noticeBox"></div>

    <div class="tabs" role="tablist" aria-label="Navega√ß√£o do painel">
      <button class="tab-btn active" data-tab="process" role="tab" aria-selected="true">
        üß≠ Processo <span class="badge blue" id="progressBadge">Fase ‚Äî</span>
      </button>
      <button class="tab-btn" data-tab="docs" role="tab" aria-selected="false">
        üìé Documentos
      </button>
      <button class="tab-btn" data-tab="support" role="tab" aria-selected="false">
        üí¨ Suporte <span class="badge" id="supportBadge" style="display:none;">0</span>
      </button>
    </div>

    <main>
      <!-- PROCESSO -->
      <section class="section active" id="tab-process">
        <div class="grid">
          <div class="card">
            <div class="card-head">
              <div>
                <div class="card-title">Seu progresso</div>
                <div class="card-sub">As 7 fases do DNI ‚Äî com passos claros</div>
              </div>
              <div class="badge blue" id="progressPill">Fase ‚Äî</div>
            </div>
            <div class="card-body">
              <div class="phases" id="phasesRow"></div>

              <div class="footer-note" style="margin-top:10px;">
                Dica: as fases s√£o atualizadas pela nossa equipe. Voc√™ acompanha tudo aqui üôÇ
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-head">
              <div>
                <div class="card-title">Fase atual</div>
                <div class="card-sub" id="currentPhaseDesc">‚Äî</div>
              </div>
              <div class="badge blue" id="currentPhaseBadge">‚Äî</div>
            </div>
            <div class="card-body">
              <div class="steps" id="timelineVertical"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- DOCUMENTOS -->
      <section class="section" id="tab-docs">
        <div class="card">
          <div class="card-head">
            <div>
              <div class="card-title">Envio de documentos</div>
              <div class="card-sub">Envie seus arquivos com seguran√ßa e acompanhe o status.</div>
            </div>
          </div>
          <div class="card-body">
            <div class="docs-grid" id="documentsGrid"></div>

            <div class="footer-note" style="margin-top:10px;">
              Ap√≥s enviar: status vira "Enviado". Depois a equipe pode aprovar ou rejeitar.
            </div>
          </div>
        </div>
      </section>

      <!-- SUPORTE -->
      <section class="section" id="tab-support">
        <div class="card">
          <div class="card-head">
            <div class="inbox-top">
              <div>
                <div class="card-title">Mensagens</div>
                <div class="card-sub">Atualiza√ß√µes e avisos da equipe GoArgentina.</div>
              </div>

              <div class="badge" id="inboxBadge">0</div>
            </div>
          </div>
          <div class="card-body">
            <div id="inboxEmpty" class="empty-state">Sem mensagens por aqui ainda üôÇ</div>
            <div class="docs-grid" id="inboxList"></div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <div class="loading hidden" id="loading" aria-live="polite" aria-busy="true">
    <div class="loading-card">
      <div class="spinner" aria-hidden="true"></div>
      <div class="loading-text" id="loadingText">Carregando‚Ä¶</div>
    </div>
  </div>

  <!-- Preview Modal -->
  <div id="previewModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="previewTitle">
    <div class="modal-backdrop" data-close="1"></div>
    <div class="modal-card" role="document">
      <div class="modal-header">
        <div style="min-width:0;">
          <div class="modal-kicker">Visualiza√ß√£o</div>
          <div id="previewTitle" class="modal-title">Arquivo</div>
        </div>
        <button id="previewClose" class="icon-btn" type="button" aria-label="Fechar">‚úï</button>
      </div>
      <div class="modal-body">
        <div id="previewBody"></div>
      </div>
      <div class="modal-footer">
        <a id="previewDownload" class="btn-small" href="#" target="_blank" rel="noopener noreferrer">‚¨áÔ∏è Baixar</a>
        <a id="previewOpenNew" class="btn-small" href="#" target="_blank" rel="noopener noreferrer">‚ÜóÔ∏è Abrir em nova guia</a>
      </div>
    </div>
  </div>

  <!-- vers√£o travada para evitar que mudan√ßas do CDN quebrem o site -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.93.2"></script>

  <script>
    const SUPABASE_URL = "https://gqtkhimnfphllvtxkmjl.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdxdGtoaW1uZnBobGx2dHhrbWpsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkwNTg5MDAsImV4cCI6MjA4NDYzNDkwMH0.I7GOmBZsUtyxuPxzhcg3i5qaDuIFWBHHNtlZS65Qt_k";

    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { persistSession:true, autoRefreshToken:true, detectSessionInUrl:true }
    });

    const loadingEl = document.getElementById("loading");
    const loadingText = document.getElementById("loadingText");
    const noticeBox = document.getElementById("noticeBox");

    function setLoading(show, text){
      if (text) loadingText.textContent = text;
      loadingEl.classList.toggle("hidden", !show);
    }

    function showNotice(type, msg){
      noticeBox.className = "notice show " + (type==="ok" ? "ok" : "err");
      noticeBox.textContent = msg;
    }
    function hideNotice(){
      noticeBox.className = "notice";
      noticeBox.textContent = "";
    }
    function fmtDate(dt){
      if (!dt) return "-";
      try { return new Date(dt).toLocaleString("pt-BR"); } catch { return "-"; }
    }

    function initials(nameOrEmail){
      const s = (nameOrEmail || "CL").trim();
      const parts = s.split(" ").filter(Boolean);
      if (parts.length >= 2) return (parts[0][0] + parts[1][0]).toUpperCase();
      return (s.slice(0,2)).toUpperCase();
    }
    function filenameFromPath(path){
      if (!path) return null;
      const p = path.split("/");
      return p[p.length-1] || path;
    }
    function escapeHTML(s=""){
      return s.replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[m]));
    }

    const phases = [
      { id:1, name:"Documenta√ß√£o inicial", desc:"RG e foto", icon:"üìù" },
      { id:2, name:"Antecedentes criminais", desc:"Emiss√£o de certid√£o", icon:"üìã" },
      { id:3, name:"Domic√≠lio", desc:"Comprovante de endere√ßo", icon:"üè†" },
      { id:4, name:"Cadastro RADEX", desc:"Sistema migrat√≥rio", icon:"üíª" },
      { id:5, name:"Pagamento de taxas", desc:"Boletos", icon:"üí≥" },
      { id:6, name:"Cita migrat√≥ria", desc:"Agendamento", icon:"üìÖ" },
      { id:7, name:"DNI emitido", desc:"Documento pronto", icon:"üéâ" }
    ];

    const phaseSteps = {
      1: [
        "Envio dos documentos para nossa equipe",
        "Upload dos documentos na plataforma correspondente",
        "An√°lise dos documentos realizada por n√≥s"
      ],
      2: [
        "Emiss√£o do documento",
        "Upload do documento ap√≥s a emiss√£o"
      ],
      3: [
        "Agendamento do tr√¢mite",
        "Retirada presencial do documento",
        "Upload do documento obtido"
      ],
      4: [
        "Realiza√ß√£o do cadastro",
        "Cria√ß√£o dos boletos das taxas migrat√≥rias"
      ],
      5: [
        "Pagamento dos boletos",
        "Upload dos comprovantes"
      ],
      6: [
        "Agendamento da cita",
        "Comparecimento presencial"
      ],
      7: [
        "Aguardar a emiss√£o e chegada do DNI argentino"
      ],
    };

    const docsCatalog = [
      { doc_type:"rg", name:"RG (Identidade)", icon:"ü™™" },
      { doc_type:"antecedentes", name:"Antecedentes Criminais", icon:"üìã" },
      { doc_type:"foto", name:"Foto 3x4", icon:"üì∏" },
      { doc_type:"outros", name:"Outros Documentos", icon:"üìÅ" },
    ];

    // Regras de upload (valida√ß√£o no front ‚Äî sem depender de mudan√ßas no banco/policies)
    const DOC_RULES = {
      rg: { maxMB: 10, exts: ["pdf","jpg","jpeg","png","webp"], mimes: ["application/pdf","image/jpeg","image/png","image/webp"] },
      antecedentes: { maxMB: 10, exts: ["pdf","jpg","jpeg","png","webp"], mimes: ["application/pdf","image/jpeg","image/png","image/webp"] },
      foto: { maxMB: 5, exts: ["jpg","jpeg","png","webp"], mimes: ["image/jpeg","image/png","image/webp"] },
      outros: { maxMB: 15, exts: ["pdf","jpg","jpeg","png","webp","doc","docx"], mimes: ["application/pdf","image/jpeg","image/png","image/webp",
        "application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document"] },
    };

    function safeExtFromName(name=""){
      const m = String(name).toLowerCase().match(/\.([a-z0-9]{1,10})$/);
      return m ? m[1] : "";
    }
    function extFromPath(path=""){
      const clean = String(path).split("?")[0];
      const m = clean.toLowerCase().match(/\.([a-z0-9]{1,10})$/);
      return m ? m[1] : "";
    }
    function mb(bytes){ return bytes / (1024 * 1024); }

    function validateFile(docType, file){
      const rules = DOC_RULES[docType] || { maxMB: 10, exts: [], mimes: [] };
      const ext = safeExtFromName(file.name);
      const sizeMB = mb(file.size);

      if (sizeMB > rules.maxMB){
        return { ok:false, message:`Arquivo muito grande (${sizeMB.toFixed(1)} MB). Limite para ${docType.toUpperCase()}: ${rules.maxMB} MB.` };
      }

      // Alguns dispositivos/OS podem n√£o preencher file.type; por isso validamos por ext + mime (quando existir)
      const mimeOk = !file.type || rules.mimes.length===0 || rules.mimes.includes(file.type);
      const extOk  = rules.exts.length===0 || rules.exts.includes(ext);

      if (!extOk || !mimeOk){
        const allowed = (rules.exts || []).map(e=>"."+e).join(", ");
        return { ok:false, message:`Tipo de arquivo n√£o permitido para ${docType.toUpperCase()}. Permitidos: ${allowed || "‚Äî"}.` };
      }

      return { ok:true, ext };
    }

    function acceptFor(docType){
      const rules = DOC_RULES[docType];
      if (!rules) return "image/*,application/pdf";
      const set = new Set();
      (rules.mimes || []).forEach(m=> set.add(m));
      (rules.exts || []).forEach(e=> set.add("."+e));
      return Array.from(set).join(",");
    }

    // Preview Modal
    const previewModal = document.getElementById("previewModal");
    const previewClose = document.getElementById("previewClose");
    const previewBody  = document.getElementById("previewBody");
    const previewTitle = document.getElementById("previewTitle");
    const previewDownload = document.getElementById("previewDownload");
    const previewOpenNew  = document.getElementById("previewOpenNew");

    function closePreview(){
      if (!previewModal) return;
      previewModal.classList.add("hidden");
      previewBody.replaceChildren();
      previewTitle.textContent = "Arquivo";
      previewDownload.href = "#";
      previewOpenNew.href = "#";
    }

    function openPreview({ url, title, ext }){
      if (!previewModal) return;

      previewTitle.textContent = title || "Arquivo";
      previewDownload.href = url;
      previewOpenNew.href = url;

      previewBody.replaceChildren();

      const e = (ext || "").toLowerCase();
      const imageExts = ["jpg","jpeg","png","webp","gif"];
      if (imageExts.includes(e)){
        const img = document.createElement("img");
        img.src = url;
        img.alt = title || "Pr√©-visualiza√ß√£o";
        img.className = "preview-img";
        img.loading = "lazy";
        img.referrerPolicy = "no-referrer";
        previewBody.appendChild(img);
      } else if (e === "pdf"){
        const frame = document.createElement("iframe");
        frame.src = url;
        frame.className = "preview-frame";
        frame.title = title || "Pr√©-visualiza√ß√£o";
        frame.loading = "lazy";
        frame.referrerPolicy = "no-referrer";
        // Observa√ß√£o: sem sandbox para n√£o quebrar o viewer de PDF em alguns browsers.
        previewBody.appendChild(frame);
      } else {
        const box = document.createElement("div");
        box.className = "card";
        box.style.padding = "14px";
        box.style.background = "rgba(255,255,255,.75)";
        box.style.border = "1px solid rgba(13,18,32,.12)";
        box.style.borderRadius = "16px";

        const t = document.createElement("div");
        t.style.fontWeight = "950";
        t.style.marginBottom = "6px";
        t.textContent = "Pr√©-visualiza√ß√£o indispon√≠vel neste formato.";

        const p = document.createElement("div");
        p.style.color = "rgba(13,18,32,.7)";
        p.style.fontWeight = "650";
        p.style.fontSize = "13px";
        p.textContent = "Use os bot√µes abaixo para baixar ou abrir em uma nova guia.";

        box.appendChild(t);
        box.appendChild(p);
        previewBody.appendChild(box);
      }

      previewModal.classList.remove("hidden");
    }

    // Fechar modal: bot√£o, backdrop e ESC
    previewClose?.addEventListener("click", closePreview);
    previewModal?.addEventListener("click", (e)=>{
      const t = e.target;
      if (t && t.dataset && t.dataset.close) closePreview();
    });
    document.addEventListener("keydown", (e)=>{
      if (e.key === "Escape" && previewModal && !previewModal.classList.contains("hidden")){
        closePreview();
      }
    });

    let currentUser = null;
    let currentProfile = null;
    let currentPhase = 1;
    let currentStep = 1;
    let docsMap = new Map();
    let inboxMsgs = [];

    function setActiveTab(key){
      document.querySelectorAll(".tab-btn").forEach(b=>{
        const active = (b.dataset.tab === key);
        b.classList.toggle("active", active);
        b.setAttribute("aria-selected", active ? "true" : "false");
      });
      document.querySelectorAll(".section").forEach(s=>{
        s.classList.toggle("active", s.id === `tab-${key}`);
      });
    }

    function wireTabs(){
      document.querySelectorAll(".tab-btn").forEach(btn=>{
        btn.addEventListener("click", ()=> setActiveTab(btn.dataset.tab));
      });
    }

    async function init(){
      setLoading(true, "Validando acesso‚Ä¶");

      const { data: sessionData } = await sb.auth.getSession();
      if (!sessionData?.session){
        window.location.href = "login.html";
        return;
      }

      const { data: userData, error: userErr } = await sb.auth.getUser();

      if (userErr || !userData?.user){
        window.location.href = "login.html";
        return;
      }

      currentUser = userData.user;

      // Profile
      const { data: profile, error: pErr } = await sb
        .from("profiles")
        .select("id, full_name, email, role")
        .eq("id", currentUser.id)
        .maybeSingle();

      if (pErr){
        showNotice("err","Erro ao buscar perfil. Verifique a tabela profiles e RLS.");
      }

      currentProfile = profile || {
        full_name: currentUser.email || "Cliente",
        email: currentUser.email,
        role: "client"
      };

      // UI header
      document.getElementById("userAvatar").textContent = initials(currentProfile.full_name || currentProfile.email);
      document.getElementById("userName").textContent = currentProfile.full_name || "Cliente";
      document.getElementById("userEmail").textContent = currentProfile.email || currentUser.email || "‚Äî";

      // Process
      const { data: proc } = await sb
        .from("dni_process")
        .select("current_phase, current_step")
        .eq("user_id", currentUser.id)
        .maybeSingle();

      currentPhase = proc?.current_phase || 1;
      currentStep  = proc?.current_step  || 1;

      renderProcess();

      // Documents
      const { data: docs } = await sb
        .from("documents")
        .select("doc_type, status, storage_path, uploaded_at, approved_at")
        .eq("user_id", currentUser.id);

      docsMap = new Map();
      (docs || []).forEach(r => docsMap.set(r.doc_type, r));
      renderDocuments();

      // Inbox
      await refreshInbox();

      // Logout
      document.getElementById("logoutBtn").addEventListener("click", async ()=>{
        setLoading(true, "Saindo‚Ä¶");
        await sb.auth.signOut();
        window.location.href = "login.html";
      });

      wireTabs();
      setLoading(false);
    }

    function renderProcess(){
      const row = document.getElementById("phasesRow");
      const badge = document.getElementById("progressBadge");
      const pill = document.getElementById("progressPill");
      const currentBadge = document.getElementById("currentPhaseBadge");
      const currentDesc = document.getElementById("currentPhaseDesc");
      const container = document.getElementById("timelineVertical");

      row.innerHTML = "";
      badge.textContent = `Fase ${currentPhase} de 7`;
      pill.textContent = `Fase ${currentPhase} de 7`;
      currentBadge.textContent = `Fase ${currentPhase}`;
      currentDesc.textContent = phases.find(p=>p.id===currentPhase)?.name || "‚Äî";

      phases.forEach(ph=>{
        const active = ph.id === currentPhase;
        const done = ph.id < currentPhase;

        const statusClass = active ? "active" : (done ? "done" : "");
        const item = document.createElement("div");
        item.className = `phase-item ${statusClass}`;
        item.innerHTML = `
          <div class="phase-marker">${ph.icon || ph.id}</div>
          <div class="phase-name">${ph.name}</div>
          <div class="phase-desc">${ph.desc}</div>
        `;
        row.appendChild(item);
      });

      container.innerHTML = "";
      const steps = phaseSteps[currentPhase] || [];

      steps.forEach((label, idx)=>{
        const n = idx + 1;
        const st = document.createElement("div");
        st.className = "step " + (n < currentStep ? "done" : (n === currentStep ? "active" : ""));
        st.innerHTML = `
          <div class="dot"></div>
          <div>
            <div class="step-title">Passo ${n}</div>
            <div class="step-sub">${label}</div>
          </div>
        `;
        container.appendChild(st);
      });
    }

    function docStatusBadge(status){
      if (status === "approved") return { cls:"approved", txt:"‚úÖ Aprovado" };
      if (status === "rejected") return { cls:"rejected", txt:"‚úï Rejeitado" };
      if (status === "uploaded") return { cls:"uploaded", txt:"‚úì Enviado" };
      return { cls:"pending", txt:"‚è≥ Pendente" };
    }

    function renderDocuments(){
      const grid = document.getElementById("documentsGrid");
      grid.innerHTML = "";

      docsCatalog.forEach(dc => {
        const row = docsMap.get(dc.doc_type) || null;
        const status = row?.status || "pending";
        const badge = docStatusBadge(status);

        const fileNameSafe = row?.storage_path ? escapeHTML(filenameFromPath(row.storage_path) || "arquivo") : "";

        const fileInfo = row?.storage_path
          ? `Arquivo: ${fileNameSafe}`
          : "Sem envio ainda";

        const timeInfo = row?.uploaded_at ? `Enviado em ${escapeHTML(fmtDate(row.uploaded_at))}` : "";

        const card = document.createElement("div");
        card.className = `doc-card ${status === "approved" ? "approved" : (status === "rejected" ? "rejected" : "")}`;

        card.innerHTML = `
          <div class="doc-header">
            <div class="doc-icon">${dc.icon}</div>
            <div class="doc-status ${badge.cls}">${badge.txt}</div>
          </div>

          <div class="doc-title">${dc.name}</div>
          <div class="doc-info">${fileInfo}${timeInfo ? "<br>"+timeInfo : ""}</div>

          <input type="file" class="input" style="padding:10px 12px;" accept="${acceptFor(dc.doc_type)}" />

          <div class="doc-actions">
            <button class="btn-small" type="button" ${row?.storage_path ? "" : "disabled"}>üëÅÔ∏è Visualizar</button>
            <button class="btn-small danger" type="button" ${row?.storage_path ? "" : "disabled"}>‚úï Remover</button>
          </div>

          <div class="footer-note" style="margin-top:10px;">
            Ap√≥s enviar: status vira "Enviado". Depois a equipe pode aprovar ou rejeitar.
          </div>
        `;

        const fileInput = card.querySelector('input[type="file"]');
        const [btnView, btnRemove] = card.querySelectorAll("button");

        fileInput.addEventListener("change", async (e)=>{
          const file = e.target.files?.[0];
          if (!file) return;
          await uploadDoc(dc.doc_type, file);
          e.target.value = "";
        });

        btnView.addEventListener("click", async ()=>{
          if (!row?.storage_path) return;
          await viewDoc(row.storage_path);
        });

        btnRemove.addEventListener("click", async ()=>{
          if (!row?.storage_path) return;
          const ok = confirm("Remover este arquivo? (Vai apagar do Storage)");
          if (!ok) return;
          await removeDoc(dc.doc_type, row.storage_path);
        });

        grid.appendChild(card);
      });
    }

    function safeExt(name=""){ return safeExtFromName(name); }

    async function uploadDoc(docType, file){
      hideNotice();

      const v = validateFile(docType, file);
      if (!v.ok){
        showNotice("err", v.message);
        return;
      }

      setLoading(true, "Enviando arquivo‚Ä¶");

      try{
        const ext = v.ext || safeExt(file.name) || "bin";
        const storagePath = `${currentUser.id}/${docType}/${Date.now()}-${Math.random().toString(16).slice(2)}.${ext}`;

        const { error: upErr } = await sb.storage
          .from("documents")
          .upload(storagePath, file, { upsert:false });

        if (upErr){
          showNotice("err", "Falha no upload. Verifique policies do Storage bucket 'documents'.");
          setLoading(false);
          return;
        }

        const nowIso = new Date().toISOString();

        let updated = null;
        {
          const { data, error } = await sb
            .from("documents")
            .update({ storage_path: storagePath, status:"uploaded", uploaded_at: nowIso, approved_at: null })
            .eq("user_id", currentUser.id)
            .eq("doc_type", docType)
            .select("doc_type, status, storage_path, uploaded_at, approved_at")
            .maybeSingle();

          if (!error && data) updated = data;
        }

        if (!updated){
          const { data, error } = await sb
            .from("documents")
            .upsert({
              user_id: currentUser.id,
              doc_type: docType,
              storage_path: storagePath,
              status: "uploaded",
              uploaded_at: nowIso,
              approved_at: null
            }, { onConflict: "user_id,doc_type" })
            .select("doc_type, status, storage_path, uploaded_at, approved_at")
            .maybeSingle();

          if (error || !data){
            showNotice("err", "Upload ok, mas falhou ao salvar no banco.");
            setLoading(false);
            return;
          }
          updated = data;
        }

        docsMap.set(docType, updated);
        renderDocuments();
        showNotice("ok", "Arquivo enviado com sucesso!");
      } catch {
        showNotice("err", "Falha inesperada ao enviar.");
      }

      setLoading(false);
    }

    async function viewDoc(storagePath){
      hideNotice();
      setLoading(true, "Carregando pr√©-visualiza√ß√£o‚Ä¶");

      const { data, error } = await sb.storage
        .from("documents")
        .createSignedUrl(storagePath, 300);

      if (error || !data?.signedUrl){
        showNotice("err", "N√£o consegui gerar link para visualizar.");
        setLoading(false);
        return;
      }

      const title = filenameFromPath(storagePath) || "Arquivo";
      const ext = extFromPath(storagePath);
      openPreview({ url: data.signedUrl, title, ext });
      setLoading(false);
    }

    async function removeDoc(docType, storagePath){
      hideNotice();
      setLoading(true, "Removendo arquivo‚Ä¶");

      const { error: rmErr } = await sb.storage.from("documents").remove([storagePath]);
      if (rmErr){
        showNotice("err", "N√£o consegui remover do Storage.");
        setLoading(false);
        return;
      }

      const { data, error } = await sb
        .from("documents")
        .update({ storage_path:null, status:"pending", uploaded_at:null, approved_at:null })
        .eq("user_id", currentUser.id)
        .eq("doc_type", docType)
        .select("doc_type, status, storage_path, uploaded_at, approved_at")
        .maybeSingle();

      if (error){
        showNotice("err", "Removido do Storage, mas falhou ao atualizar no banco.");
      } else {
        docsMap.set(docType, data || { doc_type: docType, status:"pending", storage_path:null, uploaded_at:null, approved_at:null });
        renderDocuments();
        showNotice("ok", "Arquivo removido.");
      }

      setLoading(false);
    }

    async function refreshInbox(){
      const list = document.getElementById("inboxList");
      const empty = document.getElementById("inboxEmpty");
      const badge = document.getElementById("inboxBadge");
      const tabBadge = document.getElementById("supportBadge");

      const { data } = await sb
        .from("client_messages")
        .select("id, title, message, created_at, is_read")
        .eq("user_id", currentUser.id)
        .order("created_at", { ascending:false });

      inboxMsgs = data || [];

      if (!list || !empty || !badge || !tabBadge) return;

      list.innerHTML = "";

      const unread = inboxMsgs.filter(m => !m.is_read).length;
      if (unread > 0){
        badge.style.display = "inline-flex";
        badge.textContent = unread;
        tabBadge.style.display = "inline-flex";
        tabBadge.textContent = unread;
      } else {
        badge.style.display = "none";
        tabBadge.style.display = "none";
      }

      if (!inboxMsgs.length){
        empty.style.display = "block";
        return;
      }

      empty.style.display = "none";

      inboxMsgs.forEach(m => {
        const box = document.createElement("div");
        box.className = "doc-card " + (m.is_read ? "" : "approved");
        box.style.cursor = "pointer";

        box.innerHTML = `
          <div class="doc-header">
            <div style="font-weight:950; letter-spacing:-0.15px;">${escapeHTML(m.title)}</div>
            <div class="doc-status ${m.is_read ? "uploaded" : "pending"}">${m.is_read ? "Lida" : "Nova"}</div>
          </div>
          <div class="doc-info">${fmtDate(m.created_at)}</div>
          <div class="small" style="margin-top:8px; color: rgba(13,18,32,.86); white-space:pre-wrap;">${escapeHTML(m.message)}</div>
        `;

        box.addEventListener("click", async ()=>{
          if (m.is_read) return;

          const nowIso = new Date().toISOString();
          await sb.from("client_messages")
            .update({ is_read:true, read_at: nowIso })
            .eq("id", m.id);

          m.is_read = true;
          renderInbox();
        });

        list.appendChild(box);
      });

      renderInbox();
    }

    function renderInbox(){
      // re-render badge counts only (list already built in refreshInbox)
      const badge = document.getElementById("inboxBadge");
      const tabBadge = document.getElementById("supportBadge");
      const unread = inboxMsgs.filter(m => !m.is_read).length;
      if (unread > 0){
        badge.style.display = "inline-flex";
        badge.textContent = unread;
        tabBadge.style.display = "inline-flex";
        tabBadge.textContent = unread;
      } else {
        badge.style.display = "none";
        tabBadge.style.display = "none";
      }
    }

    init();
  </script>
</body>
</html>
