<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard | GoArgentina</title>

  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    :root{
      --primary:#0066FF; --accent:#FFD500; --dark:#0A0E27; --light:#F8F9FF;
      --success:#10B981; --warning:#F59E0B; --danger:#EF4444;
    }
    body{
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;
      background:var(--dark); color:var(--light); line-height:1.6; overflow-x:hidden;
    }
    .stars{ position:fixed; inset:0; pointer-events:none; z-index:0; }
    .star{ position:absolute; width:2px; height:2px; background:#fff; border-radius:50%; opacity:.4; animation:twinkle 3s infinite; }
    @keyframes twinkle{ 0%,100%{opacity:.4} 50%{opacity:1} }
    @keyframes float{ 0%,100%{transform:translateY(0)} 50%{transform:translateY(-10px)} }
    @keyframes slideDown{ from{opacity:0; transform:translateY(-16px)} to{opacity:1; transform:translateY(0)} }
    @keyframes fadeIn{ from{opacity:0} to{opacity:1} }
    @keyframes spin{ to{ transform:rotate(360deg) } }

    header{
      padding:18px 0;
      backdrop-filter:blur(20px);
      background:rgba(10,14,39,.95);
      border-bottom:1px solid rgba(255,255,255,.1);
      position:sticky; top:0; z-index:100;
    }
    .header-container{
      max-width:1200px; margin:0 auto; padding:0 20px;
      display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap;
    }
    .logo{
      font-size:22px; font-weight:900;
      background:linear-gradient(135deg,var(--primary),var(--accent));
      -webkit-background-clip:text; -webkit-text-fill-color:transparent;
      display:flex; align-items:center; gap:10px; text-decoration:none;
    }
    .logo-icon{
      width:40px; height:40px; border-radius:12px;
      background:linear-gradient(135deg,var(--primary),var(--accent));
      display:flex; align-items:center; justify-content:center; font-size:20px; color:var(--dark);
      animation:float 3s ease-in-out infinite;
    }

    .header-actions{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end; }
    .user-pill{
      display:flex; align-items:center; gap:10px; padding:8px 14px;
      background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.1); border-radius:999px;
    }
    .user-avatar{
      width:34px; height:34px; border-radius:50%;
      background:linear-gradient(135deg,var(--primary),var(--accent));
      display:flex; align-items:center; justify-content:center; font-weight:900; color:var(--dark);
    }
    .user-name{ font-size:13px; font-weight:800; color:rgba(255,255,255,.9); }
    .logout-btn{
      background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.1);
      color:rgba(255,255,255,.75); padding:8px 16px; border-radius:999px;
      cursor:pointer; font-weight:800; transition:.2s;
    }
    .logout-btn:hover{ background:rgba(255,255,255,.1); color:#fff; }

    .main-container{ max-width:1200px; margin:0 auto; padding:34px 20px; position:relative; z-index:1; }
    .page-header{ margin-bottom:16px; animation:slideDown .6s ease-out; }
    .page-title{
      font-size:clamp(26px,4vw,34px); font-weight:950; margin-bottom:6px;
      background:linear-gradient(135deg,#fff,#a0b0ff);
      -webkit-background-clip:text; -webkit-text-fill-color:transparent;
    }
    .page-subtitle{ font-size:14px; color:rgba(255,255,255,.6); }

    .notice{
      margin-top:12px; padding:12px 14px; border-radius:14px; border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.05); font-size:13px; color:rgba(255,255,255,.85); display:none;
    }
    .notice.show{ display:block; }
    .notice.ok{ border-color:rgba(16,185,129,.35); background:rgba(16,185,129,.08); }
    .notice.err{ border-color:rgba(239,68,68,.35); background:rgba(239,68,68,.08); }

    .tabs{
      display:flex; gap:10px; flex-wrap:wrap; margin:18px 0 18px;
    }
    .tab-btn{
      border:none; cursor:pointer; font-weight:950; font-size:13px;
      padding:10px 14px; border-radius:999px; transition:.2s;
      background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12);
      color:rgba(255,255,255,.85);
      display:inline-flex; align-items:center; gap:10px;
    }
    .tab-btn:hover{ background:rgba(255,255,255,.1); }
    .tab-btn.active{
      background:linear-gradient(135deg,var(--primary),#0052CC);
      border-color:rgba(0,102,255,.4);
      color:#fff;
      box-shadow:0 10px 26px rgba(0,102,255,.28);
    }
    .tab-badge{
      display:none;
      font-size:11px; font-weight:950;
      padding:2px 8px; border-radius:999px;
      background:rgba(245,158,11,.16);
      border:1px solid rgba(245,158,11,.35);
      color:var(--warning);
    }

    .section{ display:none; animation:fadeIn .25s ease-out; }
    .section.active{ display:block; }

    .grid-2{ display:grid; grid-template-columns:1fr 1fr; gap:16px; }
    @media (max-width:900px){ .grid-2{ grid-template-columns:1fr; } }

    .card{
      background:rgba(255,255,255,.05); backdrop-filter:blur(10px);
      border:1px solid rgba(255,255,255,.1); border-radius:18px;
      padding:18px;
    }
    .card-title{ font-size:15px; font-weight:950; margin-bottom:10px; display:flex; align-items:center; gap:8px; }
    .small{ font-size:13px; color:rgba(255,255,255,.72); font-weight:800; }

    .documents-grid{
      display:grid; grid-template-columns:repeat(auto-fill, minmax(250px, 1fr)); gap:12px;
      margin-top:10px;
    }
    .doc-card{
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.1);
      border-radius:16px; padding:14px; transition:.15s;
    }
    .doc-card:hover{ border-color:rgba(0,102,255,.35); }
    .doc-card.approved{ border-color:rgba(16,185,129,.42); background:rgba(16,185,129,.05); }
    .doc-card.rejected{ border-color:rgba(239,68,68,.42); background:rgba(239,68,68,.05); }
    .doc-header{ display:flex; justify-content:space-between; align-items:flex-start; gap:10px; margin-bottom:10px; }
    .doc-icon{ font-size:28px; }
    .doc-status{
      font-size:11px; font-weight:950; padding:4px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.06);
      white-space:nowrap;
    }
    .doc-status.pending{ color:var(--warning); border-color:rgba(245,158,11,.28); background:rgba(245,158,11,.10); }
    .doc-status.uploaded{ color:var(--success); border-color:rgba(16,185,129,.28); background:rgba(16,185,129,.10); }
    .doc-status.approved{ color:var(--success); border-color:rgba(16,185,129,.4); background:rgba(16,185,129,.14); }
    .doc-status.rejected{ color:var(--danger); border-color:rgba(239,68,68,.32); background:rgba(239,68,68,.12); }
    .doc-title{ font-size:13px; font-weight:950; margin-bottom:6px; }
    .doc-info{ font-size:12px; color:rgba(255,255,255,.55); font-weight:800; margin-bottom:10px; }
    .doc-actions{ display:flex; gap:8px; flex-wrap:wrap; }
    .btn-small{
      padding:8px 10px; font-size:12px; font-weight:950;
      border-radius:10px; border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06); color:#fff; cursor:pointer; transition:.15s;
    }
    .btn-small:hover{ background:rgba(0,102,255,.18); border-color:rgba(0,102,255,.4); }
    .btn-small.danger:hover{ background:rgba(239,68,68,.18); border-color:rgba(239,68,68,.4); }
    .btn-small:disabled{ opacity:.45; cursor:not-allowed; }

    .phase-grid{
      display:grid; grid-template-columns:repeat(auto-fill, minmax(280px, 1fr)); gap:12px;
      margin-top:10px;
    }
    .phase-card{
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.1);
      border-radius:16px; padding:16px; transition:.15s;
    }
    .phase-card.current{ border-color:rgba(0,102,255,.42); background:rgba(0,102,255,.08); }
    .phase-card.completed{ border-color:rgba(16,185,129,.35); background:rgba(16,185,129,.05); }

    .phase-top{ display:flex; justify-content:space-between; align-items:flex-start; gap:12px; }
    .phase-title{ font-weight:950; font-size:14px; }
    .phase-desc{ font-size:12px; color:rgba(255,255,255,.55); font-weight:800; margin-top:2px; }
    .status-pill{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px; border-radius:999px; font-size:12px; font-weight:950;
      border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.06);
      white-space:nowrap;
    }
    .status-pill.current{ border-color:rgba(0,102,255,.35); background:rgba(0,102,255,.14); color:#9ec2ff; }
    .status-pill.done{ border-color:rgba(16,185,129,.35); background:rgba(16,185,129,.14); color:var(--success); }

    .progress-wrap{ margin-top:12px; }
    .progress-bar{
      width:100%; height:8px; border-radius:999px;
      background:rgba(255,255,255,.08); overflow:hidden;
      border:1px solid rgba(255,255,255,.1);
    }
    .progress-fill{ height:100%; width:0%; background:linear-gradient(135deg,var(--primary),var(--accent)); transition:.25s; }
    .progress-text{ margin-top:8px; font-size:12px; color:rgba(255,255,255,.65); font-weight:900; display:flex; justify-content:space-between; }

    .steps-list{ margin-top:12px; display:flex; flex-direction:column; gap:8px; }
    .step-item{
      display:flex; align-items:flex-start; gap:10px;
      padding:10px 12px;
      background:rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.08);
      border-radius:12px;
    }
    .step-check{
      width:18px; height:18px; border-radius:999px;
      border:2px solid rgba(255,255,255,.25);
      margin-top:2px;
      flex:0 0 auto;
    }
    .step-item.checked .step-check{
      border-color:rgba(16,185,129,.65);
      background:rgba(16,185,129,.25);
    }
    .step-text{ font-size:12.5px; font-weight:900; color:rgba(255,255,255,.9); }
    .step-sub{ margin-top:2px; font-size:12px; color:rgba(255,255,255,.55); font-weight:800; }
    .step-status-label{ margin-top:6px; font-size:11px; font-weight:950; color:rgba(255,255,255,.65); }

    .loading-overlay{
      position:fixed; inset:0; z-index:9999;
      background:rgba(10,14,39,.72); backdrop-filter:blur(10px);
      display:flex; align-items:center; justify-content:center; flex-direction:column; gap:10px;
    }
    .loading-overlay.hidden{ display:none; }
    .spinner{
      width:42px; height:42px; border-radius:50%;
      border:4px solid rgba(255,255,255,.15);
      border-top-color: rgba(255,255,255,.85);
      animation: spin .9s linear infinite;
    }
    .loading-text{ color:rgba(255,255,255,.85); font-weight:950; font-size:14px; }

    .input{
      width:100%;
      padding:12px 14px;
      border-radius:12px;
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.1);
      color:#fff; font-weight:800; font-size:14px;
      transition:.2s;
    }
    .input:focus{ outline:none; border-color:var(--primary); background:rgba(255,255,255,.08); }
    .input::placeholder{ color:rgba(255,255,255,.4); font-weight:800; }

    .empty-state{
      text-align:center; padding:38px 10px;
      border:1px dashed rgba(255,255,255,.14);
      border-radius:18px;
      background:rgba(255,255,255,.03);
    }
    .empty-icon{ font-size:44px; opacity:.35; margin-bottom:8px; }
    .empty-title{ font-size:15px; font-weight:950; }
    .empty-text{ font-size:13px; color:rgba(255,255,255,.6); font-weight:800; margin-top:4px; }
  </style>
</head>

<body>
  <div class="stars"></div>

  <div class="loading-overlay" id="loading">
    <div class="spinner"></div>
    <div class="loading-text" id="loadingText">Carregando‚Ä¶</div>
  </div>

  <header>
    <div class="header-container">
      <a class="logo" href="index.html">
        <div class="logo-icon">üá¶üá∑</div><span>GoArgentina</span>
      </a>

      <div class="header-actions">
        <div class="user-pill" title="Sua conta">
          <div class="user-avatar" id="userAvatar">CL</div>
          <div class="user-name" id="userName">Cliente</div>
        </div>
        <button class="logout-btn" id="logoutBtn">Sair</button>
      </div>
    </div>
  </header>

  <main class="main-container">
    <div class="page-header">
      <h1 class="page-title">Seu painel</h1>
      <p class="page-subtitle">Envie documentos, acompanhe fases e receba atualiza√ß√µes</p>
      <div class="notice" id="noticeBox"></div>
    </div>

    <div class="tabs">
      <button class="tab-btn active" data-tab="docs">üìÑ Documentos</button>
      <button class="tab-btn" data-tab="process">üß≠ Processo</button>
      <button class="tab-btn" data-tab="support">üí¨ Suporte <span class="tab-badge" id="supportBadge">0</span></button>
    </div>

    <!-- DOCUMENTOS -->
    <section class="section active" id="tab-docs">
      <div class="card">
        <div class="card-title">üìÑ Seus documentos</div>
        <div class="small">Fa√ßa upload dos arquivos. Ap√≥s envio, nossa equipe revisa e aprova.</div>

        <div class="documents-grid" id="documentsGrid"></div>

        <div class="small" style="margin-top:12px; color:rgba(255,255,255,.55);">
          Dica: prefira imagens n√≠tidas ou PDF. Se um documento for rejeitado, reenvie uma vers√£o melhor.
        </div>
      </div>
    </section>

    <!-- PROCESSO -->
    <section class="section" id="tab-process">
      <div class="card">
        <div class="card-title">üß≠ Processo (7 fases)</div>
        <div class="small">Voc√™ v√™ o andamento por fase. Se existirem passos personalizados no sistema, eles aparecem aqui.</div>

        <div class="phase-grid" id="phaseGrid" style="margin-top:14px;"></div>
      </div>
    </section>

    <!-- SUPORTE -->
    <section class="section" id="tab-support">
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap;">
          <div>
            <div class="card-title" style="margin-bottom:4px;">üì® Caixa de entrada</div>
            <div class="small">Atualiza√ß√µes, dicas e solicita√ß√µes da nossa equipe.</div>
          </div>
          <div class="doc-status pending" id="inboxBadge" style="display:none;"></div>
        </div>

        <div id="inboxList" style="margin-top:14px; display:flex; flex-direction:column; gap:10px;"></div>

        <div class="empty-state" id="inboxEmpty" style="display:none; margin-top:14px;">
          <div class="empty-icon">üì≠</div>
          <div class="empty-title">Sem mensagens</div>
          <div class="empty-text">Quando tivermos atualiza√ß√µes ou pedidos, elas aparecem aqui.</div>
        </div>

        <div class="empty-state" style="margin-top:16px;">
          <div class="empty-icon">üí¨</div>
          <div class="empty-title">Precisa falar com a gente?</div>
          <div class="empty-text">Chame no WhatsApp (o chat interno pode vir depois).</div>
          <div style="margin-top:12px;">
            <a href="https://wa.me/" target="_blank" rel="noopener noreferrer"
               style="display:inline-flex; gap:8px; align-items:center; text-decoration:none;
                      padding:10px 14px; border-radius:999px; font-weight:950;
                      background:rgba(16,185,129,.16); border:1px solid rgba(16,185,129,.35); color:var(--success);">
              üíö Abrir WhatsApp
            </a>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    /* =========================
       1) CONFIG (trocar s√≥ isso)
    ========================= */
    const SUPABASE_URL = "https://gqtkhimnfphllvtxkmjl.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdxdGtoaW1uZnBobGx2dHhrbWpsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkwNTg5MDAsImV4cCI6MjA4NDYzNDkwMH0.I7GOmBZsUtyxuPxzhcg3i5qaDuIFWBHHNtlZS65Qt_k";

    /* =========================
       2) CLIENT
    ========================= */
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { persistSession:true, autoRefreshToken:true, detectSessionInUrl:true }
    });

    /* =========================
       3) UI helpers
    ========================= */
    const loadingEl = document.getElementById("loading");
    const loadingText = document.getElementById("loadingText");
    const noticeBox = document.getElementById("noticeBox");

    function setLoading(show, text){
      if (text) loadingText.textContent = text;
      loadingEl.classList.toggle("hidden", !show);
    }
    function showNotice(type, msg){
      noticeBox.className = "notice show " + (type==="ok" ? "ok" : "err");
      noticeBox.textContent = msg;
    }
    function hideNotice(){
      noticeBox.className = "notice";
      noticeBox.textContent = "";
    }
    function fmtDate(dt){
      if (!dt) return "-";
      try { return new Date(dt).toLocaleString("pt-BR"); } catch { return "-"; }
    }
    function initialsFrom(nameOrEmail){
      const s = (nameOrEmail || "CL").trim();
      const parts = s.split(" ").filter(Boolean);
      if (parts.length >= 2) return (parts[0][0] + parts[1][0]).toUpperCase();
      return (s.slice(0,2)).toUpperCase();
    }
    function filenameFromPath(path){
      if (!path) return null;
      const p = path.split("/");
      return p[p.length-1] || path;
    }
    function escapeHTML(s=""){
      return s.replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[m]));
    }

    /* =========================
       4) Stars
    ========================= */
    const starsContainer = document.querySelector(".stars");
    for (let i=0;i<100;i++){
      const star = document.createElement("div");
      star.className="star";
      star.style.left = Math.random()*100 + "%";
      star.style.top = Math.random()*100 + "%";
      star.style.animationDelay = Math.random()*3 + "s";
      starsContainer.appendChild(star);
    }

    /* =========================
       5) Data & constants
    ========================= */
    const phases = [
      { id:1, name:"Documenta√ß√£o inicial", desc:"RG e foto" },
      { id:2, name:"Antecedentes criminais", desc:"Emiss√£o de certid√£o" },
      { id:3, name:"Domic√≠lio", desc:"Comprovante de endere√ßo" },
      { id:4, name:"Cadastro RADEX", desc:"Sistema migrat√≥rio" },
      { id:5, name:"Pagamento de taxas", desc:"Boletos" },
      { id:6, name:"Cita migrat√≥ria", desc:"Agendamento" },
      { id:7, name:"DNI emitido", desc:"Documento pronto" }
    ];

    // Fallback (se ainda n√£o existir phase_steps pro cliente no banco)
    const fallbackSteps = {
      1: [
        "Envio dos documentos para nossa equipe",
        "Upload dos documentos na plataforma correspondente",
        "An√°lise dos documentos realizada por n√≥s"
      ],
      2: [
        "Emiss√£o do documento",
        "Upload do documento ap√≥s a emiss√£o"
      ],
      3: [
        "Agendamento do tr√¢mite",
        "Retirada presencial do documento",
        "Upload do documento obtido"
      ],
      4: [
        "Realiza√ß√£o do cadastro",
        "Cria√ß√£o dos boletos das taxas migrat√≥rias"
      ],
      5: [
        "Pagamento dos boletos",
        "Upload dos comprovantes"
      ],
      6: [
        "Agendamento da cita",
        "Comparecimento presencial"
      ],
      7: [
        "Aguardar a emiss√£o e chegada do DNI argentino"
      ],
    };

    const docsCatalog = [
      { doc_type:"rg", name:"RG (Identidade)", icon:"ü™™" },
      { doc_type:"antecedentes", name:"Antecedentes Criminais", icon:"üìã" },
      { doc_type:"foto", name:"Foto 3x4", icon:"üì∏" },
      { doc_type:"outros", name:"Outros Documentos", icon:"üìÅ" },
    ];

    let currentUser = null;
    let currentProfile = null;

    let currentPhase = 1;
    let docsMap = new Map();      // doc_type -> row
    let stepsByPhase = new Map(); // phase_number -> rows[]
    let inboxMsgs = [];           // client_messages

    /* =========================
       6) Tabs
    ========================= */
    function setActiveTab(key){
      document.querySelectorAll(".tab-btn").forEach(b=>{
        b.classList.toggle("active", b.dataset.tab === key);
      });
      document.querySelectorAll(".section").forEach(s=>{
        s.classList.toggle("active", s.id === `tab-${key}`);
      });
    }

    function wireTabs(){
      document.querySelectorAll(".tab-btn").forEach(btn=>{
        btn.addEventListener("click", ()=> setActiveTab(btn.dataset.tab));
      });
    }

    /* =========================
       7) Auth guard + init
    ========================= */
    async function init(){
      setLoading(true, "Validando acesso‚Ä¶");

      const { data: sessionData } = await sb.auth.getSession();
      if (!sessionData?.session){
        window.location.href = "login.html";
        return;
      }

      const { data: userData, error: userErr } = await sb.auth.getUser();
      if (userErr || !userData?.user){
        window.location.href = "login.html";
        return;
      }
      currentUser = userData.user;

      const { data: profile, error: profErr } = await sb
        .from("profiles")
        .select("id, email, full_name, role, created_at")
        .eq("id", currentUser.id)
        .single();

      if (profErr || !profile){
        showNotice("err", "N√£o consegui carregar seu perfil. Recarregue a p√°gina.");
        setLoading(false);
        return;
      }
      currentProfile = profile;

      // se for admin, manda pro admin
      if (currentProfile.role === "admin"){
        window.location.href = "admin.html";
        return;
      }

      // header
      const display = (currentProfile.full_name || currentProfile.email || "Cliente");
      document.getElementById("userName").textContent = display;
      document.getElementById("userAvatar").textContent = initialsFrom(display);

      wireTabs();
      wireEvents();

      await loadAll();
      setLoading(false);
    }

    function wireEvents(){
      document.getElementById("logoutBtn").addEventListener("click", logout);

      // mant√©m sess√£o em dia
      sb.auth.onAuthStateChange((event) => {
        if (event === "SIGNED_OUT"){
          window.location.href = "login.html";
        }
      });
    }

    async function logout(){
      setLoading(true, "Saindo‚Ä¶");
      await sb.auth.signOut();
      window.location.href = "login.html";
    }

    /* =========================
       8) Load data
    ========================= */
    async function loadAll(){
      hideNotice();
      setLoading(true, "Carregando dados‚Ä¶");

      await Promise.all([
        loadProcess(),
        loadDocuments(),
        loadPhaseSteps(),
        loadInboxMessages()
      ]);

      renderDocuments();
      renderProcessPhases(currentPhase);
      renderInbox();

      setLoading(false);
    }

    async function loadProcess(){
      // busca/garante processo
      const { data, error } = await sb
        .from("dni_process")
        .select("user_id, current_phase, updated_at")
        .eq("user_id", currentUser.id)
        .maybeSingle();

      if (error){
        // se algo travar por RLS, mostra s√≥ o b√°sico
        currentPhase = 1;
        return;
      }

      if (!data){
        // tenta criar linha (se houver policy/triggers)
        const nowIso = new Date().toISOString();
        const { data: created } = await sb
          .from("dni_process")
          .upsert({ user_id: currentUser.id, current_phase: 1, updated_at: nowIso }, { onConflict:"user_id" })
          .select("current_phase")
          .maybeSingle();
        currentPhase = created?.current_phase || 1;
        return;
      }

      currentPhase = data.current_phase || 1;
    }

    async function loadDocuments(){
      docsMap = new Map();

      const { data, error } = await sb
        .from("documents")
        .select("user_id, doc_type, status, storage_path, uploaded_at, approved_at")
        .eq("user_id", currentUser.id);

      if (error){
        showNotice("err", "Erro ao carregar documentos. Confira as pol√≠ticas (RLS) da tabela documents.");
        return;
      }

      (data || []).forEach(d => docsMap.set(d.doc_type, d));
    }

    async function loadPhaseSteps(){
      stepsByPhase = new Map();

      const { data, error } = await sb
        .from("phase_steps")
        .select("phase_number, step_number, step_title, step_description, status")
        .eq("user_id", currentUser.id)
        .order("phase_number", { ascending:true })
        .order("step_number", { ascending:true });

      // Se a tabela ainda n√£o existir ou RLS bloquear, s√≥ usa fallback
      if (error || !data || !data.length) return;

      data.forEach(r => {
        if (!stepsByPhase.has(r.phase_number)) stepsByPhase.set(r.phase_number, []);
        stepsByPhase.get(r.phase_number).push(r);
      });
    }

    async function loadInboxMessages(){
      inboxMsgs = [];

      const { data, error } = await sb
        .from("client_messages")
        .select("id, title, message, message_type, is_read, created_at")
        .eq("user_id", currentUser.id)
        .order("created_at", { ascending:false })
        .limit(30);

      if (error) return;
      inboxMsgs = data || [];
    }

    /* =========================
       9) Documents UI
    ========================= */
    function docStatusBadge(status){
      if (status === "approved") return { cls:"approved", txt:"‚úÖ Aprovado" };
      if (status === "rejected") return { cls:"rejected", txt:"‚ö†Ô∏è Rejeitado" };
      if (status === "uploaded") return { cls:"uploaded", txt:"‚úì Enviado" };
      return { cls:"pending", txt:"‚è≥ Pendente" };
    }

    function renderDocuments(){
      const grid = document.getElementById("documentsGrid");
      grid.innerHTML = "";

      docsCatalog.forEach(dc => {
        const row = docsMap.get(dc.doc_type) || null;
        const status = row?.status || "pending";
        const badge = docStatusBadge(status);

        const fileInfo = row?.storage_path
          ? `Arquivo: ${filenameFromPath(row.storage_path)}`
          : "Sem envio ainda";

        const timeInfo = row?.uploaded_at ? `Enviado em ${fmtDate(row.uploaded_at)}` : "";

        const card = document.createElement("div");
        card.className = `doc-card ${status === "approved" ? "approved" : (status === "rejected" ? "rejected" : "")}`;

        card.innerHTML = `
          <div class="doc-header">
            <div class="doc-icon">${dc.icon}</div>
            <div class="doc-status ${badge.cls}">${badge.txt}</div>
          </div>
          <div class="doc-title">${dc.name}</div>
          <div class="doc-info">${fileInfo}${timeInfo ? "<br>"+timeInfo : ""}</div>

          <input type="file" class="input" style="padding:10px 12px;" accept="image/*,application/pdf" />

          <div class="doc-actions" style="margin-top:10px;">
            <button class="btn-small" type="button" ${row?.storage_path ? "" : "disabled"}>üëÅÔ∏è Visualizar</button>
            <button class="btn-small danger" type="button" ${row?.storage_path ? "" : "disabled"}>‚úï Remover</button>
          </div>

          <div class="small" style="margin-top:8px; color:rgba(255,255,255,.55);">
            Ap√≥s enviar: status vira ‚ÄúEnviado‚Äù. Depois a equipe pode aprovar ou rejeitar.
          </div>
        `;

        const fileInput = card.querySelector('input[type="file"]');
        const [btnView, btnRemove] = card.querySelectorAll("button");

        fileInput.addEventListener("change", async (e)=>{
          const file = e.target.files?.[0];
          if (!file) return;
          await uploadDoc(dc.doc_type, file);
          e.target.value = "";
        });

        btnView.addEventListener("click", async ()=>{
          if (!row?.storage_path) return;
          await viewDoc(row.storage_path);
        });

        btnRemove.addEventListener("click", async ()=>{
          if (!row?.storage_path) return;
          const ok = confirm("Remover este arquivo? (Vai apagar do Storage)");
          if (!ok) return;
          await removeDoc(dc.doc_type, row.storage_path);
        });

        grid.appendChild(card);
      });
    }

    function safeExt(name=""){
      const p = name.toLowerCase().split(".");
      return p.length > 1 ? p[p.length-1] : "";
    }

    async function uploadDoc(docType, file){
      hideNotice();
      setLoading(true, "Enviando arquivo‚Ä¶");

      try{
        const ext = safeExt(file.name) || "bin";
        const storagePath = `${currentUser.id}/${docType}/${Date.now()}-${Math.random().toString(16).slice(2)}.${ext}`;

        const { error: upErr } = await sb.storage
          .from("documents")
          .upload(storagePath, file, { upsert:false });

        if (upErr){
          showNotice("err", "Falha no upload. Verifique policies do Storage bucket 'documents'.");
          setLoading(false);
          return;
        }

        const nowIso = new Date().toISOString();

        // tenta update primeiro (caso j√° exista linha)
        let updated = null;
        {
          const { data, error } = await sb
            .from("documents")
            .update({ storage_path: storagePath, status:"uploaded", uploaded_at: nowIso, approved_at: null })
            .eq("user_id", currentUser.id)
            .eq("doc_type", docType)
            .select("doc_type, status, storage_path, uploaded_at, approved_at")
            .maybeSingle();

          if (!error && data) updated = data;
        }

        // fallback: upsert (se update n√£o encontrou linha)
        if (!updated){
          const { data, error } = await sb
            .from("documents")
            .upsert({
              user_id: currentUser.id,
              doc_type: docType,
              storage_path: storagePath,
              status: "uploaded",
              uploaded_at: nowIso,
              approved_at: null
            }, { onConflict: "user_id,doc_type" })
            .select("doc_type, status, storage_path, uploaded_at, approved_at")
            .maybeSingle();

          if (error || !data){
            showNotice("err", "Upload ok, mas falhou ao salvar no banco. Verifique RLS/policies da tabela documents.");
            setLoading(false);
            return;
          }
          updated = data;
        }

        docsMap.set(docType, updated);
        renderDocuments();

        showNotice("ok", "Arquivo enviado com sucesso!");
      } catch {
        showNotice("err", "Falha inesperada ao enviar.");
      }

      setLoading(false);
    }

    async function viewDoc(storagePath){
      hideNotice();
      setLoading(true, "Abrindo arquivo‚Ä¶");

      const { data, error } = await sb.storage
        .from("documents")
        .createSignedUrl(storagePath, 60);

      if (error || !data?.signedUrl){
        showNotice("err", "N√£o consegui gerar link para visualizar.");
        setLoading(false);
        return;
      }

      window.open(data.signedUrl, "_blank", "noopener,noreferrer");
      setLoading(false);
    }

    async function removeDoc(docType, storagePath){
      hideNotice();
      setLoading(true, "Removendo arquivo‚Ä¶");

      const { error: rmErr } = await sb.storage.from("documents").remove([storagePath]);
      if (rmErr){
        showNotice("err", "N√£o consegui remover do Storage.");
        setLoading(false);
        return;
      }

      const { data, error } = await sb
        .from("documents")
        .update({ storage_path:null, status:"pending", uploaded_at:null, approved_at:null })
        .eq("user_id", currentUser.id)
        .eq("doc_type", docType)
        .select("doc_type, status, storage_path, uploaded_at, approved_at")
        .maybeSingle();

      if (error){
        showNotice("err", "Removido do Storage, mas falhou ao atualizar no banco.");
        setLoading(false);
        return;
      }

      if (data) docsMap.set(docType, data);
      else docsMap.delete(docType);

      renderDocuments();
      showNotice("ok", "Arquivo removido e status voltou para Pendente.");
      setLoading(false);
    }

    /* =========================
       10) Process UI (7 fases + passos)
    ========================= */
    function getPhaseStatus(i, cur){
      if (i < cur) return "done";
      if (i === cur) return "current";
      return "future";
    }

    function renderProcessPhases(cur){
      const grid = document.getElementById("phaseGrid");
      grid.innerHTML = "";

      phases.forEach(ph => {
        const st = getPhaseStatus(ph.id, cur);

        const card = document.createElement("div");
        card.className = `phase-card ${st === "current" ? "current" : (st === "done" ? "completed" : "")}`;

        // Se houver passos no DB para essa fase, usa eles; sen√£o fallback
        const dbRows = stepsByPhase.get(ph.id) || null;
        const hasDB = !!(dbRows && dbRows.length);

        let totalSteps = 0;
        let doneSteps = 0;
        let stepsHTML = "";

        if (hasDB){
          totalSteps = dbRows.length;
          doneSteps = dbRows.filter(r => r.status === "done").length;

          dbRows.forEach(r => {
            const checked = (r.status === "done");
            const label = checked ? "Conclu√≠do" : (r.status === "in_progress" ? "Em andamento" : "Pendente");
            stepsHTML += `
              <div class="step-item ${checked ? "checked" : ""}">
                <div class="step-check"></div>
                <div style="flex:1;">
                  <div class="step-text">${escapeHTML(r.step_title || ("Passo " + r.step_number))}</div>
                  ${r.step_description ? `<div class="step-sub">${escapeHTML(r.step_description)}</div>` : ""}
                  <div class="step-status-label">${label}</div>
                </div>
              </div>
            `;
          });
        } else {
          const list = fallbackSteps[ph.id] || [];
          totalSteps = list.length;

          // fallback: se fase anterior ao current -> todos done; se current -> metade "ilus√≥ria"
          if (ph.id < cur) doneSteps = totalSteps;
          else if (ph.id === cur) doneSteps = Math.max(0, Math.round(totalSteps * 0.5));
          else doneSteps = 0;

          list.forEach((txt, idx) => {
            const checked = (ph.id < cur) ? true : (ph.id === cur ? (idx < doneSteps) : false);
            stepsHTML += `
              <div class="step-item ${checked ? "checked" : ""}">
                <div class="step-check"></div>
                <div style="flex:1;">
                  <div class="step-text">${escapeHTML(txt)}</div>
                </div>
              </div>
            `;
          });
        }

        const pct = totalSteps ? Math.round((doneSteps / totalSteps) * 100) : 0;

        card.innerHTML = `
          <div class="phase-top">
            <div>
              <div class="phase-title">${ph.id}. ${ph.name}</div>
              <div class="phase-desc">${ph.desc}</div>
            </div>
            ${
              st === "done" ? `<span class="status-pill done">‚úì Conclu√≠da</span>` :
              st === "current" ? `<span class="status-pill current">Atual</span>` : ``
            }
          </div>

          <div class="progress-wrap">
            <div class="progress-bar">
              <div class="progress-fill" style="width:${pct}%;"></div>
            </div>
            <div class="progress-text">
              <span>${hasDB ? "Passos (banco)" : "Passos (padr√£o)"}</span>
              <span>${totalSteps ? `${doneSteps}/${totalSteps}` : "‚Äî"}</span>
            </div>
          </div>

          <div class="steps-list" id="steps-${ph.id}">
            ${stepsHTML}
          </div>
        `;

        grid.appendChild(card);
      });
    }

    /* =========================
       11) Inbox UI
    ========================= */
    function renderInbox(){
      const list = document.getElementById("inboxList");
      const empty = document.getElementById("inboxEmpty");
      const badge = document.getElementById("inboxBadge");
      const tabBadge = document.getElementById("supportBadge");

      if (!list || !empty || !badge || !tabBadge) return;

      list.innerHTML = "";

      const unread = inboxMsgs.filter(m => !m.is_read).length;

      if (unread > 0){
        badge.style.display = "inline-flex";
        badge.textContent = `${unread} nova(s)`;
        tabBadge.style.display = "inline-flex";
        tabBadge.textContent = unread;
      } else {
        badge.style.display = "none";
        tabBadge.style.display = "none";
      }

      if (!inboxMsgs.length){
        empty.style.display = "block";
        return;
      }

      empty.style.display = "none";

      inboxMsgs.forEach(m => {
        const box = document.createElement("div");
        box.className = "doc-card " + (m.is_read ? "" : "approved");
        box.style.cursor = "pointer";

        box.innerHTML = `
          <div class="doc-header">
            <div style="font-weight:950;">${escapeHTML(m.title)}</div>
            <div class="doc-status ${m.is_read ? "uploaded" : "pending"}">${m.is_read ? "Lida" : "Nova"}</div>
          </div>
          <div class="doc-info">${fmtDate(m.created_at)}</div>
          <div class="small" style="margin-top:8px; color:rgba(255,255,255,.85); white-space:pre-wrap;">${escapeHTML(m.message)}</div>
        `;

        box.addEventListener("click", async ()=>{
          if (m.is_read) return;

          const nowIso = new Date().toISOString();
          await sb.from("client_messages")
            .update({ is_read:true, read_at: nowIso })
            .eq("id", m.id);

          m.is_read = true;
          renderInbox();
        });

        list.appendChild(box);
      });
    }

    /* =========================
       Start
    ========================= */
    init();
  </script>
</body>
</html>
