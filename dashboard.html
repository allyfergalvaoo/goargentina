<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard | GoArgentina</title>
  <meta name="description" content="√Årea do cliente GoArgentina ‚Äî acompanhe seu processo de DNI por fases e passos, envie documentos e receba mensagens." />

  <style>
    *{ margin:0; padding:0; box-sizing:border-box; }

    :root{
      /* Mesma linguagem da landing (mais s√≥bria/discreta) */
      --blue-900:#0A0E27;
      --blue-800:#0F1B3D;
      --blue-700:#17306A;

      --text:#0D1220;
      --muted:#5B6475;

      --bg:#FFFFFF;
      --bg-soft:#F6F7FB;
      --surface:#FFFFFF;

      --sand:#F3E7C6;
      --sand-2:#F7F1DD;

      --line:rgba(13,18,32,.10);
      --line-strong:rgba(13,18,32,.16);

      --radius:16px;
      --shadow: 0 18px 50px rgba(13,18,32,.10);

      --success:#10B981;
      --warning:#F59E0B;
      --danger:#EF4444;

      --ring: rgba(23,48,106,.18);
      --ring-2: rgba(23,48,106,.28);
    }

    body{
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Inter, Roboto, Arial, sans-serif;
      background: var(--bg-soft);
      color: var(--text);
      line-height: 1.6;
    }

    a{ color: inherit; text-decoration:none; }
    button{ font-family: inherit; }

    .container{
      width:min(1120px, calc(100% - 40px));
      margin:0 auto;
    }

    /* Header */
    header{
      position: sticky;
      top: 0;
      z-index: 100;
      background: rgba(255,255,255,.92);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--line);
    }
    .nav{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 16px;
      padding: 14px 0;
      flex-wrap: wrap;
    }
    .brand{
      display:flex;
      align-items:center;
      gap: 12px;
      font-weight: 900;
      letter-spacing: .2px;
    }
    .mark{
      width: 38px; height: 38px;
      border-radius: 12px;
      background: var(--blue-700);
      display:flex;
      align-items:center;
      justify-content:center;
      color:#fff;
      font-weight: 950;
    }
    .brand small{
      display:block;
      font-weight: 700;
      color: var(--muted);
      margin-top: -2px;
      font-size: 12px;
      letter-spacing: 0;
    }

    .header-right{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
      justify-content:flex-end;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap: 10px;
      padding: 9px 12px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: #fff;
      box-shadow: 0 10px 28px rgba(13,18,32,.04);
    }
    .avatar{
      width: 34px; height: 34px;
      border-radius: 999px;
      background: var(--sand);
      border: 1px solid rgba(0,0,0,.08);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 950;
      color: var(--text);
    }
    .pill .name{
      display:flex;
      flex-direction:column;
      line-height: 1.1;
    }
    .pill .name b{
      font-size: 13px;
      letter-spacing: -0.1px;
    }
    .pill .name span{
      font-size: 12px;
      color: var(--muted);
      font-weight: 700;
      margin-top: 2px;
    }

    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap: 8px;
      padding: 12px 16px;
      border-radius: 999px;
      font-weight: 850;
      font-size: 14px;
      border: 1px solid var(--line);
      background: white;
      cursor: pointer;
      transition: all .15s ease;
      white-space: nowrap;
    }
    .btn:hover{
      transform: translateY(-1px);
      box-shadow: 0 10px 25px rgba(13,18,32,.08);
    }
    .btn-primary{
      background: var(--blue-700);
      color: #fff;
      border-color: rgba(255,255,255,.18);
    }
    .btn-primary:hover{ background: var(--blue-800); }
    .btn-ghost{ background: var(--bg-soft); }

    /* Page */
    .main{
      padding: 26px 0 56px;
    }

    .page-header{
      background: linear-gradient(180deg, #fff, rgba(246,247,251,.55));
      border: 1px solid var(--line);
      border-radius: calc(var(--radius) + 4px);
      padding: 18px;
      box-shadow: 0 12px 34px rgba(13,18,32,.06);
    }
    .page-title{
      font-size: clamp(24px, 3.6vw, 34px);
      line-height: 1.15;
      font-weight: 950;
      letter-spacing: -0.4px;
      margin-bottom: 6px;
    }
    .page-subtitle{
      color: var(--muted);
      font-weight: 650;
      font-size: 14px;
    }

    .notice{
      margin-top: 12px;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: #fff;
      font-size: 13px;
      font-weight: 700;
      color: rgba(13,18,32,.86);
      display:none;
    }
    .notice.show{ display:block; }
    .notice.ok{
      border-color: rgba(16,185,129,.30);
      background: rgba(16,185,129,.08);
      color: rgba(13,18,32,.92);
    }
    .notice.err{
      border-color: rgba(239,68,68,.28);
      background: rgba(239,68,68,.08);
      color: rgba(13,18,32,.92);
    }

    /* Tabs */
    .tabs{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      margin: 16px 0 18px;
    }
    .tab-btn{
      border: 1px solid var(--line);
      background: #fff;
      cursor:pointer;
      font-weight: 900;
      font-size: 13px;
      padding: 10px 14px;
      border-radius: 999px;
      transition: all .15s ease;
      display:inline-flex;
      align-items:center;
      gap: 10px;
      color: rgba(13,18,32,.86);
    }
    .tab-btn:hover{
      transform: translateY(-1px);
      box-shadow: 0 12px 28px rgba(13,18,32,.06);
    }
    .tab-btn.active{
      background: var(--blue-700);
      border-color: rgba(23,48,106,.35);
      color: #fff;
      box-shadow: 0 16px 40px rgba(23,48,106,.18);
    }
    .tab-badge{
      display:none;
      font-size: 11px;
      font-weight: 950;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(245,158,11,.14);
      border: 1px solid rgba(245,158,11,.28);
      color: rgba(145, 92, 18, .95);
    }
    .tab-btn.active .tab-badge{
      background: rgba(255,255,255,.16);
      border-color: rgba(255,255,255,.22);
      color:#fff;
    }

    .section{ display:none; }
    .section.active{ display:block; }

    /* Cards */
    .card{
      background: #fff;
      border: 1px solid var(--line);
      border-radius: calc(var(--radius) + 4px);
      padding: 18px;
      box-shadow: 0 12px 34px rgba(13,18,32,.06);
    }
    .card-title{
      font-size: 15px;
      font-weight: 950;
      letter-spacing: -0.2px;
      margin-bottom: 8px;
      display:flex;
      align-items:center;
      gap: 8px;
    }
    .small{
      font-size: 13px;
      font-weight: 650;
      color: var(--muted);
    }

    /* =========================
       TIMELINE (FIX DEFINITIVO)
       - A barra de progresso agora √© um "fill" ABSOLUTO com altura fixa (4px)
       - Ela fica DENTRO do mesmo wrapper (que rola junto) e SEMPRE atr√°s dos dots
    ========================= */
    .timeline-wrapper{
      background: #fff;
      border: 1px solid var(--line);
      border-radius: calc(var(--radius) + 4px);
      padding: 18px;
      box-shadow: 0 12px 34px rgba(13,18,32,.06);
      margin-bottom: 14px;
    }
    .timeline-title{
      font-size: 15px;
      font-weight: 950;
      letter-spacing: -0.2px;
      margin-bottom: 12px;
    }
    .timeline-container{
      overflow-x:auto;
      -webkit-overflow-scrolling: touch;
      padding: 10px 4px 6px;
    }
    .timeline-strip{
      position:relative;
      min-width: 520px;
      padding: 10px 6px; /* espa√ßo pra n√£o colar nos cantos */
    }
    .timeline-track{
      position:absolute;
      left: 6px;
      right: 6px;
      top: 50%;
      height: 4px;
      transform: translateY(-50%);
      background: rgba(13,18,32,.08);
      border-radius: 999px;
      z-index: 0;
      pointer-events:none;
    }
    .timeline-fill{
      position:absolute;
      left: 6px;
      top: 50%;
      height: 4px;
      transform: translateY(-50%);
      width: 0%;
      background: rgba(23,48,106,.85);
      border-radius: 999px;
      z-index: 0;            /* sempre atr√°s */
      pointer-events:none;
    }

    #timelinePhases{
      position:relative;
      z-index: 2;             /* c√≠rculos acima do track/fill */
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 10px;
      width: 100%;
    }
    .timeline-phase{
      position:relative;
      z-index: 2;
      display:flex;
      flex-direction:column;
      align-items:center;
      flex:1;
      cursor:default;
    }
    .timeline-dot{
      position:relative;
      z-index: 3;             /* redund√¢ncia m√°xima */
      width: 34px;
      height: 34px;
      border-radius: 999px;
      background: #fff;
      border: 2px solid rgba(13,18,32,.14);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 13px;
      font-weight: 950;
      color: rgba(13,18,32,.70);
      transition: all .2s ease;
      box-shadow: 0 10px 22px rgba(13,18,32,.05);
    }
    .timeline-phase.done .timeline-dot{
      border-color: rgba(16,185,129,.35);
      background: rgba(16,185,129,.08);
      color: rgba(10, 93, 64, .95);
      box-shadow: none;
    }
    .timeline-phase.current .timeline-dot{
      border-color: rgba(23,48,106,.35);
      background: rgba(23,48,106,.10);
      color: var(--blue-700);
      transform: scale(1.08);
      box-shadow: 0 18px 36px rgba(23,48,106,.16);
    }

    .timeline-current{
      margin-top: 10px;
      font-size: 13px;
      font-weight: 750;
      color: rgba(13,18,32,.78);
    }
    .timeline-current b{ color: var(--text); }

    /* Current phase card */
    .current-phase-card{
      background: #fff;
      border: 1px solid var(--line);
      border-radius: calc(var(--radius) + 4px);
      padding: 18px;
      box-shadow: 0 12px 34px rgba(13,18,32,.06);
    }
    .current-phase-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap: 14px;
      padding-bottom: 14px;
      border-bottom: 1px solid var(--line);
      margin-bottom: 14px;
      flex-wrap: wrap;
    }
    .current-phase-number{
      font-size: 12px;
      font-weight: 900;
      color: rgba(23,48,106,.90);
      letter-spacing: .2px;
      margin-bottom: 4px;
    }
    .current-phase-name{
      font-size: 20px;
      line-height: 1.25;
      font-weight: 950;
      letter-spacing: -0.25px;
      margin-bottom: 3px;
    }
    .current-phase-desc{
      font-size: 13px;
      font-weight: 650;
      color: var(--muted);
    }
    .current-phase-badge{
      padding: 8px 14px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 900;
      background: rgba(23,48,106,.08);
      border: 1px solid rgba(23,48,106,.18);
      color: rgba(23,48,106,.92);
      white-space: nowrap;
    }

    .steps-vertical{
      display:flex;
      flex-direction:column;
      gap: 10px;
    }
    .step-item{
      display:flex;
      gap: 12px;
      padding: 14px;
      border-radius: var(--radius);
      border: 1px solid var(--line);
      background: rgba(246,247,251,.55);
      transition: all .15s ease;
    }
    .step-item:hover{
      background: rgba(246,247,251,.85);
      border-color: var(--line-strong);
    }
    .step-check{
      width: 30px;
      height: 30px;
      border-radius: 999px;
      border: 2px solid rgba(13,18,32,.16);
      background: #fff;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 950;
      font-size: 13px;
      flex: 0 0 auto;
      color: rgba(13,18,32,.72);
      box-shadow: 0 10px 22px rgba(13,18,32,.05);
    }
    .step-content{ flex:1; }
    .step-number-label{
      font-size: 12px;
      font-weight: 900;
      color: rgba(13,18,32,.55);
      margin-bottom: 4px;
    }
    .step-text{
      font-size: 14px;
      font-weight: 900;
      letter-spacing: -0.1px;
      color: rgba(13,18,32,.90);
      line-height: 1.35;
    }
    .step-status-badge{
      margin-top: 8px;
      display:inline-flex;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 950;
      border: 1px solid var(--line);
      background: #fff;
      color: rgba(13,18,32,.72);
    }

    .step-item.done{
      background: rgba(16,185,129,.06);
      border-color: rgba(16,185,129,.20);
    }
    .step-item.done .step-check{
      border-color: rgba(16,185,129,.30);
      background: rgba(16,185,129,.10);
      color: rgba(10, 93, 64, .95);
      box-shadow: none;
    }
    .step-item.done .step-status-badge{
      border-color: rgba(16,185,129,.22);
      background: rgba(16,185,129,.10);
      color: rgba(10, 93, 64, .95);
    }

    .step-item.current{
      background: rgba(23,48,106,.06);
      border-color: rgba(23,48,106,.18);
    }
    .step-item.current .step-check{
      border-color: rgba(23,48,106,.28);
      background: rgba(23,48,106,.10);
      color: rgba(23,48,106,.95);
      box-shadow: 0 16px 34px rgba(23,48,106,.14);
    }
    .step-item.current .step-number-label{
      color: rgba(23,48,106,.92);
    }
    .step-item.current .step-status-badge{
      border-color: rgba(23,48,106,.22);
      background: rgba(23,48,106,.10);
      color: rgba(23,48,106,.92);
    }

    .step-item.pending{
      background: rgba(246,247,251,.55);
    }
    .step-item.pending .step-status-badge{
      border-color: rgba(245,158,11,.18);
      background: rgba(245,158,11,.10);
      color: rgba(145, 92, 18, .95);
    }

    /* Documents */
    .documents-grid{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 14px;
      margin-top: 14px;
    }
    .doc-card{
      background: #fff;
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: 0 12px 28px rgba(13,18,32,.05);
      transition: all .15s ease;
    }
    .doc-card:hover{
      transform: translateY(-1px);
      box-shadow: 0 18px 40px rgba(13,18,32,.08);
      border-color: rgba(23,48,106,.22);
    }
    .doc-card.approved{
      border-color: rgba(16,185,129,.22);
      background: linear-gradient(180deg, rgba(16,185,129,.07), #fff);
    }
    .doc-card.rejected{
      border-color: rgba(239,68,68,.22);
      background: linear-gradient(180deg, rgba(239,68,68,.06), #fff);
    }
    .doc-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap: 10px;
      margin-bottom: 10px;
    }
    .doc-icon{ font-size: 26px; }
    .doc-title{
      font-size: 13px;
      font-weight: 950;
      letter-spacing: -0.15px;
      margin-bottom: 6px;
    }
    .doc-info{
      font-size: 12px;
      font-weight: 650;
      color: var(--muted);
      margin-bottom: 10px;
    }
    .doc-status{
      font-size: 11px;
      font-weight: 950;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(246,247,251,.65);
      white-space: nowrap;
      color: rgba(13,18,32,.76);
    }
    .doc-status.pending{
      border-color: rgba(245,158,11,.20);
      background: rgba(245,158,11,.10);
      color: rgba(145, 92, 18, .95);
    }
    .doc-status.uploaded{
      border-color: rgba(16,185,129,.18);
      background: rgba(16,185,129,.08);
      color: rgba(10, 93, 64, .95);
    }
    .doc-status.approved{
      border-color: rgba(16,185,129,.22);
      background: rgba(16,185,129,.10);
      color: rgba(10, 93, 64, .95);
    }
    .doc-status.rejected{
      border-color: rgba(239,68,68,.20);
      background: rgba(239,68,68,.08);
      color: rgba(128, 24, 24, .95);
    }

    .input{
      width:100%;
      padding: 11px 12px;
      border-radius: 12px;
      background: rgba(246,247,251,.75);
      border: 1px solid var(--line);
      color: var(--text);
      font-weight: 650;
      font-size: 14px;
      transition: .15s ease;
    }
    .input:focus{
      outline:none;
      border-color: rgba(23,48,106,.32);
      box-shadow: 0 0 0 4px var(--ring);
      background: #fff;
    }

    .doc-actions{
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    .btn-small{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap: 8px;
      padding: 9px 10px;
      font-size: 12px;
      font-weight: 900;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: #fff;
      cursor:pointer;
      transition: all .15s ease;
    }
    .btn-small:hover{
      transform: translateY(-1px);
      box-shadow: 0 12px 26px rgba(13,18,32,.08);
      border-color: rgba(23,48,106,.22);
    }
    .btn-small.danger:hover{
      border-color: rgba(239,68,68,.22);
      background: rgba(239,68,68,.06);
    }
    .btn-small:disabled{
      opacity: .45;
      cursor:not-allowed;
      transform:none;
      box-shadow:none;
    }

    /* Inbox */
    .inbox-top{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 12px;
      flex-wrap: wrap;
    }
    #inboxBadge{
      display:none;
    }
    .empty-state{
      text-align:center;
      padding: 34px 12px;
      border: 1px dashed rgba(13,18,32,.18);
      border-radius: calc(var(--radius) + 4px);
      background: rgba(246,247,251,.65);
      margin-top: 14px;
    }
    .empty-icon{ font-size: 40px; opacity: .55; margin-bottom: 6px; }
    .empty-title{ font-size: 15px; font-weight: 950; letter-spacing: -0.15px; }
    .empty-text{ font-size: 13px; font-weight: 650; color: var(--muted); margin-top: 4px; }

    /* Loading overlay */
    .loading-overlay{
      position:fixed;
      inset:0;
      z-index:9999;
      background: rgba(246,247,251,.82);
      backdrop-filter: blur(10px);
      display:flex;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      gap: 10px;
    }
    .loading-overlay.hidden{ display:none; }
    .spinner{
      width: 42px; height: 42px;
      border-radius: 999px;
      border: 4px solid rgba(13,18,32,.12);
      border-top-color: rgba(23,48,106,.75);
      animation: spin .9s linear infinite;
    }
    @keyframes spin{ to{ transform: rotate(360deg);} }
    .loading-text{
      color: rgba(13,18,32,.78);
      font-weight: 900;
      font-size: 14px;
    }

    .footer-note{
      margin-top: 16px;
      font-size: 12px;
      font-weight: 650;
      color: rgba(13,18,32,.60);
    }

    @media (max-width: 520px){
      .btn{ width: 100%; }
      .header-right{ width:100%; }
      .pill{ width:100%; justify-content:flex-start; }
      .tabs{ gap: 8px; }
      .tab-btn{ width: 100%; justify-content:space-between; }
      .timeline-strip{ min-width: 520px; }
    }
  </style>
</head>

<body>
  <div class="loading-overlay" id="loading">
    <div class="spinner"></div>
    <div class="loading-text" id="loadingText">Carregando‚Ä¶</div>
  </div>

  <header>
    <div class="container">
      <div class="nav">
        <a class="brand" href="index.html" aria-label="GoArgentina">
          <div class="mark">GO</div>
          <div>
            GoArgentina
            <small>√Årea do cliente</small>
          </div>
        </a>

        <div class="header-right">
          <div class="pill" title="Sua conta">
            <div class="avatar" id="userAvatar">CL</div>
            <div class="name">
              <b id="userName">Cliente</b>
              <span>Acompanhamento do DNI</span>
            </div>
          </div>

          <button class="btn btn-ghost" id="logoutBtn">Sair</button>
        </div>
      </div>
    </div>
  </header>

  <main class="main">
    <div class="container">
      <div class="page-header">
        <h1 class="page-title">Seu painel</h1>
        <p class="page-subtitle">Acompanhe o progresso do seu DNI argentino por fases e passos.</p>
        <div class="notice" id="noticeBox"></div>
      </div>

      <div class="tabs" role="tablist" aria-label="Navega√ß√£o do painel">
        <button class="tab-btn active" data-tab="process" role="tab" aria-selected="true">üß≠ Processo</button>
        <button class="tab-btn" data-tab="docs" role="tab" aria-selected="false">üìÑ Documentos</button>
        <button class="tab-btn" data-tab="support" role="tab" aria-selected="false">
          üí¨ Suporte <span class="tab-badge" id="supportBadge">0</span>
        </button>
      </div>

      <!-- PROCESSO -->
      <section class="section active" id="tab-process">
        <div class="timeline-wrapper">
          <div class="timeline-title">Progresso do processo (7 fases)</div>

          <div class="timeline-container">
            <div class="timeline-strip">
              <div class="timeline-track"></div>
              <div class="timeline-fill" id="timelineProgress"></div>
              <div id="timelinePhases"></div>
            </div>
          </div>

          <div class="timeline-current" id="timelineCurrentName"></div>
        </div>

        <div class="current-phase-card" id="currentPhaseCard"></div>
      </section>

      <!-- DOCUMENTOS -->
      <section class="section" id="tab-docs">
        <div class="card">
          <div class="card-title">üìÑ Seus documentos</div>
          <div class="small">Envie os arquivos abaixo. Ap√≥s envio, nossa equipe revisa e aprova.</div>

          <div class="documents-grid" id="documentsGrid"></div>

          <div class="footer-note">
            Dica: prefira imagens n√≠tidas ou PDF. Se um documento for rejeitado, reenvie uma vers√£o melhor.
          </div>
        </div>
      </section>

      <!-- SUPORTE -->
      <section class="section" id="tab-support">
        <div class="card">
          <div class="inbox-top">
            <div>
              <div class="card-title" style="margin-bottom:4px;">üì® Caixa de entrada</div>
              <div class="small">Atualiza√ß√µes, dicas e solicita√ß√µes da nossa equipe.</div>
            </div>
            <div class="doc-status pending" id="inboxBadge"></div>
          </div>

          <div id="inboxList" style="margin-top:14px; display:flex; flex-direction:column; gap:10px;"></div>

          <div class="empty-state" id="inboxEmpty" style="display:none;">
            <div class="empty-icon">üì≠</div>
            <div class="empty-title">Sem mensagens</div>
            <div class="empty-text">Quando tivermos atualiza√ß√µes ou pedidos, elas aparecem aqui.</div>
          </div>

          <div class="empty-state" style="margin-top:16px;">
            <div class="empty-icon">üí¨</div>
            <div class="empty-title">Precisa falar com a gente?</div>
            <div class="empty-text">Chame no WhatsApp para atendimento humano.</div>
            <div style="margin-top:12px;">
              <a class="btn btn-primary" href="https://wa.me/5491159023706" target="_blank" rel="noopener noreferrer">
                üí¨ Abrir WhatsApp
              </a>
            </div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    /* =========================
       1) CONFIG (trocar s√≥ isso)
    ========================= */
    const SUPABASE_URL = "https://gqtkhimnfphllvtxkmjl.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdxdGtoaW1uZnBobGx2dHhrbWpsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkwNTg5MDAsImV4cCI6MjA4NDYzNDkwMH0.I7GOmBZsUtyxuPxzhcg3i5qaDuIFWBHHNtlZS65Qt_k";

    /* =========================
       2) CLIENT
    ========================= */
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { persistSession:true, autoRefreshToken:true, detectSessionInUrl:true }
    });

    /* =========================
       3) UI helpers
    ========================= */
    const loadingEl = document.getElementById("loading");
    const loadingText = document.getElementById("loadingText");
    const noticeBox = document.getElementById("noticeBox");

    function setLoading(show, text){
      if (text) loadingText.textContent = text;
      loadingEl.classList.toggle("hidden", !show);
    }
    function showNotice(type, msg){
      noticeBox.className = "notice show " + (type==="ok" ? "ok" : "err");
      noticeBox.textContent = msg;
    }
    function hideNotice(){
      noticeBox.className = "notice";
      noticeBox.textContent = "";
    }
    function fmtDate(dt){
      if (!dt) return "-";
      try { return new Date(dt).toLocaleString("pt-BR"); } catch { return "-"; }
    }
    function initialsFrom(nameOrEmail){
      const s = (nameOrEmail || "CL").trim();
      const parts = s.split(" ").filter(Boolean);
      if (parts.length >= 2) return (parts[0][0] + parts[1][0]).toUpperCase();
      return (s.slice(0,2)).toUpperCase();
    }
    function filenameFromPath(path){
      if (!path) return null;
      const p = path.split("/");
      return p[p.length-1] || path;
    }
    function escapeHTML(s=""){
      return s.replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[m]));
    }

    /* =========================
       5) Data & constants
    ========================= */
    const phases = [
      { id:1, name:"Documenta√ß√£o inicial", desc:"RG e foto" },
      { id:2, name:"Antecedentes criminais", desc:"Emiss√£o de certid√£o" },
      { id:3, name:"Domic√≠lio", desc:"Comprovante de endere√ßo" },
      { id:4, name:"Cadastro RADEX", desc:"Sistema migrat√≥rio" },
      { id:5, name:"Pagamento de taxas", desc:"Boletos" },
      { id:6, name:"Cita migrat√≥ria", desc:"Agendamento" },
      { id:7, name:"DNI emitido", desc:"Documento pronto" }
    ];

    const phaseSteps = {
      1: [
        "Envio dos documentos para nossa equipe",
        "Upload dos documentos na plataforma correspondente",
        "An√°lise dos documentos realizada por n√≥s"
      ],
      2: [
        "Emiss√£o do documento",
        "Upload do documento ap√≥s a emiss√£o"
      ],
      3: [
        "Agendamento do tr√¢mite",
        "Retirada presencial do documento",
        "Upload do documento obtido"
      ],
      4: [
        "Realiza√ß√£o do cadastro",
        "Cria√ß√£o dos boletos das taxas migrat√≥rias"
      ],
      5: [
        "Pagamento dos boletos",
        "Upload dos comprovantes"
      ],
      6: [
        "Agendamento da cita",
        "Comparecimento presencial"
      ],
      7: [
        "Aguardar a emiss√£o e chegada do DNI argentino"
      ],
    };

    const docsCatalog = [
      { doc_type:"rg", name:"RG (Identidade)", icon:"ü™™" },
      { doc_type:"antecedentes", name:"Antecedentes Criminais", icon:"üìã" },
      { doc_type:"foto", name:"Foto 3x4", icon:"üì∏" },
      { doc_type:"outros", name:"Outros Documentos", icon:"üìÅ" },
    ];

    let currentUser = null;
    let currentProfile = null;

    let currentPhase = 1;
    let currentStep = 1;
    let docsMap = new Map();
    let inboxMsgs = [];

    /* =========================
       6) Tabs
    ========================= */
    function setActiveTab(key){
      document.querySelectorAll(".tab-btn").forEach(b=>{
        const active = (b.dataset.tab === key);
        b.classList.toggle("active", active);
        b.setAttribute("aria-selected", active ? "true" : "false");
      });
      document.querySelectorAll(".section").forEach(s=>{
        s.classList.toggle("active", s.id === `tab-${key}`);
      });
    }

    function wireTabs(){
      document.querySelectorAll(".tab-btn").forEach(btn=>{
        btn.addEventListener("click", ()=> setActiveTab(btn.dataset.tab));
      });
    }

    /* =========================
       7) Auth guard + init
    ========================= */
    async function init(){
      setLoading(true, "Validando acesso‚Ä¶");

      const { data: sessionData } = await sb.auth.getSession();
      if (!sessionData?.session){
        window.location.href = "login.html";
        return;
      }

      const { data: userData, error: userErr } = await sb.auth.getUser();
      if (userErr || !userData?.user){
        window.location.href = "login.html";
        return;
      }
      currentUser = userData.user;

      const { data: profile, error: profErr } = await sb
        .from("profiles")
        .select("id, email, full_name, role, created_at")
        .eq("id", currentUser.id)
        .single();

      if (profErr || !profile){
        showNotice("err", "N√£o consegui carregar seu perfil. Recarregue a p√°gina.");
        setLoading(false);
        return;
      }
      currentProfile = profile;

      if (currentProfile.role === "admin"){
        window.location.href = "admin.html";
        return;
      }

      const display = (currentProfile.full_name || currentProfile.email || "Cliente");
      document.getElementById("userName").textContent = display;
      document.getElementById("userAvatar").textContent = initialsFrom(display);

      wireTabs();
      wireEvents();

      await loadAll();
      setLoading(false);
    }

    function wireEvents(){
      document.getElementById("logoutBtn").addEventListener("click", logout);

      sb.auth.onAuthStateChange((event) => {
        if (event === "SIGNED_OUT"){
          window.location.href = "login.html";
        }
      });
    }

    async function logout(){
      setLoading(true, "Saindo‚Ä¶");
      await sb.auth.signOut();
      window.location.href = "login.html";
    }

    /* =========================
       8) Load data
    ========================= */
    async function loadAll(){
      hideNotice();
      setLoading(true, "Carregando dados‚Ä¶");

      await Promise.all([
        loadProcess(),
        loadDocuments(),
        loadInboxMessages()
      ]);

      renderTimeline();
      renderCurrentPhaseCard();
      renderDocuments();
      renderInbox();

      setLoading(false);
    }

    async function loadProcess(){
      const { data, error } = await sb
        .from("dni_process")
        .select("user_id, current_phase, current_step, updated_at")
        .eq("user_id", currentUser.id)
        .maybeSingle();

      if (error){
        currentPhase = 1;
        currentStep = 1;
        return;
      }

      if (!data){
        const nowIso = new Date().toISOString();
        const { data: created } = await sb
          .from("dni_process")
          .upsert({
            user_id: currentUser.id,
            current_phase: 1,
            current_step: 1,
            updated_at: nowIso
          }, { onConflict:"user_id" })
          .select("current_phase, current_step")
          .maybeSingle();
        currentPhase = created?.current_phase || 1;
        currentStep = created?.current_step || 1;
      } else {
        currentPhase = data.current_phase || 1;
        currentStep = data.current_step || 1;
      }

      currentPhase = Math.min(7, Math.max(1, Number(currentPhase) || 1));
      const maxSteps = (phaseSteps[currentPhase] || []).length || 1;
      currentStep = Math.min(maxSteps, Math.max(1, Number(currentStep) || 1));
    }

    async function loadDocuments(){
      docsMap = new Map();

      const { data, error } = await sb
        .from("documents")
        .select("user_id, doc_type, status, storage_path, uploaded_at, approved_at")
        .eq("user_id", currentUser.id);

      if (error){
        showNotice("err", "Erro ao carregar documentos. Confira as pol√≠ticas (RLS) da tabela documents.");
        return;
      }

      (data || []).forEach(d => docsMap.set(d.doc_type, d));
    }

    async function loadInboxMessages(){
      inboxMsgs = [];

      const { data, error } = await sb
        .from("client_messages")
        .select("id, title, message, message_type, is_read, created_at")
        .eq("user_id", currentUser.id)
        .order("created_at", { ascending:false })
        .limit(30);

      if (error) return;
      inboxMsgs = data || [];
    }

    /* =========================
       9) Timeline (7 fases)
    ========================= */
    function renderTimeline(){
      const container = document.getElementById("timelinePhases");
      container.innerHTML = "";

      const progressBar = document.getElementById("timelineProgress");

      const totalPhases = 7;
      const progressPct = ((currentPhase - 1) / (totalPhases - 1)) * 100;
      progressBar.style.width = Math.min(100, Math.max(0, progressPct)) + "%";

      phases.forEach(ph => {
        const isDone = ph.id < currentPhase;
        const isCurrent = ph.id === currentPhase;

        const div = document.createElement("div");
        div.className = `timeline-phase ${isDone ? "done" : (isCurrent ? "current" : "")}`;
        div.innerHTML = `<div class="timeline-dot" aria-label="Fase ${ph.id}">${ph.id}</div>`;
        container.appendChild(div);
      });

      const currentLabel = document.getElementById("timelineCurrentName");
      const phaseInfo = phases.find(p => p.id === currentPhase);
      if (currentLabel && phaseInfo){
        currentLabel.innerHTML = `<b>Fase ${currentPhase}:</b> ${phaseInfo.name}`;
      }
    }

    /* =========================
       10) Current phase card
    ========================= */
    function renderCurrentPhaseCard(){
      const card = document.getElementById("currentPhaseCard");

      const phaseInfo = phases.find(p => p.id === currentPhase);
      if (!phaseInfo){
        card.innerHTML = '<div class="small" style="text-align:center; padding:18px;">Fase n√£o encontrada</div>';
        return;
      }

      const steps = phaseSteps[currentPhase] || [];

      let stepsHTML = "";
      steps.forEach((stepText, idx) => {
        const stepNum = idx + 1;
        const isDone = stepNum < currentStep;
        const isCurrent = stepNum === currentStep;

        let itemClass = "";
        let checkIcon = "";
        let statusText = "";

        if (isDone){
          itemClass = "done";
          checkIcon = "‚úì";
          statusText = "Conclu√≠do";
        } else if (isCurrent){
          itemClass = "current";
          checkIcon = "‚óè";
          statusText = "Passo atual";
        } else {
          itemClass = "pending";
          checkIcon = stepNum;
          statusText = "Pendente";
        }

        stepsHTML += `
          <div class="step-item ${itemClass}">
            <div class="step-check">${checkIcon}</div>
            <div class="step-content">
              <div class="step-number-label">Passo ${stepNum}</div>
              <div class="step-text">${stepText}</div>
              <div class="step-status-badge ${itemClass}">${statusText}</div>
            </div>
          </div>
        `;
      });

      card.innerHTML = `
        <div class="current-phase-header">
          <div>
            <div class="current-phase-number">Fase ${currentPhase} de 7</div>
            <div class="current-phase-name">${phaseInfo.name}</div>
            <div class="current-phase-desc">${phaseInfo.desc}</div>
          </div>
          <div class="current-phase-badge">Em andamento</div>
        </div>

        <div class="steps-vertical">
          ${stepsHTML || '<div class="small" style="text-align:center; padding:18px;">Nenhum passo definido para esta fase</div>'}
        </div>
      `;
    }

    /* =========================
       11) Documents UI
    ========================= */
    function docStatusBadge(status){
      if (status === "approved") return { cls:"approved", txt:"‚úÖ Aprovado" };
      if (status === "rejected") return { cls:"rejected", txt:"‚ö†Ô∏è Rejeitado" };
      if (status === "uploaded") return { cls:"uploaded", txt:"‚úì Enviado" };
      return { cls:"pending", txt:"‚è≥ Pendente" };
    }

    function renderDocuments(){
      const grid = document.getElementById("documentsGrid");
      grid.innerHTML = "";

      docsCatalog.forEach(dc => {
        const row = docsMap.get(dc.doc_type) || null;
        const status = row?.status || "pending";
        const badge = docStatusBadge(status);

        const fileInfo = row?.storage_path
          ? `Arquivo: ${filenameFromPath(row.storage_path)}`
          : "Sem envio ainda";

        const timeInfo = row?.uploaded_at ? `Enviado em ${fmtDate(row.uploaded_at)}` : "";

        const card = document.createElement("div");
        card.className = `doc-card ${status === "approved" ? "approved" : (status === "rejected" ? "rejected" : "")}`;

        card.innerHTML = `
          <div class="doc-header">
            <div class="doc-icon">${dc.icon}</div>
            <div class="doc-status ${badge.cls}">${badge.txt}</div>
          </div>

          <div class="doc-title">${dc.name}</div>
          <div class="doc-info">${fileInfo}${timeInfo ? "<br>"+timeInfo : ""}</div>

          <input type="file" class="input" style="padding:10px 12px;" accept="image/*,application/pdf" />

          <div class="doc-actions">
            <button class="btn-small" type="button" ${row?.storage_path ? "" : "disabled"}>üëÅÔ∏è Visualizar</button>
            <button class="btn-small danger" type="button" ${row?.storage_path ? "" : "disabled"}>‚úï Remover</button>
          </div>

          <div class="footer-note" style="margin-top:10px;">
            Ap√≥s enviar: status vira ‚ÄúEnviado‚Äù. Depois a equipe pode aprovar ou rejeitar.
          </div>
        `;

        const fileInput = card.querySelector('input[type="file"]');
        const [btnView, btnRemove] = card.querySelectorAll("button");

        fileInput.addEventListener("change", async (e)=>{
          const file = e.target.files?.[0];
          if (!file) return;
          await uploadDoc(dc.doc_type, file);
          e.target.value = "";
        });

        btnView.addEventListener("click", async ()=>{
          if (!row?.storage_path) return;
          await viewDoc(row.storage_path);
        });

        btnRemove.addEventListener("click", async ()=>{
          if (!row?.storage_path) return;
          const ok = confirm("Remover este arquivo? (Vai apagar do Storage)");
          if (!ok) return;
          await removeDoc(dc.doc_type, row.storage_path);
        });

        grid.appendChild(card);
      });
    }

    function safeExt(name=""){
      const p = name.toLowerCase().split(".");
      return p.length > 1 ? p[p.length-1] : "";
    }

    async function uploadDoc(docType, file){
      hideNotice();
      setLoading(true, "Enviando arquivo‚Ä¶");

      try{
        const ext = safeExt(file.name) || "bin";
        const storagePath = `${currentUser.id}/${docType}/${Date.now()}-${Math.random().toString(16).slice(2)}.${ext}`;

        const { error: upErr } = await sb.storage
          .from("documents")
          .upload(storagePath, file, { upsert:false });

        if (upErr){
          showNotice("err", "Falha no upload. Verifique policies do Storage bucket 'documents'.");
          setLoading(false);
          return;
        }

        const nowIso = new Date().toISOString();

        let updated = null;
        {
          const { data, error } = await sb
            .from("documents")
            .update({ storage_path: storagePath, status:"uploaded", uploaded_at: nowIso, approved_at: null })
            .eq("user_id", currentUser.id)
            .eq("doc_type", docType)
            .select("doc_type, status, storage_path, uploaded_at, approved_at")
            .maybeSingle();

          if (!error && data) updated = data;
        }

        if (!updated){
          const { data, error } = await sb
            .from("documents")
            .upsert({
              user_id: currentUser.id,
              doc_type: docType,
              storage_path: storagePath,
              status: "uploaded",
              uploaded_at: nowIso,
              approved_at: null
            }, { onConflict: "user_id,doc_type" })
            .select("doc_type, status, storage_path, uploaded_at, approved_at")
            .maybeSingle();

          if (error || !data){
            showNotice("err", "Upload ok, mas falhou ao salvar no banco. Verifique RLS/policies da tabela documents.");
            setLoading(false);
            return;
          }
          updated = data;
        }

        docsMap.set(docType, updated);
        renderDocuments();
        showNotice("ok", "Arquivo enviado com sucesso!");
      } catch {
        showNotice("err", "Falha inesperada ao enviar.");
      }

      setLoading(false);
    }

    async function viewDoc(storagePath){
      hideNotice();
      setLoading(true, "Abrindo arquivo‚Ä¶");

      const { data, error } = await sb.storage
        .from("documents")
        .createSignedUrl(storagePath, 60);

      if (error || !data?.signedUrl){
        showNotice("err", "N√£o consegui gerar link para visualizar.");
        setLoading(false);
        return;
      }

      window.open(data.signedUrl, "_blank", "noopener,noreferrer");
      setLoading(false);
    }

    async function removeDoc(docType, storagePath){
      hideNotice();
      setLoading(true, "Removendo arquivo‚Ä¶");

      const { error: rmErr } = await sb.storage.from("documents").remove([storagePath]);
      if (rmErr){
        showNotice("err", "N√£o consegui remover do Storage.");
        setLoading(false);
        return;
      }

      const { data, error } = await sb
        .from("documents")
        .update({ storage_path:null, status:"pending", uploaded_at:null, approved_at:null })
        .eq("user_id", currentUser.id)
        .eq("doc_type", docType)
        .select("doc_type, status, storage_path, uploaded_at, approved_at")
        .maybeSingle();

      if (error){
        showNotice("err", "Removido do Storage, mas falhou ao atualizar no banco.");
        setLoading(false);
        return;
      }

      if (data) docsMap.set(docType, data);
      else docsMap.delete(docType);

      renderDocuments();
      showNotice("ok", "Arquivo removido e status voltou para Pendente.");
      setLoading(false);
    }

    /* =========================
       12) Inbox UI
    ========================= */
    function renderInbox(){
      const list = document.getElementById("inboxList");
      const empty = document.getElementById("inboxEmpty");
      const badge = document.getElementById("inboxBadge");
      const tabBadge = document.getElementById("supportBadge");

      if (!list || !empty || !badge || !tabBadge) return;

      list.innerHTML = "";

      const unread = inboxMsgs.filter(m => !m.is_read).length;

      if (unread > 0){
        badge.style.display = "inline-flex";
        badge.textContent = `${unread} nova(s)`;
        tabBadge.style.display = "inline-flex";
        tabBadge.textContent = unread;
      } else {
        badge.style.display = "none";
        tabBadge.style.display = "none";
      }

      if (!inboxMsgs.length){
        empty.style.display = "block";
        return;
      }

      empty.style.display = "none";

      inboxMsgs.forEach(m => {
        const box = document.createElement("div");
        box.className = "doc-card " + (m.is_read ? "" : "approved");
        box.style.cursor = "pointer";

        box.innerHTML = `
          <div class="doc-header">
            <div style="font-weight:950; letter-spacing:-0.15px;">${escapeHTML(m.title)}</div>
            <div class="doc-status ${m.is_read ? "uploaded" : "pending"}">${m.is_read ? "Lida" : "Nova"}</div>
          </div>
          <div class="doc-info">${fmtDate(m.created_at)}</div>
          <div class="small" style="margin-top:8px; color: rgba(13,18,32,.86); white-space:pre-wrap;">${escapeHTML(m.message)}</div>
        `;

        box.addEventListener("click", async ()=>{
          if (m.is_read) return;

          const nowIso = new Date().toISOString();
          await sb.from("client_messages")
            .update({ is_read:true, read_at: nowIso })
            .eq("id", m.id);

          m.is_read = true;
          renderInbox();
        });

        list.appendChild(box);
      });
    }

    /* =========================
       Start
    ========================= */
    init();
  </script>
</body>
</html>
